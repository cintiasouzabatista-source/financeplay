<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Minhas Finan√ßas</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --card:#0b1428;
      --card2:#0b1730;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(148,163,184,.18);
      --side:#0b1220;
      --sideHover:rgba(255,255,255,.06);
      --sideActive:rgba(148,163,184,.16);
      --primary:#6366f1;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#fbbf24;
      --radius:14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      margin:0;
      color:var(--text);
    }

    .layout{display:flex; min-height:100vh;}

    .sidebar {
      width:260px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 30%),
                  var(--side);
      color:var(--text);
      padding:18px 14px;
      position:fixed;
      inset:0 auto 0 0;
      overflow:auto;
      border-right:1px solid var(--line);
      z-index:50;
    }
    .brand{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; padding:6px 8px 12px 8px;}
    .brand h2 {font-size:18px; margin:0; letter-spacing:.2px; line-height:1.1;}
    .version {
      font-size:12px; opacity:0.8;
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      white-space:nowrap;
    }

    .nav{margin-top:8px; display:flex; flex-direction:column; gap:6px; padding:0 6px;}
    .nav a{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      color:var(--text); text-decoration:none;
      padding:10px 12px;
      border-radius:12px;
      transition:.15s ease;
      border:1px solid transparent;
    }
    .nav a:hover{background:var(--sideHover);}
    .nav a.active{background:var(--sideActive); border-color: rgba(148,163,184,.22); box-shadow: 0 1px 0 rgba(255,255,255,.05) inset;}
    .nav .left{display:flex; align-items:center; gap:10px;}
    .nav .icon{width:22px; display:inline-flex; align-items:center; justify-content:center; font-size:16px; opacity:.95;}
    .nav .text{display:inline;}

    .spacer{height:10px;}

    .main {
      margin-left:260px;
      padding:22px 22px 28px 22px;
      width:100%;
    }

    .topbar{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:14px;}
    .title{font-size:20px; margin:0;}
    .subtitle{font-size:13px; color:var(--muted); margin:6px 0 0 0; max-width:820px; line-height:1.35;}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      font-size:12px;
      white-space:nowrap;
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 24%),
                  var(--card);
      padding:18px;
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      border:1px solid var(--line);
      margin-bottom:14px;
    }
    .card h3{margin:0 0 10px 0; font-size:14px; letter-spacing:.2px;}
    .grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:12px;}
    .metric{
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 26%),
                  var(--card2);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      min-height:112px;
    }
    .metric .label{font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center;}
    .metric .value{font-size:22px; margin:10px 0 0 0; font-weight:800;}
    .metric .hint{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.35;}

    .row{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px solid var(--line);}
    .row:last-child{border-bottom:none}
    .row .label{font-weight:800}
    .row .desc{font-size:12px; color:var(--muted); margin-top:3px; line-height:1.3}

    button {
      padding:10px 14px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
    }
    .btn-primary {
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,0)),
                  var(--primary);
      color:white;
      border:1px solid rgba(255,255,255,.10);
    }
    .btn-danger {
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,0)),
                  var(--danger);
      color:white;
      border:1px solid rgba(255,255,255,.10);
    }
    .btn-muted {
      background: rgba(255,255,255,.06);
      color:var(--text);
      border:1px solid var(--line);
    }

    input, select, textarea{
      width:100%;
      max-width:360px;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(2,6,23,.55);
      color:var(--text);
      outline:none;
    }
    textarea{max-width:100%; min-height:80px; resize:vertical;}
    input::placeholder{color: rgba(148,163,184,.7);}
    input:focus, select:focus, textarea:focus{border-color: rgba(99,102,241,.75); box-shadow: 0 0 0 3px rgba(99,102,241,.18);}

    .note{font-size:13px; color:var(--muted); line-height:1.35;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .badge-ok{color: var(--ok); font-weight:800;}
    .badge-warn{color: var(--warn); font-weight:800;}
    .badge-danger{color: var(--danger); font-weight:800;}

    .section-divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(148,163,184,.32), transparent);
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      margin:14px 0;
      border-radius:999px;
    }

    /* Sidebar minimizada (PC) */
    .sidebar.collapsed{width:86px; padding:14px 10px;}
    .sidebar.collapsed #brandTitle{display:none;}
    .sidebar.collapsed .nav a{padding:10px 10px; justify-content:center;}
    .sidebar.collapsed .nav a .left{gap:0;}
    .sidebar.collapsed .version{display:none;}
    .sidebar.collapsed .nav .text{display:none;}
    .sidebar.collapsed + .main{margin-left:86px;}
    .sidebar.collapsed .nav a{position:relative;}
    .sidebar.collapsed .nav a:hover::after{
      content: attr(data-label);
      position:absolute;
      left:92px;
      top:50%;
      transform: translateY(-50%);
      background: rgba(15,23,42,.96);
      color:#fff;
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      font-weight:700;
      white-space:nowrap;
      border:1px solid rgba(148,163,184,.22);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      z-index:10000;
    }

    /* Mobile drawer */
    .drawer-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      z-index:9000;
    }
    .drawer-overlay.active{ opacity:1; pointer-events:auto; }
    .mobile-topbar{display:none;}

    @media (max-width: 980px){
      .mobile-topbar{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        padding:12px 12px;
        border-bottom:1px solid rgba(148,163,184,.18);
        background: rgba(2,6,23,.62);
        position:sticky;
        top:0;
        z-index:8000;
        backdrop-filter: blur(8px);
      }
      .mobile-topbar .mt-left{display:flex; align-items:center; gap:10px;}
      .mobile-topbar .mt-title{font-weight:900; letter-spacing:.2px;}
      .sidebar{
        position:fixed;
        top:0; left:0; bottom:0;
        width:260px;
        transform: translateX(-110%);
        transition: transform .22s ease;
        z-index:13000;
      }
      .sidebar.open{ transform: translateX(0); }
      body.drawer-open{ overflow:hidden; }
      .main{ margin-left:0 !important; padding:16px; }
      .sidebar.collapsed .nav .text{ display:inline !important; }
      .sidebar.collapsed .nav a:hover::after{ display:none !important; }
    }

    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; border:1px solid var(--line);}
    th, td{padding:10px 10px; border-bottom:1px solid var(--line); text-align:left; font-size:13px;}
    th{color:var(--muted); font-weight:800; background: rgba(255,255,255,.03);}
    tr:last-child td{border-bottom:none;}

    /* Modal */
    .modal-overlay{
      position:fixed; inset:0;
      display:flex; align-items:flex-start; justify-content:center;
      padding:16px; z-index:9999;
      background: rgba(0,0,0,.40);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
    }
    .modal-overlay.active{opacity:1; pointer-events:auto;}
    .modal-card{
      width:min(720px, 100%);
      background: rgba(255,255,255,.98);
      color:#0f172a;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modal-head{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; background: rgba(99,102,241,.10); border-bottom:1px solid rgba(15,23,42,.08);}
    .modal-title{font-weight:900; font-size:14px;}
    .modal-body{padding:12px 14px;}
    .modal-item{display:flex; justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px dashed rgba(15,23,42,.12);}
    .modal-item:last-child{border-bottom:none;}
    .modal-actions{display:flex; gap:10px; justify-content:flex-end; padding:12px 14px; border-top:1px solid rgba(15,23,42,.08); background: rgba(15,23,42,.03); flex-wrap:wrap;}
    .modal-actions .btn-muted{ background: rgba(15,23,42,.06); color:#0f172a; border:1px solid rgba(15,23,42,.10);}
    .modal-actions .btn-primary{ border:1px solid rgba(99,102,241,.25);}
  </style>

  <script>
    window.__BUILD_ID__ = "v2026.02.21-26T-01";

    function uid(prefix="id"){ return prefix + "_" + Date.now() + "_" + Math.random().toString(16).slice(2); }
    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function fmtBRL(v){ if(v===null||v===undefined||v==="") return "‚Äî"; const num=Number(v); if(Number.isNaN(num)) return "‚Äî"; return "R$ " + num.toFixed(2).replace(".",","); }
    function parseBRL(x){ if(x===null||x===undefined) return null; const s=String(x).trim(); if(!s) return null; const norm=s.replace(/\./g,'').replace(',','.'); const v=Number(norm); return Number.isNaN(v)?null:v; }
    function toISODate(d){ const dt=(d instanceof Date)?d:new Date(d); return dt.getFullYear()+"-"+pad2(dt.getMonth()+1)+"-"+pad2(dt.getDate()); }
    function fromISODate(s){ if(!s) return null; const parts=String(s).split("-").map(Number); if(parts.length!==3) return null; const [y,m,d]=parts; if(!y||!m||!d) return null; return new Date(y,m-1,d,12,0,0,0); }
    function formatBRDateFromISO(s){ const dt=fromISODate(s); if(!dt) return "‚Äî"; return pad2(dt.getDate())+"/"+pad2(dt.getMonth()+1)+"/"+dt.getFullYear(); }
    function isSameMonth(iso,y,m){ const dt=fromISODate(iso); return !!dt && dt.getFullYear()===y && dt.getMonth()===m; }

    const LS_KEYS={accounts:"mf_accounts_v1",categories:"mf_categories_v1",tx:"mf_transactions_v1",cards:"mf_cards_v1",cardTx:"mf_card_tx_v1",ui:"mf_ui_v1",skipAlerts:"mf_skip_alerts_until"};

    function loadJSON(key,fallback){ try{const raw=localStorage.getItem(key); if(!raw) return fallback; const val=JSON.parse(raw); return (val===null||val===undefined)?fallback:val;}catch(e){return fallback;} }
    function saveJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

    function loadAccounts(){ return loadJSON(LS_KEYS.accounts, []); }
    function saveAccounts(a){ saveJSON(LS_KEYS.accounts, a||[]); }
    function loadCategories(){ return loadJSON(LS_KEYS.categories, []); }
    function saveCategories(c){ saveJSON(LS_KEYS.categories, c||[]); }
    function loadTransactions(){ return loadJSON(LS_KEYS.tx, []); }
    function saveTransactions(t){ saveJSON(LS_KEYS.tx, t||[]); }
    function loadCards(){ return loadJSON(LS_KEYS.cards, []); }
    function saveCards(c){ saveJSON(LS_KEYS.cards, c||[]); }
    function loadCardTx(){ return loadJSON(LS_KEYS.cardTx, []); }
    function saveCardTx(t){ saveJSON(LS_KEYS.cardTx, t||[]); }

    function getUI(){ return loadJSON(LS_KEYS.ui, {sidebarCollapsed:false, monthOffset:0}); }
    function setUI(patch){ const cur=getUI(); saveJSON(LS_KEYS.ui, {...cur, ...(patch||{})}); }

    function ensureSeed(){ 
      const has=loadJSON("mf_seed_done", false);
      if(has) return;
      const acc=[
        {id:uid("acc"), name:"Mercado Pago", type:"banco", enabled:true},
        {id:uid("acc"), name:"Nubank", type:"banco", enabled:true},
        {id:uid("acc"), name:"Dinheiro", type:"dinheiro", enabled:true},
        {id:uid("acc"), name:"VR (Vale Refei√ß√£o)", type:"beneficio", enabled:true},
        {id:uid("acc"), name:"VA (Vale Alimenta√ß√£o)", type:"beneficio", enabled:true},
        {id:uid("acc"), name:"Aux√≠lio Combust√≠vel", type:"beneficio", enabled:true},
      ];
      saveAccounts(acc);
      const cats=[
        {id:uid("cat"), type:"saida", name:"Alimenta√ß√£o"},
        {id:uid("cat"), type:"saida", name:"Supermercado"},
        {id:uid("cat"), type:"saida", name:"Transporte"},
        {id:uid("cat"), type:"saida", name:"Carro"},
        {id:uid("cat"), type:"saida", name:"Moradia"},
        {id:uid("cat"), type:"saida", name:"Assinaturas"},
        {id:uid("cat"), type:"saida", name:"Sa√∫de"},
        {id:uid("cat"), type:"saida", name:"Educa√ß√£o"},
        {id:uid("cat"), type:"entrada", name:"Sal√°rio"},
        {id:uid("cat"), type:"entrada", name:"Benef√≠cios"},
        {id:uid("cat"), type:"entrada", name:"Reembolso"},
        {id:uid("cat"), type:"entrada", name:"Outros"},
      ];
      saveCategories(cats);
      const cards=[
        {id:uid("card"), name:"Mercado Pago (*2264)", dueDay:10, closeDay:3, enabled:true},
        {id:uid("card"), name:"Nubank", dueDay:15, closeDay:8, enabled:true},
      ];
      saveCards(cards);
      saveJSON("mf_seed_done", true);
    }

    function exportData(){ 
      const payload={exportedAt:Date.now(), version:window.__BUILD_ID__, accounts:loadAccounts(), categories:loadCategories(), transactions:loadTransactions(), cards:loadCards(), cardTx:loadCardTx(), ui:getUI()};
      const blob=new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="minhas-financas-backup.json";
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function importData(){ 
      const inp=document.createElement("input");
      inp.type="file"; inp.accept="application/json";
      inp.onchange=()=>{
        const file=inp.files && inp.files[0];
        if(!file) return;
        const reader=new FileReader();
        reader.onload=()=>{
          try{
            const data=JSON.parse(String(reader.result||""));
            if(data.accounts) saveAccounts(data.accounts);
            if(data.categories) saveCategories(data.categories);
            if(data.transactions) saveTransactions(data.transactions);
            if(data.cards) saveCards(data.cards);
            if(data.cardTx) saveCardTx(data.cardTx);
            if(data.ui) saveJSON(LS_KEYS.ui, data.ui);
            alert("Importado com sucesso!");
            location.reload();
          }catch(e){ alert("Falha ao importar: " + (e?.message||e)); }
        };
        reader.readAsText(file);
      };
      inp.click();
    }
    function clearAllData(){ const typed=prompt('A√ß√£o irrevers√≠vel. Digite "LIMPAR" para confirmar:'); if(typed!=="LIMPAR") return alert("Cancelado."); localStorage.clear(); alert("Dados apagados."); location.reload(); }
    function clearAppCache(){ 
      try{ 
        if('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(regs=>regs.forEach(r=>r.unregister()));
        if('caches' in window) caches.keys().then(names=>names.forEach(n=>caches.delete(n)));
      }catch(e){}
      alert("Cache limpo. O app ser√° recarregado.");
      const url=new URL(location.href); url.searchParams.set("v", window.__BUILD_ID__ + "-" + Date.now()); location.href=url.toString();
    }

    function getAccountById(id){ return loadAccounts().find(a=>a.id===id) || null; }
    function getCategoryById(id){ return loadCategories().find(c=>c.id===id) || null; }

    function calcBalances(){ 
      const acc=loadAccounts();
      const tx=loadTransactions().filter(t=>t && t.status!=="excluida");
      const map=new Map();
      acc.forEach(a=>map.set(a.id, {delta:0}));
      for(const t of tx){
        if(!t || !t.accountId) continue;
        const amt=Number(t.amount||0); if(Number.isNaN(amt)) continue;
        if(t.kind==="entrada"){ if(map.has(t.accountId)) map.get(t.accountId).delta += amt; }
        else if(t.kind==="saida"){ if(map.has(t.accountId)) map.get(t.accountId).delta -= amt; }
        else if(t.kind==="transfer"){ 
          if(map.has(t.accountId)) map.get(t.accountId).delta -= amt;
          if(t.toAccountId && map.has(t.toAccountId)) map.get(t.toAccountId).delta += amt;
        }
      }
      return acc.map(a=>{
        const base=(a.initialBalance===null||a.initialBalance===undefined)?0:Number(a.initialBalance||0);
        const s=map.get(a.id)||{delta:0};
        return {...a, balance: base + (s.delta||0)};
      });
    }

    function calcMonthTotals(y,m){ 
      const tx=loadTransactions().filter(t=>t && t.status!=="excluida");
      let inc=0,out=0,tr=0;
      for(const t of tx){
        if(!t.dateISO) continue;
        if(!isSameMonth(t.dateISO,y,m)) continue;
        const amt=Number(t.amount||0); if(Number.isNaN(amt)) continue;
        if(t.kind==="entrada") inc += amt;
        if(t.kind==="saida") out += amt;
        if(t.kind==="transfer") tr += amt;
      }
      return {inc,out,tr,net:inc-out};
    }

    // Alerts
    function shouldSkipAlertsToday(){ try{ const key=localStorage.getItem(LS_KEYS.skipAlerts)||""; if(!key) return false; const until=new Date(key); return until>new Date(); }catch(e){return false;} }
    function skipAlertsForToday(){ const now=new Date(); const until=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,6,0,0,0); localStorage.setItem(LS_KEYS.skipAlerts, until.toISOString()); }
    function daysBetween(a,b){ const one=24*60*60*1000; const A=new Date(a.getFullYear(),a.getMonth(),a.getDate()); const B=new Date(b.getFullYear(),b.getMonth(),b.getDate()); return Math.round((B-A)/one); }
    function getDueAlerts(now=new Date()){ 
      const soonDays=3;
      const tx=loadTransactions().filter(t=>t && t.status!=="excluida");
      const items=tx.filter(t=>t.dueISO && t.paid!==true).map(t=>{
        const due=fromISODate(t.dueISO);
        if(!due) return null;
        const diff=daysBetween(now,due);
        return {id:t.id, title:t.title||"Transa√ß√£o", amount:Number(t.amount||0), dueISO:t.dueISO, diff, accountId:t.accountId};
      }).filter(Boolean).filter(x=>x.diff<=soonDays).sort((a,b)=>a.diff-b.diff);
      return {total:items.length, items};
    }
    function openDueAlertModal(payload){ 
      let ov=document.getElementById("dueModal");
      if(!ov){
        ov=document.createElement("div");
        ov.id="dueModal";
        ov.className="modal-overlay";
        ov.innerHTML=`
          <div class="modal-card" role="dialog" aria-modal="true">
            <div class="modal-head">
              <div class="modal-title">üîî Vencimentos pr√≥ximos</div>
              <button class="btn-muted" id="dueCloseBtn" style="padding:8px 10px; border-radius:10px;">Fechar</button>
            </div>
            <div class="modal-body" id="dueBody"></div>
            <div class="modal-actions">
              <button class="btn-muted" id="dueSkipBtn">N√£o mostrar hoje</button>
              <button class="btn-primary" id="dueGoBtn">Ver Transa√ß√µes</button>
            </div>
          </div>`;
        document.body.appendChild(ov);
      }
      const body=ov.querySelector("#dueBody");
      const list=payload.items.slice(0,6).map(it=>{
        let label="Vence em breve";
        if(it.diff<0) label="Atrasada";
        else if(it.diff===0) label="Vence hoje";
        else if(it.diff===1) label="Vence amanh√£";
        else label=`Vence em ${it.diff} dias`;
        const acc=getAccountById(it.accountId);
        const accName=acc?acc.name:"‚Äî";
        return `
          <div class="modal-item">
            <div>
              <b>${it.title}</b><br/>
              <small>${label} ‚Ä¢ ${formatBRDateFromISO(it.dueISO)} ‚Ä¢ Conta: ${accName}</small>
            </div>
            <div style="text-align:right"><small>${fmtBRL(it.amount)}</small></div>
          </div>`;
      }).join("");
      body.innerHTML=`
        <div style="margin-bottom:8px; color:#334155; font-size:13px;">
          Voc√™ tem <b>${payload.total}</b> transa√ß√£o(√µes) vencendo nos pr√≥ximos 3 dias.
        </div>
        ${list || '<div style="color:#475569; font-size:13px;">Sem itens.</div>'}
        <div style="margin-top:10px; font-size:12px; color:#64748b;">
          Dica: preencha <b>Vencimento</b> na transa√ß√£o para receber alertas.
        </div>`;
      function close(){ ov.classList.remove("active"); }
      ov.querySelector("#dueCloseBtn").onclick=close;
      ov.querySelector("#dueSkipBtn").onclick=()=>{ skipAlertsForToday(); close(); };
      ov.querySelector("#dueGoBtn").onclick=()=>{ close(); renderPage("transactions"); };
      requestAnimationFrame(()=> ov.classList.add("active"));
    }
    function showDueAlertsOnOpen(){ if(shouldSkipAlertsToday()) return; const payload=getDueAlerts(new Date()); if(payload.total>0) openDueAlertModal(payload); }

    function fillAccountsSelect(selId, includeEmpty=false){ 
      const sel=document.getElementById(selId); if(!sel) return;
      const acc=loadAccounts().filter(a=>a && a.enabled!==false);
      sel.innerHTML=(includeEmpty?'<option value="">Selecione...</option>':'') + acc.map(a=>`<option value="${a.id}">${a.name}</option>`).join("");
    }
    function fillCategoriesSelect(selId, type, includeEmpty=false){ 
      const sel=document.getElementById(selId); if(!sel) return;
      const cats=loadCategories().filter(c=>c && c.type===type);
      sel.innerHTML=(includeEmpty?'<option value="">Selecione...</option>':'') + cats.map(c=>`<option value="${c.id}">${c.name}</option>`).join("");
    }

    // Accounts
    function addAccountFromUI(){ 
      const name=(document.getElementById("accName")?.value||"").trim();
      const type=(document.getElementById("accType")?.value||"banco");
      const init=parseBRL(document.getElementById("accInit")?.value||"");
      if(!name) return alert("Digite o nome da conta.");
      const acc=loadAccounts();
      acc.push({id:uid("acc"), name, type, initialBalance:init, enabled:true});
      saveAccounts(acc);
      ["accName","accInit"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
      renderAccountsList();
      alert("Conta salva!");
    }
    function toggleAccount(id){ const acc=loadAccounts(); const a=acc.find(x=>x.id===id); if(!a) return; a.enabled=!(a.enabled!==false); saveAccounts(acc); renderAccountsList(); }
    function editAccountPrompt(id){ 
      const acc=loadAccounts(); const a=acc.find(x=>x.id===id); if(!a) return;
      const nm=prompt("Nome da conta:", a.name||""); if(nm===null) return;
      const tp=prompt("Tipo (banco/dinheiro/beneficio):", a.type||"banco"); if(tp===null) return;
      const init=prompt("Saldo inicial (ex: 123,45) ou vazio:", (a.initialBalance??"")); if(init===null) return;
      a.name=String(nm).trim()||a.name;
      a.type=String(tp).trim()||a.type;
      a.initialBalance=(String(init).trim()==="")?null:parseBRL(init);
      saveAccounts(acc); renderAccountsList();
    }
    function removeAccount(id){ if(!confirm("Excluir esta conta?")) return; saveAccounts(loadAccounts().filter(a=>a.id!==id)); renderAccountsList(); }
    function renderAccountsList(){ 
      const host=document.getElementById("accountsList"); if(!host) return;
      const showDisabled=document.getElementById("accShowDisabled")?.checked===true;
      const q=(document.getElementById("accSearch")?.value||"").trim().toLowerCase();
      const balances=calcBalances();
      const acc=balances.filter(a=>showDisabled?true:(a.enabled!==false)).filter(a=>!q||String(a.name||"").toLowerCase().includes(q));
      if(!acc.length){ host.innerHTML='<div class="note">Nenhuma conta encontrada.</div>'; return; }
      host.innerHTML=`
        <table>
          <thead><tr><th>Conta</th><th>Tipo</th><th>Saldo</th><th>A√ß√µes</th></tr></thead>
          <tbody>
            ${acc.map(a=>`
              <tr>
                <td><b>${a.name}</b> ${a.enabled===false?'<span class="badge-warn"> (desativada)</span>':''}</td>
                <td>${a.type||"‚Äî"}</td>
                <td><b>${fmtBRL(a.balance)}</b></td>
                <td style="white-space:nowrap;">
                  <button class="btn-muted" onclick="editAccountPrompt('${a.id}')">Editar</button>
                  <button class="btn-muted" onclick="toggleAccount('${a.id}')">${a.enabled===false?"Ativar":"Desativar"}</button>
                  <button class="btn-danger" onclick="removeAccount('${a.id}')">Excluir</button>
                </td>
              </tr>`).join("")}
          </tbody>
        </table>`;
    }

    // Categories
    function addCategoryFromUI(){ 
      const name=(document.getElementById("catName")?.value||"").trim();
      const type=(document.getElementById("catType")?.value||"saida");
      if(!name) return alert("Digite o nome da categoria.");
      const cats=loadCategories();
      cats.push({id:uid("cat"), name, type});
      saveCategories(cats);
      document.getElementById("catName").value="";
      renderCategoriesList();
    }
    function editCategoryPrompt(id){ const cats=loadCategories(); const c=cats.find(x=>x.id===id); if(!c) return; const nm=prompt("Nome:", c.name||""); if(nm===null) return; c.name=String(nm).trim()||c.name; saveCategories(cats); renderCategoriesList(); }
    function removeCategory(id){ if(!confirm("Excluir categoria?")) return; saveCategories(loadCategories().filter(c=>c.id!==id)); renderCategoriesList(); }
    function renderCategoriesList(){ 
      const host=document.getElementById("categoriesList"); if(!host) return;
      const cats=loadCategories();
      const rows=cats.map(c=>`
        <tr>
          <td><b>${c.name}</b></td><td>${c.type}</td>
          <td style="white-space:nowrap;">
            <button class="btn-muted" onclick="editCategoryPrompt('${c.id}')">Editar</button>
            <button class="btn-danger" onclick="removeCategory('${c.id}')">Excluir</button>
          </td>
        </tr>`).join("");
      host.innerHTML=`
        <table>
          <thead><tr><th>Categoria</th><th>Tipo</th><th>A√ß√µes</th></tr></thead>
          <tbody>${rows || '<tr><td colspan="3" class="note">Sem categorias.</td></tr>'}</tbody>
        </table>`;
    }

    // Transactions
    function addTransactionFromUI(){ 
      const kind=document.getElementById("txKind")?.value||"saida";
      const title=(document.getElementById("txTitle")?.value||"").trim();
      const amount=parseBRL(document.getElementById("txAmount")?.value||"");
      const dateISO=document.getElementById("txDate")?.value||toISODate(new Date());
      const dueISO=document.getElementById("txDue")?.value||"";
      const accountId=document.getElementById("txAccount")?.value||"";
      const categoryId=document.getElementById("txCategory")?.value||"";
      const toAccountId=document.getElementById("txToAccount")?.value||"";
      const paid=document.getElementById("txPaid")?.checked===true;
      const notes=(document.getElementById("txNotes")?.value||"").trim();
      if(!title) return alert("Digite a descri√ß√£o.");
      if(amount===null) return alert("Digite o valor.");
      if(!accountId) return alert("Selecione a conta.");
      if(kind!=="transfer" && !categoryId) return alert("Selecione a categoria.");
      if(kind==="transfer" && !toAccountId) return alert("Selecione a conta de destino.");
      if(kind==="transfer" && toAccountId===accountId) return alert("Destino n√£o pode ser igual √† origem.");
      const tx=loadTransactions();
      tx.push({id:uid("tx"), kind, title, amount:Number(amount||0), dateISO, dueISO:dueISO||"", accountId, toAccountId:kind==="transfer"?toAccountId:"", categoryId:kind==="transfer"?"":categoryId, paid, notes, createdAt:Date.now(), status:"ativa"});
      saveTransactions(tx);
      document.getElementById("txTitle").value="";
      document.getElementById("txAmount").value="";
      document.getElementById("txNotes").value="";
      document.getElementById("txPaid").checked=false;
      renderTransactions(); renderDashboard();
      alert("Transa√ß√£o salva!");
    }
    function toggleTxPaid(id){ const tx=loadTransactions(); const t=tx.find(x=>x.id===id); if(!t) return; t.paid=!t.paid; saveTransactions(tx); renderTransactions(); renderDashboard(); }
    function removeTx(id){ if(!confirm("Excluir transa√ß√£o?")) return; saveTransactions(loadTransactions().filter(t=>t.id!==id)); renderTransactions(); renderDashboard(); }
    function editTxPrompt(id){ 
      const tx=loadTransactions(); const t=tx.find(x=>x.id===id); if(!t) return;
      const title=prompt("Descri√ß√£o:", t.title||""); if(title===null) return;
      const amount=prompt("Valor (ex: 12,50):", String(t.amount||0).toFixed(2).replace(".",",")); if(amount===null) return;
      const dateISO=prompt("Data (AAAA-MM-DD):", t.dateISO||toISODate(new Date())); if(dateISO===null) return;
      const dueISO=prompt("Vencimento (AAAA-MM-DD) ou vazio:", t.dueISO||""); if(dueISO===null) return;
      const notes=prompt("Observa√ß√µes (opcional):", t.notes||""); if(notes===null) return;
      const parsed=parseBRL(amount); if(parsed===null) return alert("Valor inv√°lido.");
      t.title=String(title).trim()||t.title;
      t.amount=Number(parsed||0);
      t.dateISO=String(dateISO).trim();
      t.dueISO=String(dueISO).trim();
      t.notes=String(notes).trim();
      saveTransactions(tx); renderTransactions(); renderDashboard();
    }
    function getSelectedMonth(){ const ui=getUI(); const now=new Date(); const d=new Date(now.getFullYear(), now.getMonth() + (ui.monthOffset||0), 1); return {y:d.getFullYear(), m:d.getMonth()}; }
    function shiftMonth(delta){ const ui=getUI(); setUI({monthOffset:(ui.monthOffset||0)+delta}); renderDashboard(); renderTransactions(); renderReports(); }
    function onTxKindChange(){ 
      const kind=document.getElementById("txKind")?.value||"saida";
      const catWrap=document.getElementById("txCategoryWrap");
      const toWrap=document.getElementById("txToWrap");
      if(catWrap) catWrap.style.display=(kind==="transfer")?"none":"block";
      if(toWrap) toWrap.style.display=(kind==="transfer")?"block":"none";
      if(kind==="entrada") fillCategoriesSelect("txCategory","entrada",true);
      if(kind==="saida") fillCategoriesSelect("txCategory","saida",true);
    }
    function renderTransactions(){ 
      const host=document.getElementById("txList"); if(!host) return;
      const {y,m}=getSelectedMonth();
      const tx=loadTransactions().filter(t=>t && t.status!=="excluida").filter(t=>t.dateISO && isSameMonth(t.dateISO,y,m)).sort((a,b)=>(b.dateISO||"").localeCompare(a.dateISO||"") || (b.createdAt||0)-(a.createdAt||0));
      if(!tx.length){ host.innerHTML='<div class="note">Sem transa√ß√µes neste m√™s.</div>'; return; }
      const rows=tx.map(t=>{
        const acc=getAccountById(t.accountId);
        const cat=t.categoryId?getCategoryById(t.categoryId):null;
        const toAcc=t.toAccountId?getAccountById(t.toAccountId):null;
        const kindLabel=t.kind==="entrada"?"Entrada":(t.kind==="saida"?"Sa√≠da":"Transfer√™ncia");
        const badge=t.paid?'<span class="badge-ok">Paga</span>':'<span class="badge-warn">Pendente</span>';
        const due=t.dueISO?(' ‚Ä¢ Venc: '+formatBRDateFromISO(t.dueISO)):"";
        const meta=t.kind==="transfer"
          ? `De <b>${acc?acc.name:"‚Äî"}</b> para <b>${toAcc?toAcc.name:"‚Äî"}</b>`
          : `Conta: <b>${acc?acc.name:"‚Äî"}</b> ‚Ä¢ Cat: <b>${cat?cat.name:"‚Äî"}</b>`;
        return `
          <tr>
            <td><b>${t.title}</b><div class="note">${meta}${due}</div></td>
            <td>${kindLabel}</td>
            <td><b>${fmtBRL(t.amount)}</b></td>
            <td>${formatBRDateFromISO(t.dateISO)}</td>
            <td>${badge}</td>
            <td style="white-space:nowrap;">
              <button class="btn-muted" onclick="toggleTxPaid('${t.id}')">${t.paid?"Desmarcar":"Marcar paga"}</button>
              <button class="btn-muted" onclick="editTxPrompt('${t.id}')">Editar</button>
              <button class="btn-danger" onclick="removeTx('${t.id}')">Excluir</button>
            </td>
          </tr>`;
      }).join("");
      host.innerHTML=`
        <table>
          <thead><tr><th>Descri√ß√£o</th><th>Tipo</th><th>Valor</th><th>Data</th><th>Status</th><th>A√ß√µes</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    // Cards MVP
    function addCardFromUI(){ 
      const name=(document.getElementById("cardName")?.value||"").trim();
      const dueDay=clamp(Number((document.getElementById("cardDue")?.value||"").replace(/\D/g,''))||0,1,31);
      const closeDay=clamp(Number((document.getElementById("cardClose")?.value||"").replace(/\D/g,''))||0,1,31);
      if(!name) return alert("Nome do cart√£o obrigat√≥rio.");
      if(!dueDay) return alert("Dia de vencimento obrigat√≥rio.");
      if(!closeDay) return alert("Dia de fechamento obrigat√≥rio.");
      const cards=loadCards(); cards.push({id:uid("card"), name, dueDay, closeDay, enabled:true});
      saveCards(cards);
      ["cardName","cardDue","cardClose"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
      renderCards();
    }
    function removeCard(id){ if(!confirm("Excluir cart√£o?")) return; saveCards(loadCards().filter(c=>c.id!==id)); saveCardTx(loadCardTx().filter(t=>t.cardId!==id)); renderCards(); }
    function addCardPurchaseFromUI(){ 
      const cardId=document.getElementById("cpCard")?.value||"";
      const title=(document.getElementById("cpTitle")?.value||"").trim();
      const amount=parseBRL(document.getElementById("cpAmount")?.value||"");
      const dateISO=document.getElementById("cpDate")?.value||toISODate(new Date());
      const installments=clamp(Number((document.getElementById("cpInst")?.value||"").replace(/\D/g,''))||1,1,36);
      if(!cardId) return alert("Selecione o cart√£o.");
      if(!title) return alert("Descri√ß√£o obrigat√≥ria.");
      if(amount===null) return alert("Valor obrigat√≥rio.");
      const baseDate=fromISODate(dateISO)||new Date();
      const per=Number(amount||0)/installments;
      const all=loadCardTx();
      for(let i=0;i<installments;i++){ 
        const d=new Date(baseDate.getFullYear(), baseDate.getMonth()+i, baseDate.getDate(), 12,0,0,0);
        all.push({id:uid("cptx"), cardId, title, amount:Math.round(per*100)/100, installment:i+1, installments, dateISO:toISODate(d), paid:false});
      }
      saveCardTx(all);
      ["cpTitle","cpAmount"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
      renderCards();
      alert("Compra lan√ßada!");
    }
    function toggleCardTxPaid(id){ const tx=loadCardTx(); const t=tx.find(x=>x.id===id); if(!t) return; t.paid=!t.paid; saveCardTx(tx); renderCards(); }
    function renderCards(){ 
      const host=document.getElementById("cardsBody"); if(!host) return;
      const cards=loadCards().filter(c=>c && c.enabled!==false);
      const all=loadCardTx().filter(t=>t);
      const {y,m}=getSelectedMonth();
      const monthISO=y+"-"+pad2(m+1);
      const opts=cards.map(c=>`<option value="${c.id}">${c.name}</option>`).join("");
      const monthItems=all.filter(t=>isSameMonth(t.dateISO,y,m));
      const total=monthItems.reduce((s,t)=>s+Number(t.amount||0),0);
      const rows=monthItems.sort((a,b)=>(a.dateISO||"").localeCompare(b.dateISO||"")).map(t=>{
        const c=cards.find(x=>x.id===t.cardId);
        const badge=t.paid?'<span class="badge-ok">Pago</span>':'<span class="badge-warn">Pendente</span>';
        const inst=t.installments>1?`${t.installment}/${t.installments}`:"‚Äî";
        return `
          <tr>
            <td><b>${t.title}</b><div class="note">${c?c.name:"‚Äî"} ‚Ä¢ Parcela: ${inst}</div></td>
            <td><b>${fmtBRL(t.amount)}</b></td>
            <td>${formatBRDateFromISO(t.dateISO)}</td>
            <td>${badge}</td>
            <td style="white-space:nowrap;"><button class="btn-muted" onclick="toggleCardTxPaid('${t.id}')">${t.paid?"Desmarcar":"Marcar pago"}</button></td>
          </tr>`;
      }).join("");
      host.innerHTML=`
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-bottom:10px;">
          <button class="btn-muted" onclick="shiftMonth(-1)">‚óÄ</button>
          <span class="pill">M√™s: <b>${monthISO}</b></span>
          <button class="btn-muted" onclick="shiftMonth(1)">‚ñ∂</button>
        </div>
        <div class="grid">
          <div class="metric"><div class="label">üí≥ Fatura do m√™s</div><div class="value">${fmtBRL(total)}</div><div class="hint">MVP: fatura por m√™s da compra. Parcelas avan√ßam meses automaticamente.</div></div>
          <div class="metric"><div class="label">Cart√µes cadastrados</div><div class="value">${cards.length}</div><div class="hint">Crie e lance compras abaixo.</div></div>
        </div>

        <div class="section-divider"></div>

        <div class="card" style="margin-top:0;">
          <h3>‚ûï Novo cart√£o</h3>
          <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
            <div style="flex:1; min-width:240px;"><div class="note" style="margin-bottom:6px;">Nome</div><input id="cardName" placeholder="Ex: Nubank" /></div>
            <div style="width:170px;"><div class="note" style="margin-bottom:6px;">Vencimento</div><input id="cardDue" inputmode="numeric" placeholder="Dia 1-31" /></div>
            <div style="width:170px;"><div class="note" style="margin-bottom:6px;">Fechamento</div><input id="cardClose" inputmode="numeric" placeholder="Dia 1-31" /></div>
            <button class="btn-primary" onclick="addCardFromUI()">Salvar</button>
          </div>
        </div>

        <div class="card">
          <h3>üßæ Lan√ßar compra no cart√£o</h3>
          <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
            <div style="flex:1; min-width:260px;"><div class="note" style="margin-bottom:6px;">Cart√£o</div><select id="cpCard">${opts || '<option value="">(Cadastre um cart√£o)</option>'}</select></div>
            <div style="flex:1; min-width:240px;"><div class="note" style="margin-bottom:6px;">Descri√ß√£o</div><input id="cpTitle" placeholder="Ex: Mercado, Farm√°cia" /></div>
            <div style="width:170px;"><div class="note" style="margin-bottom:6px;">Valor</div><input id="cpAmount" placeholder="0,00" /></div>
            <div style="width:190px;"><div class="note" style="margin-bottom:6px;">Data</div><input id="cpDate" type="date" value="${toISODate(new Date())}" /></div>
            <div style="width:140px;"><div class="note" style="margin-bottom:6px;">Parcelas</div><input id="cpInst" inputmode="numeric" placeholder="1" value="1" /></div>
            <button class="btn-primary" onclick="addCardPurchaseFromUI()">Lan√ßar</button>
          </div>
        </div>

        <div class="card">
          <h3>üìÑ Compras do m√™s</h3>
          <table><thead><tr><th>Descri√ß√£o</th><th>Valor</th><th>Data</th><th>Status</th><th>A√ß√µes</th></tr></thead>
          <tbody>${rows || '<tr><td colspan="5" class="note">Sem compras neste m√™s.</td></tr>'}</tbody></table>
        </div>

        <div class="card">
          <h3>üóëÔ∏è Gerenciar cart√µes</h3>
          <div style="display:flex; flex-direction:column; gap:10px;">
            ${cards.map(c=>`
              <div class="row">
                <div><div class="label">${c.name}</div><div class="desc">Fecha dia ${pad2(c.closeDay)} ‚Ä¢ Vence dia ${pad2(c.dueDay)}</div></div>
                <button class="btn-danger" onclick="removeCard('${c.id}')">Excluir</button>
              </div>`).join("") || '<div class="note">Sem cart√µes.</div>'}
          </div>
        </div>`;
    }

    // Reports
    function computeSixMonthExpenses(){ 
      const now=new Date();
      const tx=loadTransactions().filter(t=>t && t.kind==="saida" && t.status!=="excluida");
      const arr=[];
      for(let i=5;i>=0;i--){ 
        const d=new Date(now.getFullYear(), now.getMonth()-i, 1);
        const y=d.getFullYear(), m=d.getMonth();
        const sum=tx.filter(t=>t.dateISO && isSameMonth(t.dateISO,y,m)).reduce((s,t)=>s+Number(t.amount||0),0);
        arr.push({label:pad2(m+1)+"/"+String(y).slice(2), value:sum});
      }
      return arr;
    }
    function renderReports(){ 
      const host=document.getElementById("reportsBody"); if(!host) return;
      const data=computeSixMonthExpenses();
      const max=Math.max(1, ...data.map(d=>d.value||0));
      host.innerHTML=`
        <div class="card">
          <h3>üìä Despesas ‚Äì √∫ltimos 6 meses</h3>
          <div class="note">Gr√°fico simples em barra deitada.</div>
          <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
            ${data.map(d=>{
              const w=Math.round((d.value/max)*100);
              return `
                <div>
                  <div style="display:flex; justify-content:space-between; gap:10px; font-size:12px; color:var(--muted);">
                    <span>${d.label}</span><span><b>${fmtBRL(d.value)}</b></span>
                  </div>
                  <div style="height:12px; border-radius:999px; background: rgba(255,255,255,.06); border:1px solid var(--line); overflow:hidden;">
                    <div style="height:100%; width:${w}%; background: rgba(99,102,241,.75);"></div>
                  </div>
                </div>`;
            }).join("")}
          </div>
        </div>`;
    }

    // Dashboard
    function renderDashboard(){ 
      const host=document.getElementById("dashboardBody"); if(!host) return;
      const {y,m}=getSelectedMonth();
      const totals=calcMonthTotals(y,m);
      const balances=calcBalances();
      const totalBalance=balances.filter(a=>a.enabled!==false).reduce((s,a)=>s+Number(a.balance||0),0);
      const monthLabel=pad2(m+1)+"/"+y;

      const lastTx=loadTransactions().filter(t=>t && t.status!=="excluida").sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)).slice(0,6);

      host.innerHTML=`
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-bottom:10px;">
          <button class="btn-muted" onclick="shiftMonth(-1)">‚óÄ M√™s anterior</button>
          <span class="pill">M√™s: <b>${monthLabel}</b></span>
          <button class="btn-muted" onclick="shiftMonth(1)">Pr√≥ximo m√™s ‚ñ∂</button>
        </div>

        <div class="grid">
          <div class="metric"><div class="label">üí∞ Saldo total</div><div class="value">${fmtBRL(totalBalance)}</div><div class="hint">Soma dos saldos das contas.</div></div>
          <div class="metric"><div class="label">‚¨Ü Entradas (m√™s)</div><div class="value">${fmtBRL(totals.inc)}</div><div class="hint">Entradas lan√ßadas no m√™s.</div></div>
          <div class="metric"><div class="label">‚¨á Sa√≠das (m√™s)</div><div class="value">${fmtBRL(totals.out)}</div><div class="hint">Sa√≠das lan√ßadas no m√™s.</div></div>
          <div class="metric"><div class="label">üìå Saldo do m√™s</div><div class="value">${fmtBRL(totals.net)}</div><div class="hint">Entradas - Sa√≠das.</div></div>
        </div>

        <div class="section-divider"></div>

        <div class="card">
          <h3>üè¶ Saldos por conta</h3>
          <table>
            <thead><tr><th>Conta</th><th>Tipo</th><th>Saldo</th></tr></thead>
            <tbody>
              ${balances.filter(a=>a.enabled!==false).map(a=>`
                <tr><td><b>${a.name}</b></td><td>${a.type||"‚Äî"}</td><td><b>${fmtBRL(a.balance)}</b></td></tr>
              `).join("") || '<tr><td colspan="3" class="note">Sem contas.</td></tr>'}
            </tbody>
          </table>
        </div>

        <div class="card">
          <h3>üïí √öltimas transa√ß√µes</h3>
          <table>
            <thead><tr><th>Descri√ß√£o</th><th>Tipo</th><th>Valor</th><th>Data</th></tr></thead>
            <tbody>
              ${lastTx.map(t=>{
                const kind=t.kind==="entrada"?"Entrada":(t.kind==="saida"?"Sa√≠da":"Transfer");
                return `<tr><td><b>${t.title}</b></td><td>${kind}</td><td><b>${fmtBRL(t.amount)}</b></td><td>${formatBRDateFromISO(t.dateISO)}</td></tr>`;
              }).join("") || '<tr><td colspan="4" class="note">Sem transa√ß√µes.</td></tr>'}
            </tbody>
          </table>
        </div>`;
    }

    function renderPage(page){ 
      const titleEl=document.getElementById("pageTitle");
      const subEl=document.getElementById("pageSubtitle");
      const mainEl=document.getElementById("pageBody");

      document.querySelectorAll(".nav a[data-page]").forEach(a=>a.classList.toggle("active", a.getAttribute("data-page")===page));

      const pages={
        dashboard:{title:"Vis√£o Geral", sub:"Resumo do m√™s, saldos e √∫ltimas transa√ß√µes.", html:`<div id="dashboardBody"></div>`},
        transactions:{title:"Transa√ß√µes", sub:"Entradas, sa√≠das e transfer√™ncias (‚áÑ). Vencimento aqui gera alerta ao abrir o app.", html:`
          <div class="card">
            <h3>‚ûï Nova transa√ß√£o</h3>
            <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
              <div style="width:190px; min-width:170px;"><div class="note" style="margin-bottom:6px;">Tipo</div>
                <select id="txKind" onchange="onTxKindChange()">
                  <option value="saida">Sa√≠da</option>
                  <option value="entrada">Entrada</option>
                  <option value="transfer">Transfer√™ncia (‚áÑ)</option>
                </select>
              </div>
              <div style="flex:1; min-width:240px;"><div class="note" style="margin-bottom:6px;">Descri√ß√£o</div><input id="txTitle" placeholder="Ex: Supermercado, IPVA, Sal√°rio..." /></div>
              <div style="width:170px;"><div class="note" style="margin-bottom:6px;">Valor</div><input id="txAmount" placeholder="0,00" /></div>
              <div style="width:190px;"><div class="note" style="margin-bottom:6px;">Data</div><input id="txDate" type="date" value="${toISODate(new Date())}" /></div>
              <div style="width:190px;"><div class="note" style="margin-bottom:6px;">Vencimento (opcional)</div><input id="txDue" type="date" /></div>
            </div>

            <div class="section-divider"></div>

            <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
              <div style="flex:1; min-width:240px;"><div class="note" style="margin-bottom:6px;">Conta</div><select id="txAccount"></select></div>
              <div id="txToWrap" style="flex:1; min-width:240px; display:none;"><div class="note" style="margin-bottom:6px;">Conta destino</div><select id="txToAccount"></select></div>
              <div id="txCategoryWrap" style="flex:1; min-width:240px;"><div class="note" style="margin-bottom:6px;">Categoria</div><select id="txCategory"></select></div>
              <div style="width:140px; min-width:140px;"><div class="note" style="margin-bottom:6px;">Paga?</div>
                <label class="pill" style="gap:10px; cursor:pointer;"><input id="txPaid" type="checkbox" style="width:auto; max-width:none;" />Sim</label>
              </div>
              <button class="btn-primary" onclick="addTransactionFromUI()">Salvar</button>
            </div>

            <div style="margin-top:12px;"><div class="note">Observa√ß√µes</div><textarea id="txNotes" placeholder="Opcional..."></textarea></div>
          </div>

          <div class="card">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <h3 style="margin:0;">üìã Transa√ß√µes do m√™s</h3>
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn-muted" onclick="shiftMonth(-1)">‚óÄ</button>
                <button class="btn-muted" onclick="shiftMonth(1)">‚ñ∂</button>
              </div>
            </div>
            <div class="section-divider"></div>
            <div id="txList"></div>
          </div>`},
        accounts:{title:"Contas", sub:"Onde o dinheiro est√° (banco, dinheiro, benef√≠cios).", html:`
          <div class="card">
            <h3>‚ûï Nova conta</h3>
            <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
              <div style="flex:1; min-width:240px;"><div class="note" style="margin-bottom:6px;">Nome</div><input id="accName" placeholder="Ex: Mercado Pago, Nubank, Dinheiro..." /></div>
              <div style="width:210px;"><div class="note" style="margin-bottom:6px;">Tipo</div>
                <select id="accType"><option value="banco">Banco</option><option value="dinheiro">Dinheiro</option><option value="beneficio">Benef√≠cio</option></select>
              </div>
              <div style="width:210px;"><div class="note" style="margin-bottom:6px;">Saldo inicial (opcional)</div><input id="accInit" placeholder="0,00" /></div>
              <button class="btn-primary" onclick="addAccountFromUI()">Salvar</button>
            </div>
          </div>

          <div class="card">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <h3 style="margin:0;">üìã Suas contas</h3>
              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <input id="accSearch" placeholder="Buscar..." style="max-width:220px;" />
                <label class="pill" style="cursor:pointer;"><input id="accShowDisabled" type="checkbox" style="width:auto; max-width:none;" />Mostrar desativadas</label>
                <button class="btn-muted" onclick="renderAccountsList()">Atualizar</button>
              </div>
            </div>
            <div class="section-divider"></div>
            <div id="accountsList"></div>
          </div>`},
        cards:{title:"Cart√µes", sub:"Controle simples de compras e fatura por m√™s (MVP).", html:`<div id="cardsBody"></div>`},
        reports:{title:"Relat√≥rios", sub:"Visual simples para voc√™ entender r√°pido.", html:`<div id="reportsBody"></div>`},
        settings:{title:"Configura√ß√µes", sub:"Categorias e √°rea t√©cnica (backup/import).", html:`
          <div class="card">
            <h3>üè∑Ô∏è Categorias</h3>
            <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
              <div style="flex:1; min-width:240px;"><div class="note" style="margin-bottom:6px;">Nome</div><input id="catName" placeholder="Ex: Mercado, Sa√∫de..." /></div>
              <div style="width:220px;"><div class="note" style="margin-bottom:6px;">Tipo</div><select id="catType"><option value="saida">Sa√≠da</option><option value="entrada">Entrada</option></select></div>
              <button class="btn-primary" onclick="addCategoryFromUI()">Adicionar</button>
            </div>
            <div class="section-divider"></div>
            <div id="categoriesList"></div>
          </div>

          <div class="card">
            <h3>üóÇÔ∏è Dados</h3>
            <div class="row"><div><div class="label">Exportar</div><div class="desc">Baixar seus dados em JSON</div></div><button class="btn-primary" onclick="exportData()">Exportar</button></div>
            <div class="row"><div><div class="label">Importar</div><div class="desc">Substitui dados atuais pelo JSON</div></div><button class="btn-primary" onclick="importData()">Importar</button></div>
            <div class="row"><div><div class="label">Limpar dados</div><div class="desc">A√ß√£o irrevers√≠vel</div></div><button class="btn-danger" onclick="clearAllData()">Limpar</button></div>
            <div class="row"><div><div class="label">Limpar cache do app</div><div class="desc">Resolve tela desatualizada</div></div><button class="btn-danger" onclick="clearAppCache()">Limpar Cache</button></div>
            <p class="note" style="margin-top:10px;">Build: <span class="mono">v2026.02.21-26T-01</span></p>
          </div>`},
      };

      const p=pages[page] || pages.dashboard;
      titleEl.textContent=p.title;
      subEl.textContent=p.sub;
      mainEl.innerHTML=p.html;

      if(page==="dashboard") renderDashboard();
      if(page==="accounts"){ 
        document.getElementById("accSearch")?.addEventListener("input", renderAccountsList);
        document.getElementById("accShowDisabled")?.addEventListener("change", renderAccountsList);
        renderAccountsList();
      }
      if(page==="settings") renderCategoriesList();
      if(page==="cards") renderCards();
      if(page==="reports") renderReports();
      if(page==="transactions"){ 
        fillAccountsSelect("txAccount", true);
        fillAccountsSelect("txToAccount", true);
        fillCategoriesSelect("txCategory","saida", true);
        onTxKindChange();
        renderTransactions();
      }

      if(location.hash.replace("#","")!==page) location.hash="#"+page;
    }

    function openDrawer(){ const sb=document.querySelector(".sidebar"); const ov=document.getElementById("drawerOverlay"); if(!sb||!ov) return; sb.classList.add("open"); ov.classList.add("active"); document.body.classList.add("drawer-open"); }
    function closeDrawer(){ const sb=document.querySelector(".sidebar"); const ov=document.getElementById("drawerOverlay"); if(!sb||!ov) return; sb.classList.remove("open"); ov.classList.remove("active"); document.body.classList.remove("drawer-open"); }
    function toggleDrawer(){ const sb=document.querySelector(".sidebar"); if(!sb) return; if(sb.classList.contains("open")) closeDrawer(); else openDrawer(); }

    function initNav(){ 
      ensureSeed();

      const buildTag=document.getElementById("buildTag");
      const buildPill=document.getElementById("buildPill");
      const buildPillMobile=document.getElementById("buildPillMobile");
      if(buildTag) buildTag.textContent=window.__BUILD_ID__;
      if(buildPill) buildPill.textContent="Build "+window.__BUILD_ID__;
      if(buildPillMobile) buildPillMobile.textContent="Build "+window.__BUILD_ID__;

      const sb=document.querySelector(".sidebar");
      const ui=getUI();
      if(ui.sidebarCollapsed) sb?.classList.add("collapsed");

      document.getElementById("sidebarToggle")?.addEventListener("click", ()=>{ 
        sb?.classList.toggle("collapsed");
        setUI({sidebarCollapsed: sb?.classList.contains("collapsed")});
      });

      document.querySelectorAll(".nav a[data-page]").forEach(a=>{
        a.addEventListener("click", (e)=>{
          e.preventDefault();
          const page=a.getAttribute("data-page");
          renderPage(page);
          if(window.matchMedia && window.matchMedia("(max-width: 980px)").matches) closeDrawer();
        });
      });

      document.getElementById("mobileMenuBtn")?.addEventListener("click", (e)=>{ e.preventDefault(); toggleDrawer(); });
      document.getElementById("drawerOverlay")?.addEventListener("click", closeDrawer);

      const initial=(location.hash || "#dashboard").replace("#","");
      renderPage(initial);

      showDueAlertsOnOpen();
    }

    window.addEventListener("DOMContentLoaded", initNav);
    window.addEventListener("hashchange", ()=>{ const page=(location.hash||"#dashboard").replace("#",""); renderPage(page); });
  </script>
</head>
<body>
  <div class="drawer-overlay" id="drawerOverlay"></div>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <h2 id="brandTitle">Minhas<br/>Finan√ßas</h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn-muted" id="sidebarToggle" title="Minimizar/Expandir" style="padding:8px 10px; border-radius:12px;">‚ò∞</button>
          <div class="version" id="buildTag"></div>
        </div>
      </div>

      <nav class="nav">
        <a href="#dashboard" data-page="dashboard" class="active" data-label="Vis√£o Geral"><span class="left"><span class="icon">üè†</span><span class="text">Vis√£o Geral</span></span></a>
        <a href="#transactions" data-page="transactions" data-label="Transa√ß√µes"><span class="left"><span class="icon">‚áÑ</span><span class="text">Transa√ß√µes</span></span></a>
        <a href="#accounts" data-page="accounts" data-label="Contas"><span class="left"><span class="icon">üè¶</span><span class="text">Contas</span></span></a>
        <a href="#cards" data-page="cards" data-label="Cart√µes"><span class="left"><span class="icon">üí≥</span><span class="text">Cart√µes</span></span></a>
        <a href="#reports" data-page="reports" data-label="Relat√≥rios"><span class="left"><span class="icon">üìä</span><span class="text">Relat√≥rios</span></span></a>

        <div class="spacer"></div>
        <a href="#settings" data-page="settings" data-label="Configura√ß√µes"><span class="left"><span class="icon">‚öôÔ∏è</span><span class="text">Configura√ß√µes</span></span></a>
      </nav>
    </aside>

    <main class="main">
      <div class="mobile-topbar">
        <div class="mt-left">
          <button class="btn-muted" id="mobileMenuBtn" title="Menu" style="padding:8px 10px; border-radius:12px;">‚ò∞</button>
          <div class="mt-title">Minhas Finan√ßas</div>
        </div>
        <div class="mt-right">
          <span class="pill" id="buildPillMobile"></span>
        </div>
      </div>

      <div class="topbar">
        <div>
          <h1 class="title" id="pageTitle">Vis√£o Geral</h1>
          <p class="subtitle" id="pageSubtitle">Resumo do m√™s, saldos e √∫ltimas transa√ß√µes.</p>
        </div>
        <span class="pill" id="buildPill"></span>
      </div>

      <section id="pageBody"></section>
    </main>
  </div>
</body>
</html>
