<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Finanças</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #10b981;
            --secondary-dark: #059669;
            --danger-color: #ef4444;
            --danger-dark: #dc2626;
            --warning-color: #f59e0b;
            --warning-dark: #d97706;
            --bg-color: #f9fafb;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --primary-color: #818cf8;
            --primary-dark: #6366f1;
            --secondary-color: #34d399;
            --secondary-dark: #10b981;
            --danger-color: #f87171;
            --danger-dark: #ef4444;
            --warning-color: #fbbf24;
            --warning-dark: #f59e0b;
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-color: #f9fafb;
            --text-light: #d1d5db;
            --border-color: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            flex: 1;
        }

        .sidebar {
            width: 250px;
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            transition: var(--transition);
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-title {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            color: var(--primary-color);
            font-size: 1.8rem;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .nav-menu {
            list-style: none;
            padding: 20px 0;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-color);
            text-decoration: none;
            border-radius: 6px;
            margin: 0 10px;
            transition: var(--transition);
        }

        .nav-link:hover {
            background-color: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
        }

        .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }

        .nav-icon {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            transition: margin-left 0.3s ease;
            position: relative;
        }
        
        .main-content.sidebar-active-overlay::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .main-content.sidebar-active-overlay.sidebar-open::before {
            opacity: 1;
            visibility: visible;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-label {
            margin-left: 10px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: var(--transition);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .stat-card {
            padding: 15px;
        }

        .stat-title {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .stat-positive {
            color: var(--secondary-color);
        }

        .stat-negative {
            color: var(--danger-color);
        }

        .month-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .month-nav-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .month-nav-btn:hover {
            background-color: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
        }

        .current-month {
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .current-month:hover {
            background-color: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
        }

        .btn {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: var(--danger-dark);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: var(--warning-dark);
        }

        .btn-outlined {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .btn-outlined:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 0.85rem;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .transaction-list {
            margin-top: 20px;
        }

        .transaction-day {
            margin-bottom: 15px;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .day-date {
            color: var(--text-light);
        }

        .day-balance {
            color: var(--secondary-color);
        }

        .day-balance.negative {
            color: var(--danger-color);
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .transaction-item:hover {
            background-color: rgba(99, 102, 241, 0.05);
        }
        .transaction-item.card-item-pending-preview {
            opacity: 0.6;
        }

        .transaction-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1;
            min-width: 0;
        }

        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .income-icon {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--secondary-color);
        }

        .expense-icon {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .transfer-icon {
            background-color: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
        }

        .card-expense-icon {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .card-invoice-group-icon {
            background-color: rgba(139, 92, 246, 0.1);
            color: var(--primary-color);
        }

        .transaction-details {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 0;
        }

        .transaction-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .transaction-category {
            font-size: 0.85rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .transaction-amount {
            font-weight: 600;
            white-space: nowrap;
            margin-left: 10px;
        }

        .income-amount {
            color: var(--secondary-color);
        }

        .expense-amount {
            color: var(--danger-color);
        }

        .transaction-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .transaction-item:hover .transaction-actions,
        .card-bill-group:hover .transaction-actions {
            opacity: 1;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .action-btn:hover {
            color: var(--primary-color);
            background-color: rgba(99, 102, 241, 0.1);
        }

        .delete-btn:hover {
            color: var(--danger-color);
            background-color: rgba(239, 68, 68, 0.1);
        }

        .progress-container {
            margin: 15px 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .progress-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .progress-values {
            color: var(--text-light);
        }

        
        .progress-bar {
            height: 16px;
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: var(--transition);
            position: relative;
            min-width: 26px;
        }

        .progress-percent {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.35);
            pointer-events: none;
        }

        .progress-bar.clickable { cursor: pointer; }

        .drilldown-modal { max-width: 820px; }
        .drilldown-header-meta{ font-size: 0.85rem; color: var(--text-light); margin-top: 4px; }
        .drilldown-toolbar{ display:flex; gap:10px; align-items:center; justify-content: space-between; margin-bottom: 12px; flex-wrap: wrap; }
        .drilldown-search{ flex:1; min-width: 220px; }
        .drilldown-table{ width:100%; border-collapse: collapse; }
        .drilldown-table th, .drilldown-table td{ padding:10px 8px; border-bottom: 1px solid var(--border-color); font-size: 0.92rem; }
        .drilldown-table th{ text-align:left; color: var(--text-light); font-weight: 600; font-size: 0.8rem; letter-spacing: .02em; text-transform: uppercase; }
        .drilldown-table td.amount{ text-align:right; font-weight: 600; white-space: nowrap; }
        .drilldown-pill{ display:inline-flex; gap:6px; align-items:center; padding:4px 10px; border-radius: 999px; border: 1px solid var(--border-color); font-size: 0.8rem; color: var(--text-color); background: rgba(99, 102, 241, 0.06); }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            padding: 10px;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px) scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        .modal-body {
            padding: 20px;
        }

        .form-row {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-input,
        .form-select  {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
        }
        .form-input:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .form-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%236b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
            padding-right: 40px;
        }
        [data-theme="dark"] .form-select {
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23d1d5db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>');
        }

        .form-row-inline {
            display: flex;
            gap: 15px;
        }

        .form-row-inline > * {
            flex: 1;
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
        }

        .form-check input[type="checkbox"],
        .form-check input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
            cursor: pointer;
        }

        .form-check label {
            cursor: pointer;
            font-weight: normal;
        }

        .form-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
        }

        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(36px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .emoji-item {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
        }

        .emoji-item:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .emoji-item.selected {
            background-color: var(--primary-color);
            color: white;
        }

        .color-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .color-item {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .color-item.selected {
            border-color: var(--text-color);
            transform: scale(1.2);
        }
         [data-theme="dark"] .color-item.selected {
            border-color: var(--primary-color);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateX(30px);
            transition: var(--transition);
            width: calc(100% - 40px);
            max-width: 350px;

        }

        .notification.active {
            opacity: 1;
            transform: translateX(0);
        }

        .notification-success {
            border-left: 4px solid var(--secondary-color);
        }

        .notification-error {
            border-left: 4px solid var(--danger-color);
        }

        .notification-warning {
            border-left: 4px solid var(--warning-color);
        }

        .notification-info {
            border-left: 4px solid var(--primary-color);
        }

        .notification-icon {
            font-size: 1.2rem;
        }

        .notification-success .notification-icon {
            color: var(--secondary-color);
        }

        .notification-error .notification-icon {
            color: var(--danger-color);
        }

        .notification-warning .notification-icon {
            color: var(--warning-color);
        }

        .notification-info .notification-icon {
            color: var(--primary-color);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .notification-message {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 2px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .notification-close:hover {
            color: var(--text-color);
        }

        .user-profile {
            position: relative;
        }

        .profile-button {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .profile-button:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .profile-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
        }

        .profile-info {
            max-width: 140px;
            text-align: left;
        }

        .profile-name {
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-email {
            font-size: 0.75rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-dropdown {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            width: 200px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1050;
            overflow: hidden;
            transform-origin: top right;
            transform: scale(0.95) translateY(-10px);
            opacity: 0;
            visibility: hidden;
            transition: transform 0.2s ease, opacity 0.2s ease, visibility 0.2s ease;
        }

        .profile-dropdown.active {
            transform: scale(1) translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .dropdown-list {
            list-style: none;
        }

        .dropdown-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .dropdown-item:hover {
            background-color: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
        }
         [data-theme="dark"] .dropdown-item:hover {
            color: var(--primary-color);
        }

        .dropdown-item i {
            width: 20px;
            text-align: center;
        }

        .dropdown-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 5px 0;
        }

        .no-data {
            text-align: center;
            padding: 30px;
            color: var(--text-light);
        }

        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .chart-container {
            position: relative;
            height: 250px;
            margin: 20px 0;
            padding: 15px;
            border-radius: 12px;
            background: linear-gradient(145deg, 
                var(--card-bg) 0%, 
                rgba(99, 102, 241, 0.02) 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid rgba(99, 102, 241, 0.08);
        }

        .chart-container canvas {
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.08));
            border-radius: 8px;
        }

        .chart-container:has(#categoryChart) {
            height: 350px;
        }

        .chart-container:has(#incomeCategoryChart) {
            height: 350px;
        }

        .chart-container:has(#categoryChart) canvas,
        .chart-container:has(#incomeCategoryChart) canvas {
            max-width: 100%;
            max-height: 100%;
            width: 100% !important;
            height: 100% !important;
        }

        /* Garantir que ambos os donut charts tenham o mesmo tamanho */
        .chart-container:has(#categoryChart),
        .chart-container:has(#incomeCategoryChart) {
            min-height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-container:has(#incomeExpenseChart) {
            height: 320px;
        }

        .chart-container:has(#futureIncomeExpenseChart) {
            height: 320px;
        }

        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .chart-container {
            background: linear-gradient(145deg, 
                var(--card-bg) 0%, 
                rgba(99, 102, 241, 0.05) 100%);
            border: 1px solid rgba(99, 102, 241, 0.12);
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }

        [data-theme="dark"] .chart-container:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
        }

        @media (max-width: 768px) {
            .chart-container:has(#categoryChart) {
                height: 320px;
                padding: 10px;
            }
            
            .chart-container:has(#incomeCategoryChart) {
                height: 320px;
                padding: 10px;
            }

            .chart-container:has(#categoryChart),
            .chart-container:has(#incomeCategoryChart) {
                min-height: 320px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .chart-container:has(#incomeExpenseChart) {
                height: 280px;
                padding: 10px;
            }
            
            .chart-container:has(#futureIncomeExpenseChart) {
                height: 280px;
                padding: 10px;
            }
            
            .chart-container {
                margin: 15px 0;
                padding: 10px;
            }
            
            .chart-container:hover {
                transform: none;
            }
        }

        .login-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }

        .login-image {
            flex: 1;
            background: #1F2937;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .login-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 40px;
            min-width: 320px;
        }

        .login-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .login-logo {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: var(--text-light);
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
        }

        .login-footer {
            margin-top: 30px;
            text-align: center;
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }
        .settings-section > .settings-option:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }

        .settings-label {
            font-weight: 500;
        }

        .settings-description {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 2px;
        }

        @media (max-width: 992px) {
            .sidebar {
                width: 280px;
                transform: translateX(-100%);
                box-shadow: 0 0 20px rgba(0,0,0,0.15);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .menu-toggle {
                display: block; 
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .header {
                position: sticky;
                top: 0;
                background-color: var(--bg-color);
                z-index: 900;
                padding: 10px 15px;
                margin-top:0;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .page-title {
                margin-left: 10px;
                flex-grow: 1;
                text-align: left;
                font-size: 1.2rem;
            }
            .header-actions .user-profile {
                margin-left: auto;
            }
             .profile-name {
                max-width: 100px;
            }
            .profile-email {
                display: none;
            }
            
            .login-container {
                flex-direction: column;
            }
            
            .login-image {
                display: none;
            }
            .login-content {
                padding: 30px 20px;
                justify-content: flex-start;
                min-height: 100vh;
            }
            .notification {
                top: 10px;
                right: 10px;
                width: calc(100% - 20px);
            }
        }

        @media (max-width: 768px) {
            body {
                font-size: 14px;
                -webkit-text-size-adjust: 100%;
            }

            .main-content {
                padding: 10px;
            }

            .card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .card-title {
                font-size: 1.1rem;
            }

            .btn {
                padding: 10px 14px;
                font-size: 0.9rem;
            }
            .btn i {
                font-size: 0.9em;
            }

            .btn-sm {
                padding: 6px 10px;
                font-size: 0.8rem;
            }

            .form-input,
            .form-select {
                padding: 12px 10px;
                font-size: 1rem;
            }

            .modal {
                width: calc(100% - 20px);
                margin: 10px;
                max-height: calc(100vh - 20px);
            }
            .modal-header {
                padding: 12px 15px;
            }
             .modal-title {
                font-size: 1.1rem;
            }
            .modal-body {
                padding: 15px;
            }

            .grid-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(183px, 1fr));
                gap: 5px;
            }

            .stat-card {
                padding: 12px;
                text-align: center;
            }
            .stat-card .stat-title {
                font-size: 0.85rem;
            }
            .stat-value {
                font-size: 1.4rem;
            }

            .month-navigation {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                margin-bottom: 15px;
                gap: 5px;
            }
            .month-nav-btn {
                font-size: 1.2rem;
                padding: 6px;
            }
            .current-month {
                font-size: 1rem;
                padding: 6px 10px;
                text-align: center;
                flex-grow: 1;
            }
            .header-actions {
                flex-wrap: wrap;
                justify-content: flex-end;
            }

            .header-actions .toggle-switch-container {
                width: 100%;
                display: flex;
                justify-content: center;
                margin-bottom: 10px;
                order: -1; /* Alterado para manter o toggle no topo em mobile */
            }

            .chart-container {
                height: 220px;
            }
            
            .form-row-inline {
                flex-direction: column;
                gap: 0;
            }
             .form-row-inline > .form-row {
                margin-bottom: 15px;
            }
            .form-row-inline > .form-row:last-child {
                margin-bottom: 0;
            }
            
            .transaction-item, .card-bill-group {
                flex-direction: row;
                align-items: flex-start;
                padding: 10px;
            }

            .transaction-item .transaction-info,
            .card-bill-group .transaction-info {
                margin-bottom: 10px;
                width: 100%;
            }
            .transaction-item .transaction-icon,
            .card-bill-group .transaction-icon {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }
             .transaction-item .transaction-details,
             .card-bill-group .transaction-details {
                gap: 2px;
            }
            .transaction-item .transaction-name,
            .card-bill-group .transaction-name {
                font-size: 0.9rem;
            }
             .transaction-item .transaction-category,
             .card-bill-group .transaction-category {
                font-size: 0.75rem;
            }

            .transaction-item > div:last-child:not(.transaction-info),
            .card-bill-header > div:last-child:not(.transaction-info) { /* Ajustado para card-bill-header também */
                 display: flex;
                justify-content: flex-end;
                align-items: center;
                margin-top: 5px;
				flex-wrap: wrap;
            }
            
            .transaction-item .transaction-amount,
            .card-bill-header .transaction-amount {
                font-size: 0.95rem;
            }

            .transaction-item .transaction-actions,
            .card-bill-group .transaction-actions {
                opacity: 1;
                gap: 10px;
            }
            .transaction-item .action-btn,
            .card-bill-group .action-btn {
                padding: 7px;
                font-size: 0.9rem;
            }

             .toggle-completed {
                width: 36px;
                height: 18px;
                margin-right: 5px;
            }
            .toggle-completed-slider:before {
                height: 12px;
                width: 12px;
                left: 3px;
                bottom: 3px;
            }
            input:checked + .toggle-completed-slider:before {
                transform: translateX(18px);
            }

            .day-header {
                padding: 8px 0;
                font-size: 0.85rem;
            }
            .day-date, .day-balance {
                white-space: nowrap;
            }
            
            .card-bill-body {
                padding-left: 0; /* Removido padding desnecessário */
                width: 100%;
            }
            .card-bill-body .transaction-item {
                padding: 8px;
                border: none;
                border-bottom: 1px dashed var(--border-color);
                margin-bottom: 5px;
            }
             .card-bill-body .transaction-item:last-child {
                border-bottom: none;
                margin-bottom: 0;
            }
            .card-bill-body .transaction-item:hover {
                background-color: transparent;
            }

            .card-bill-header {
                padding: 10px 12px;
                flex-wrap: wrap; 
            }
             .card-bill-title { /* Renomeado de .card-bill-header .transaction-name para consistência */
                font-size: 0.9rem;
                width: 100%;
                margin-bottom: 5px;
            }
            .card-bill-header .transaction-amount { /* Ajuste para valor da fatura */
                font-size: 0.9rem;
                width: auto; /* Para não ocupar toda a largura */
                text-align: right;
                margin-top:0; /* Reset margin-top */
            }
            .card-bill-body.active {
                max-height: none; /* Para evitar problemas de cálculo de altura em mobile */
            }
            .card-bill-content, .card-bill-footer {
                padding: 10px 12px;
            }
             .card-bill-footer .btn { /* Botões no rodapé do grupo de fatura */
                width: 100%;
                margin-top: 5px;
            }
            .card-bill-footer .btn:first-child {
                 margin-top: 0;
            }

            .emoji-picker {
                grid-template-columns: repeat(auto-fill, minmax(32px, 1fr));
                gap: 8px;
            }
            .emoji-item {
                width: 32px;
                height: 32px;
                font-size: 1.1rem;
            }

            .color-picker {
                gap: 8px;
            }
            .color-item {
                width: 28px;
                height: 28px;
            }

            .form-footer {
                padding: 12px 15px;
                gap: 8px;
                flex-direction: column; /* Empilhar botões em mobile */
            }
            .form-footer .btn {
                width: 100%;
                padding: 10px 12px;
                font-size: 0.9rem;
            }

            .settings-option {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px 0;
            }
            .settings-option > div:first-child { /* Label e descrição */
                margin-bottom: 10px;
                width: 100%;
            }
            .settings-option > div:last-child { /* Input, select, botão, toggle */
                width: 100%;
            }
            .settings-option .form-input,
            .settings-option .form-select,
            .settings-option .btn {
                width: 100%;
                max-width: none; /* Reset max-width */
            }
            .settings-option .toggle-switch {
                align-self: flex-start; /* Alinhar toggle à esquerda */
                margin-top: 5px;
            }
            .filter-box {
                flex-direction: column;
                gap: 15px;
            }
            .filter-item {
                width: 100%;
                min-width: unset;
            }
            .filter-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }

        .simulator-card {
            max-width: 700px;
            margin: 0 auto;
        }

        .simulator-result {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .result-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        @media (max-width: 768px) {
             .result-grid {
                grid-template-columns: 1fr;
            }
        }

        .result-item {
            text-align: center;
            padding: 15px;
            background-color: rgba(99, 102, 241, 0.05);
            border-radius: var(--border-radius);
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
         @media (max-width: 768px) {
            .result-value {
                font-size: 1.3rem;
            }
        }

        .result-label {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .upgrade-banner {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .upgrade-content {
            position: relative;
            z-index: 1;
        }

        .upgrade-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .upgrade-features {
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .feature-icon {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .upgrade-banner::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(30%, -30%);
            z-index: 0;
        }

        .upgrade-banner::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-30%, 30%);
            z-index: 0;
        }
        @media (max-width: 768px) {
            .upgrade-title {
                font-size: 1.1rem;
            }
            .upgrade-banner {
                padding: 15px;
            }
            .upgrade-banner .btn {
                width: 100%;
                padding: 10px;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-right: 10px; /* Ajustado para margin-right para botões com texto */
        }
        .btn .loading-spinner {
             border: 2px solid rgba(255, 255, 255, 0.3); /* Garantir consistência */
             border-top-color: white; /* Garantir consistência */
        }
        .btn-outlined .loading-spinner {
             border: 2px solid var(--text-light); /* Cor para modo outlined */
             border-top-color: var(--primary-color); /* Cor para modo outlined */
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Estilos adaptativos para modal de upgrade */
        .upgrade-plan-card {
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .upgrade-plan-basic {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 2px solid transparent;
        }
        
        .upgrade-plan-essential {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 2px solid transparent;
        }
        
        .upgrade-plan-complete {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border: 2px solid #60a5fa;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
        }
        
        /* Tema claro - adaptações */
        [data-theme="light"] .upgrade-plan-basic,
        :not([data-theme="dark"]) .upgrade-plan-basic {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #e2e8f0;
        }
        
        [data-theme="light"] .upgrade-plan-essential,
        :not([data-theme="dark"]) .upgrade-plan-essential {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #e2e8f0;
        }
        
        [data-theme="light"] .upgrade-plan-complete,
        :not([data-theme="dark"]) .upgrade-plan-complete {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #3b82f6;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.2);
        }
        
        .upgrade-plan-text {
            color: white;
        }
        
        .upgrade-plan-text-muted {
            color: #94a3b8;
        }
        
        .upgrade-plan-text-complete {
            color: white;
        }
        
        .upgrade-plan-text-complete-muted {
            color: #bfdbfe;
        }
        
        /* Tema claro - cores de texto */
        [data-theme="light"] .upgrade-plan-text,
        :not([data-theme="dark"]) .upgrade-plan-text {
            color: #1e293b;
        }
        
        [data-theme="light"] .upgrade-plan-text-muted,
        :not([data-theme="dark"]) .upgrade-plan-text-muted {
            color: #64748b;
        }
        
        [data-theme="light"] .upgrade-plan-text-complete,
        :not([data-theme="dark"]) .upgrade-plan-text-complete {
            color: #1e40af;
        }
        
        [data-theme="light"] .upgrade-plan-text-complete-muted,
        :not([data-theme="dark"]) .upgrade-plan-text-complete-muted {
            color: #3b82f6;
        }
        
        .upgrade-plan-divider {
            border-bottom: 1px solid #475569;
        }
        
        .upgrade-plan-divider-complete {
            border-bottom: 1px solid #60a5fa;
        }
        
        [data-theme="light"] .upgrade-plan-divider,
        :not([data-theme="dark"]) .upgrade-plan-divider {
            border-bottom: 1px solid #cbd5e1;
        }
        
        [data-theme="light"] .upgrade-plan-divider-complete,
        :not([data-theme="dark"]) .upgrade-plan-divider-complete {
            border-bottom: 1px solid #93c5fd;
        }
        
        .card-bill-group {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }
        .card-bill-group.invoice-group-pending-preview {
            opacity: 0.6;
        }

        .card-bill-header {
            padding: 12px 15px;
            background-color: rgba(99, 102, 241, 0.05); /* Leve destaque */
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative; /* Para posicionamento de elementos filhos se necessário */
        }
        .card-bill-header .transaction-info {
             margin-bottom: 0; /* Reset margin-bottom */
        }

        .card-bill-title { /* Nome da fatura */
            font-weight: 500;
            display: flex; /* Para alinhar ícone e texto se houver */
            align-items: center;
            gap: 10px;
        }
        
        .card-bill-icon-toggle { /* Ícone de expandir/recolher */
            font-size: 0.8rem;
            transition: var(--transition);
            margin-left: auto; /* Empurrar para a direita */
            padding: 5px; /* Área de clique maior */
        }
        
        .card-bill-header.active .card-bill-icon-toggle {
            transform: rotate(180deg);
        }
        
        .card-bill-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .card-bill-body.active {
            max-height: 1000px; /* Um valor alto para acomodar o conteúdo */
        }
        
        .card-bill-content {
            padding: 0px 15px 10px 15px; /* Ajustado padding */
        }
         .card-bill-content .transaction-item {
            border-left: 3px solid var(--warning-color); /* Destaque visual para itens da fatura */
            margin-left: 10px; /* Leve indentação */
            padding: 8px 10px;
            font-size: 0.9em; /* Ligeiramente menor */
        }
        .card-bill-content .transaction-item .transaction-icon {
            width: 28px;
            height: 28px;
            font-size: 0.9rem;
        }
        
        .card-bill-footer {
            padding: 12px 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between; /* Padrão para desktop */
            align-items: center;
            flex-wrap: wrap; /* Permitir quebra em mobile */
            gap: 10px; /* Espaçamento entre botões/status */
        }
        
        .status-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 10px; /* Espaçamento se estiver ao lado do nome */
            vertical-align: middle; /* Alinhamento vertical */
        }
        
        .status-paid {
            background-color: var(--secondary-color);
            color: white;
        }
        .status-paid i { /* Ícone dentro da tag */
            margin-right: 4px;
        }
        
        .filter-box {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .filter-item {
            flex: 1;
            min-width: 150px; /* Largura mínima para cada filtro */
        }
        
        .filter-label {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 5px;
            display: block; /* Para ocupar a linha inteira */
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: center; /* Alinhar botões de ordenação */
        }
        
        .sort-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .opacity-50 {
            opacity: 0.5;
        }
        
        .filter-toggle-icon {
            margin-left: 8px;
            cursor: pointer;
            color: var(--text-light);
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .filter-toggle-icon:hover {
            color: var(--primary-color);
        }

        .toggle-completed {
            position: relative;
            display: inline-block;
            width: 40px; 
            height: 20px;
            margin-right: 8px; /* Espaçamento do toggle */
        }

        .toggle-completed input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-completed-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-completed-slider:before {
            position: absolute;
            content: "";
            height: 14px; 
            width: 14px;
            left: 3px;  
            bottom: 3px; 
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-completed-slider {
            background-color: var(--secondary-color); /* Cor quando checado */
        }

        input:checked + .toggle-completed-slider:before {
            transform: translateX(20px); /* Deslocamento do círculo */
        }

    </style>

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="financasgo-completo-7a3240bf">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="./assets/icon-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./assets/icon-512x512.png">
</head>
<body>
    <div id="app">
  <div style="max-width:560px;margin:48px auto;padding:18px;border-radius:12px;background:rgba(0,0,0,0.06);font-family:Poppins,Arial,sans-serif;">    <div style="font-weight:700;font-size:18px;margin-bottom:6px;">Carregando…</div>    <div style="opacity:.8;font-size:14px;">Se ficar nessa tela, tem algo impedindo a inicialização.</div>  </div>
</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        
        class FinanceApp {
            constructor() {
                this.dbManager = new IndexedDBManager('FinancasGO_Universal');
                this.currentView = null;
                
                this.PLAN_CONFIG = 'completo';
                
                this.CHECKOUT_LINKS = {
                    essencial: 'https://pay.metodogo.com/1/checkout-financasgo-plano-master',
                    completo: 'https://pay.metodogo.com/1/checkout-financasgo-plano-master-up'
                };
                
                this.user = null;
                this.licenseInfo = null;
                this.isPreviewMode = this.isFeatureAvailable('preview_mode'); 
                this.darkMode = false;
                this.currentMonth = new Date().getMonth();
                this.currentYear = new Date().getFullYear();
                this.transactionsSortOrder = 'asc'; 
                this.selectedFilterAccount = 'all';
                this.customDateFilterEnabled = false;
                this.customDateStart = null;
                this.customDateEnd = null; 
                this.data = { transactions: [], categories: { income: [], expense: [] }, accounts: [], cards: [] };
                this.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                this.timezoneOffset = new Date().getTimezoneOffset(); 
                this.usePreviousMonthBalance = true; 
                this.paidCardInvoices = [];
                this.transactionFilters = { type: 'all', category: 'all', account: 'all' };
                this.defaultData = {
    categories: { 
        income: [], 
        expense: []
    },
    accounts: [],
    cards: []
};
                this.licenseKeys = { 
    completo: { 'lifetime': '6ba7b814-9dad-11d1-80b4-00c04fd430c8' }
};
this.planType = 'completo';
                this.upgradePlanURL = "https://www.seusite.com/checkout?plan=complete"; // URL PLANO UPGRADE
                this.emojiList = [  '💰', '💵', '💳', '📈', '📉', '💹', '💸', '🏦', '🏠', '🏢', '🔧', '🧹', '🛋️', '⚡', '💧', '🔥', '📶', '📱', '🚗', '🚕', '🚌', '⛽', '🚲', '✈️',  '🛒', '👕', '👞', '🧴', '🛍️',  '🍔', '🍝', '☕', '🍲', '🍺',  '🎬', '🎮', '📚', '🎭', '🎵', '🏖️', '💊', '🏥', '🦷', '👓', '🧠',  '🏋️', '🧘', '🏃', '💆', '🥗', '💼', '📊', '🖥️', '👔', '🚕', '🎓', '📚', '📝', '💻', '🔬',  '👤', '👨', '👩', '👨‍👩‍👧', '🐱', '🤖', '👑',  '📆', '🔄', '🕒', '🎁', '💫', '🎯', '💰', '🏠', '🚗', '💍', '🌴' ];
                this.colorList = ['#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16', '#10b981', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e'];
                this.timezoneList = [ { value: -12, label: '(UTC-12:00) International Date Line West' }, { value: -11, label: '(UTC-11:00) Coordinated Universal Time-11' }, { value: -10, label: '(UTC-10:00) Hawaii' }, { value: -9, label: '(UTC-09:00) Alaska' }, { value: -8, label: '(UTC-08:00) Pacific Time (US & Canada)' }, { value: -7, label: '(UTC-07:00) Mountain Time (US & Canada)' }, { value: -6, label: '(UTC-06:00) Central Time (US & Canada)' }, { value: -5, label: '(UTC-05:00) Eastern Time (US & Canada)' }, { value: -4, label: '(UTC-04:00) Atlantic Time (Canada)' }, { value: -3, label: '(UTC-03:00) Brasilia' }, { value: -2, label: '(UTC-02:00) Mid-Atlantic' }, { value: -1, label: '(UTC-01:00) Azores' }, { value: 0, label: '(UTC+00:00) London, Dublin, Edinburgh' }, { value: 1, label: '(UTC+01:00) Berlin, Paris, Madrid' }, { value: 2, label: '(UTC+02:00) Athens, Istanbul, Helsinki' }, { value: 3, label: '(UTC+03:00) Moscow, St. Petersburg' }, { value: 4, label: '(UTC+04:00) Dubai, Abu Dhabi' }, { value: 5, label: '(UTC+05:00) Islamabad, Karachi' }, { value: 5.5, label: '(UTC+05:30) New Delhi, Mumbai' }, { value: 6, label: '(UTC+06:00) Dhaka' }, { value: 7, label: '(UTC+07:00) Bangkok, Jakarta' }, { value: 8, label: '(UTC+08:00) Beijing, Hong Kong, Singapore' }, { value: 9, label: '(UTC+09:00) Tokyo, Seoul' }, { value: 9.5, label: '(UTC+09:30) Adelaide' }, { value: 10, label: '(UTC+10:00) Sydney, Melbourne' }, { value: 11, label: '(UTC+11:00) Vladivostok' }, { value: 12, label: '(UTC+12:00) Auckland, Wellington' } ];
                this.app = document.getElementById('app');
                this.init();
            }
            
async init() {
    try {
        this.notificationSystem = new NotificationSystem();
        
        if (!window.indexedDB) {
            console.warn("Seu navegador não suporta IndexedDB. Usando localStorage como fallback.");
            this.notificationSystem.show(
                'Compatibilidade do Navegador', 
                'Seu navegador não suporta armazenamento avançado. A aplicação funcionará com limitações de armazenamento.', 
                'warning', 
                8000
            );
            await this.initWithLocalStorage();
            return;
        }
        
        await this.dbManager.ready();
        await this.migrateOldDatabases();
        const dataFromIDB = await this.dbManager.loadData('finance_data');
        
        if (!dataFromIDB) {
            await this.migrateDataFromLocalStorage();
        }
        
        await this.loadData();
        
        this.user = await this.loadFromStorage('finance_user');
        this.licenseInfo = await this.loadFromStorage('finance_license');
        
        if (!this.user || !this.licenseInfo) {
            await this.initializeTrial();
        }
        
        if (!await this.checkTrialAndLicenseStatus()) {
            this.showTrialExpiredModal();
            return;
        }
        
        this.darkMode = (await this.loadFromStorage('finance_darkmode')) || false;
        
        if (this.darkMode) {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
        
        const savedTimezoneOffsetInMinutes = await this.loadFromStorage('finance_timezone_offset');
        if (savedTimezoneOffsetInMinutes !== null) {
            this.timezoneOffset = savedTimezoneOffsetInMinutes;
        } else {
            this.timezoneOffset = new Date().getTimezoneOffset();
            await this.saveToStorage('finance_timezone_offset', this.timezoneOffset);
        }
        
        const usePrevMonth = await this.loadFromStorage('finance_use_prev_month');
        if (usePrevMonth === true || usePrevMonth === false) {
            this.usePreviousMonthBalance = usePrevMonth;
            console.log(`Configuração carregada: usePreviousMonthBalance = ${usePrevMonth}`);
        } else {
            console.log(`Nenhuma configuração encontrada, usando padrão: usePreviousMonthBalance = ${this.usePreviousMonthBalance}`);
            await this.saveToStorage('finance_use_prev_month', this.usePreviousMonthBalance);
        }
        
        const paidInvoices = await this.loadFromStorage('finance_paid_invoices');
        if (paidInvoices) {
            this.paidCardInvoices = paidInvoices;
        }
        
        const savedSortOrder = await this.loadFromStorage('finance_sort_order');
        if (savedSortOrder) {
            this.transactionsSortOrder = savedSortOrder;
        }
        
        this.renderMainApp();
        this.navigate('dashboard');
        this.setupBackupReminder();
        
    } catch (error) {
        console.error("Erro ao inicializar a aplicação:", error);
        this.notificationSystem.show(
            'Erro ao Inicializar', 
            'Ocorreu um erro ao carregar seus dados. Tente recarregar a página.', 
            'error', 
            10000
        );
        
        await this.initWithLocalStorage();
    }
}

async initWithLocalStorage() {
    if (!this.notificationSystem) {
        this.notificationSystem = new NotificationSystem();
    }
    
    const savedData = this.loadFromStorageSync('finance_data');
    if (savedData) {
        this.data = savedData;
        if (!this.data.transactions) this.data.transactions = [];
        if (!this.data.categories) this.data.categories = { income: [], expense: [] };
        if (!this.data.categories.income) this.data.categories.income = [];
        if (!this.data.categories.expense) this.data.categories.expense = [];
        if (!this.data.accounts) this.data.accounts = [];
        if (!this.data.cards) this.data.cards = [];
        
        let needsUpdate = false;
        
        if (this.data.cards && Array.isArray(this.data.cards)) {
            this.data.cards.forEach(card => {
                if (!card.account && this.data.accounts && this.data.accounts.length > 0) {
                    card.account = this.data.accounts[0].id;
                    needsUpdate = true;
                } else if (!card.account && (!this.data.accounts || this.data.accounts.length === 0)) {
                    card.account = null;
                    needsUpdate = true;
                }
            });
        }
        
        if (needsUpdate) {
            localStorage.setItem('finance_data', JSON.stringify(this.data));
        }
    } else {
        this.data = {
            categories: JSON.parse(JSON.stringify(this.defaultData.categories)),
            accounts: JSON.parse(JSON.stringify(this.defaultData.accounts)),
            cards: JSON.parse(JSON.stringify(this.defaultData.cards)),
            transactions: []
        };
        localStorage.setItem('finance_data', JSON.stringify(this.data));
    }
    
    this.user = this.loadFromStorageSync('finance_user');
    this.licenseInfo = this.loadFromStorageSync('finance_license');
    
    if (!this.user || !this.licenseInfo) {
        this.initializeTrialSync();
    }
    
    // Verificar trial status
    if (!this.checkTrialAndLicenseStatusSync()) {
        this.showTrialExpiredModal();
        return;
    }
    
    this.darkMode = this.loadFromStorageSync('finance_darkmode') || false;
    
    if (this.darkMode) {
        document.documentElement.setAttribute('data-theme', 'dark');
    }
    
    const savedTimezoneOffsetInMinutes = this.loadFromStorageSync('finance_timezone_offset');
    if (savedTimezoneOffsetInMinutes !== null) {
        this.timezoneOffset = savedTimezoneOffsetInMinutes;
    } else {
        this.timezoneOffset = new Date().getTimezoneOffset();
        localStorage.setItem('finance_timezone_offset', JSON.stringify(this.timezoneOffset));
    }
    
    const usePrevMonth = this.loadFromStorageSync('finance_use_prev_month');
    if (usePrevMonth === true || usePrevMonth === false) {
        this.usePreviousMonthBalance = usePrevMonth;
        console.log(`Configuração carregada (sync): usePreviousMonthBalance = ${usePrevMonth}`);
    } else {
        console.log(`Nenhuma configuração encontrada (sync), usando padrão: usePreviousMonthBalance = ${this.usePreviousMonthBalance}`);
        localStorage.setItem('finance_use_prev_month', JSON.stringify(this.usePreviousMonthBalance));
    }
    
    const paidInvoices = this.loadFromStorageSync('finance_paid_invoices');
    if (paidInvoices) {
        this.paidCardInvoices = paidInvoices;
    }
    
    this.renderMainApp();
    this.navigate('dashboard');
    this.setupBackupReminder();
}

async initializeTrial() {
    const currentDate = new Date();
    const trialData = {
        startDate: currentDate.toISOString(),
        endDate: new Date(currentDate.getTime() + (7 * 24 * 60 * 60 * 1000)).toISOString(),
        browserFingerprint: this.generateBrowserFingerprint(),
        installId: this.generateId(),
        accessCount: 1
    };
    
    // Criar usuário automático
    this.user = { 
        name: '', 
        email: '', 
        emoji: '👤' 
    };
    
    // Criar licença de trial
    this.licenseInfo = { 
        key: 'TRIAL', 
        type: 'trial', 
        validity: '7days', 
        activationDate: currentDate.toISOString(),
        isTrialActive: true,
        trialData: trialData
    };
    
    // Salvar dados de controle em múltiplas chaves para dificultar bypass
    await this.saveToStorage('finance_user', this.user);
    await this.saveToStorage('finance_license', this.licenseInfo);
    await this.saveToStorage('finance_trial_control', trialData);
    await this.saveToStorage('finance_install_id', trialData.installId);
    await this.saveToStorage('finance_trial_start', trialData.startDate);
    
    this.notificationSystem.show(
        'Bem-vindo ao Minhas Finanças', 
        'Parabéns pela sua compra! Você tem acesso completo!', 
        'success', 
        10000
    );
}

generateBrowserFingerprint() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('Minhas Finanças Fingerprint', 2, 2);
    
    const fingerprint = {
        canvas: canvas.toDataURL(),
        userAgent: navigator.userAgent,
        language: navigator.language,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        screen: `${screen.width}x${screen.height}x${screen.colorDepth}`,
        timestamp: Date.now()
    };
    
    return btoa(JSON.stringify(fingerprint));
}

async checkTrialAndLicenseStatus() {
    if (!this.licenseInfo) return false;
    
    // Se não for trial, verificar chave de licença
    if (this.licenseInfo.key !== 'TRIAL') {
        return this.validateLicense(this.licenseInfo.key);
    }
    
    // Verificar trial
    const currentDate = new Date();
    const trialControl = await this.loadFromStorage('finance_trial_control');
    const installId = await this.loadFromStorage('finance_install_id');
    const trialStart = await this.loadFromStorage('finance_trial_start');
    
    // Verificações de integridade
    if (!trialControl || !installId || !trialStart) {
        return false;
    }
    
    if (trialControl.installId !== installId) {
        return false;
    }
    
    if (trialControl.startDate !== trialStart) {
        return false;
    }
    
    const endDate = new Date(trialControl.endDate);
    
    // Verificar se o trial expirou
    if (currentDate > endDate) {
        this.licenseInfo.isTrialActive = false;
        await this.saveToStorage('finance_license', this.licenseInfo);
        return false;
    }
    
    // Atualizar contador de acesso
    trialControl.accessCount = (trialControl.accessCount || 0) + 1;
    await this.saveToStorage('finance_trial_control', trialControl);
    
    return true;
}

initializeTrialSync() {
    const currentDate = new Date();
    const trialData = {
        startDate: currentDate.toISOString(),
        endDate: new Date(currentDate.getTime() + (7 * 24 * 60 * 60 * 1000)).toISOString(),
        browserFingerprint: this.generateBrowserFingerprint(),
        installId: this.generateId(),
        accessCount: 1
    };
    
    // Criar usuário automático
    this.user = { 
        name: '', 
        email: '', 
        emoji: '👤' 
    };
    
    // Criar licença de trial
    this.licenseInfo = { 
        key: 'TRIAL', 
        type: 'trial', 
        validity: '7days', 
        activationDate: currentDate.toISOString(),
        isTrialActive: true,
        trialData: trialData
    };
    
    // Salvar dados de controle em múltiplas chaves para dificultar bypass
    localStorage.setItem('finance_user', JSON.stringify(this.user));
    localStorage.setItem('finance_license', JSON.stringify(this.licenseInfo));
    localStorage.setItem('finance_trial_control', JSON.stringify(trialData));
    localStorage.setItem('finance_install_id', JSON.stringify(trialData.installId));
    localStorage.setItem('finance_trial_start', JSON.stringify(trialData.startDate));
    
    this.notificationSystem.show(
        'Bem-vindo ao Minhas Finanças', 
        'Parabéns pela sua compra! Você terá acesso completo por 7 dias, após este período receberá sua chave vitalícia na área de membros.', 
        'success', 
        10000
    );
}

checkTrialAndLicenseStatusSync() {
    if (!this.licenseInfo) return false;
    
    // Se não for trial, verificar chave de licença
    if (this.licenseInfo.key !== 'TRIAL') {
        return this.validateLicense(this.licenseInfo.key);
    }
    
    // Verificar trial
    const currentDate = new Date();
    const trialControl = this.loadFromStorageSync('finance_trial_control');
    const installId = this.loadFromStorageSync('finance_install_id');
    const trialStart = this.loadFromStorageSync('finance_trial_start');
    
    // Verificações de integridade
    if (!trialControl || !installId || !trialStart) {
        return false;
    }
    
    if (trialControl.installId !== installId) {
        return false;
    }
    
    if (trialControl.startDate !== trialStart) {
        return false;
    }
    
    const endDate = new Date(trialControl.endDate);
    
    // Verificar se o trial expirou
    if (currentDate > endDate) {
        this.licenseInfo.isTrialActive = false;
        localStorage.setItem('finance_license', JSON.stringify(this.licenseInfo));
        return false;
    }
    
    // Atualizar contador de acesso
    trialControl.accessCount = (trialControl.accessCount || 0) + 1;
    localStorage.setItem('finance_trial_control', JSON.stringify(trialControl));
    
    return true;
}
            
           async loadData() {
    try {
        const savedData = await this.loadFromStorage('finance_data');
        if (savedData) {
            this.data = savedData;
            let needsUpdate = false;
            
            // Garantir que todos os arrays e objetos necessários existam
            if (!this.data.transactions) this.data.transactions = [];
            if (!this.data.categories) this.data.categories = { income: [], expense: [] };
            if (!this.data.categories.income) this.data.categories.income = [];
            if (!this.data.categories.expense) this.data.categories.expense = [];
            if (!this.data.accounts) this.data.accounts = [];
            if (!this.data.cards) this.data.cards = [];
            
            // Verificar cartões e associá-los a contas se necessário
            if (this.data.cards && Array.isArray(this.data.cards)) {
                this.data.cards.forEach(card => {
                    if (!card.account && this.data.accounts && this.data.accounts.length > 0) {
                        card.account = this.data.accounts[0].id; 
                        needsUpdate = true;
                    } else if (!card.account && (!this.data.accounts || this.data.accounts.length === 0)) {
                        card.account = null; 
                        needsUpdate = true;
                    }
                });
            }
            
            if (needsUpdate) {
                await this.saveData(false); 
            }
        } else {
            // Inicializar com dados padrão
            this.data = {
                categories: JSON.parse(JSON.stringify(this.defaultData.categories)),
                accounts: JSON.parse(JSON.stringify(this.defaultData.accounts)),
                cards: JSON.parse(JSON.stringify(this.defaultData.cards)),
                transactions: []
            };
            await this.saveToStorage('finance_data', this.data);
        }
    } catch (error) {
        console.error("Erro ao carregar dados:", error);
        
        // Em caso de erro, inicializar com dados vazios
        this.data = {
            transactions: [],
            categories: { income: [], expense: [] },
            accounts: [],
            cards: []
        };
    }
}
            
           async saveData(showNotification = true) {
    try {
        await this.saveToStorage('finance_data', this.data);
        return true;
    } catch (error) {
        console.error("Erro ao salvar dados:", error);
        if (this.notificationSystem && showNotification) {
            this.notificationSystem.show('Erro ao Salvar', 'Ocorreu um problema ao salvar seus dados.', 'error');
        }
        return false;
    }
}
            
           /**
            * Calcula o saldo realizado de uma conta até uma data limite.
            * Saldo realizado considera apenas transações marcadas como 'completed'.
            * Usado para verificar se há saldo suficiente para marcar uma transação como 'completed'.
            */
            calculateAccountRealizedBalance(accountId, dateLimit = null, excludeTransactionId = null) {
                const account = this.data.accounts.find(acc => acc.id === accountId);
                if (!account) return 0;
            
                let realizedBalance = account.initialBalance;
            
                const transactionsToConsider = this.data.transactions.filter(t => {
                    if (t.id === excludeTransactionId) return false; 
                    if (!t.completed) return false; 
            
                    const transactionDate = this.parseDate(t.date);
                    if (dateLimit && transactionDate > this.parseDate(dateLimit)) { 
                        return false;
                    }
            
                    if (t.type === 'income' && t.account === accountId) return true;
                    if (t.type === 'expense' && t.account === accountId) return true;
                    if (t.type === 'transfer') {
                        return t.sourceAccount === accountId || t.destAccount === accountId;
                    }
                    return false;
                }).sort((a,b) => this.parseDate(a.date) - this.parseDate(b.date)); 
            
                for (const t of transactionsToConsider) {
                    if (t.type === 'income' && t.account === accountId) {
                        realizedBalance += t.amount;
                    } else if (t.type === 'expense' && t.account === accountId) {
                        realizedBalance -= t.amount;
                    } else if (t.type === 'transfer') {
                        if (t.sourceAccount === accountId) {
                            realizedBalance -= t.amount;
                        }
                        if (t.destAccount === accountId) {
                            realizedBalance += t.amount;
                        }
                    }
                }
                return realizedBalance;
            }
			async saveToStorage(key, value) {
    try {
        // Verifica se IndexedDB está disponível através do dbManager
        if (window.indexedDB && this.dbManager && this.dbManager.isReady) {
            // Tenta salvar no IndexedDB primeiro
            await this.dbManager.saveData(key, value);
            
            // Também salva no localStorage para redundância e compatibilidade
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (lsError) {
                console.warn(`Não foi possível salvar ${key} no localStorage, mas foi salvo no IndexedDB`, lsError);
            }
        } else {
            // Fallback para localStorage se IndexedDB não estiver disponível
            localStorage.setItem(key, JSON.stringify(value));
            console.warn(`IndexedDB não disponível, usando localStorage para ${key}`);
        }
        
        // Se estamos salvando a configuração de usar saldo do mês anterior, vamos registrar isso
        if (key === 'finance_use_prev_month') {
            console.log(`Configuração 'finance_use_prev_month' salva com o valor: ${value}`);
        }
        
        return true;
    } catch (error) {
        console.error(`Erro ao salvar ${key}:`, error);
        try {
            // Tenta como último recurso salvar no localStorage
            localStorage.setItem(key, JSON.stringify(value));
            console.warn(`Fallback: ${key} salvo apenas no localStorage devido a erro no IndexedDB`);
            
            return true;
        } catch (lsError) {
            console.error(`Erro ao salvar ${key} no localStorage:`, lsError);
            if (this.notificationSystem) {
                this.notificationSystem.show('Erro de Armazenamento', 'Não foi possível salvar os dados. Verifique se o seu navegador suporta armazenamento local.', 'error');
            }
            return false;
        }
    }
}
async migrateOldDatabases() {
    try {
        console.log('Verificando bancos de dados antigos...');
        
        const oldDbNames = ['financasGoDB', 'FinancasGO', 'finançasGO'];
        
        for (const oldDbName of oldDbNames) {
            try {
                const request = indexedDB.open(oldDbName);
                
                await new Promise((resolve, reject) => {
                    request.onsuccess = async (event) => {
                        const oldDb = event.target.result;
                        
                        if (oldDb.objectStoreNames.contains('appData')) {
                            console.log(`Migrando dados de ${oldDbName}...`);
                            
                            const transaction = oldDb.transaction(['appData'], 'readonly');
                            const store = transaction.objectStore('appData');
                            const getAllRequest = store.getAll();
                            
                            getAllRequest.onsuccess = async () => {
                                const oldData = getAllRequest.result;
                                
                                for (const item of oldData) {
                                    // Verificar se item.key existe e não é undefined
                                    if (item && item.key && item.key !== undefined) {
                                        await this.dbManager.saveData(item.key, item.value);
                                    }
                                }
                                
                                console.log(`Migração de ${oldDbName} concluída!`);
                                oldDb.close();
                                
                                const deleteRequest = indexedDB.deleteDatabase(oldDbName);
                                deleteRequest.onsuccess = () => {
                                    console.log(`Banco antigo ${oldDbName} removido.`);
                                };
                            };
                        }
                        
                        oldDb.close();
                        resolve();
                    };
                    
                    request.onerror = () => resolve(); // Ignora erros (banco não existe)
                });
                
            } catch (error) {
                console.log(`Banco ${oldDbName} não encontrado ou erro ao migrar:`, error);
            }
        }
        
    } catch (error) {
        console.error('Erro durante migração:', error);
    }
}
            async loadFromStorage(key) {
    try {
        // Verifica se IndexedDB está disponível e inicializado
        if (window.indexedDB && this.dbManager && this.dbManager.isReady) {
            // Tenta carregar do IndexedDB primeiro
            const data = await this.dbManager.loadData(key);
            
            // Se o valor existir no IndexedDB, retorna-o
            if (data !== undefined) {
                // Verifica se existe um valor diferente no localStorage que precisa ser sincronizado
                try {
                    const lsItem = localStorage.getItem(key);
                    if (lsItem !== null) {
                        const parsedLsItem = JSON.parse(lsItem);
                        // Se os valores forem diferentes, atualiza o localStorage
                        if (JSON.stringify(data) !== JSON.stringify(parsedLsItem)) {
                            localStorage.setItem(key, JSON.stringify(data));
                            console.log(`LocalStorage sincronizado com IndexedDB para ${key}`);
                        }
                    }
                } catch (syncError) {
                    console.warn(`Não foi possível sincronizar ${key} ao localStorage`, syncError);
                }
                
                return data;
            }
            
            // Se não existir no IndexedDB, tenta buscar do localStorage
            const lsItem = localStorage.getItem(key);
            if (lsItem !== null) {
                const parsedItem = JSON.parse(lsItem);
                // Salva no IndexedDB para sincronizar
                await this.dbManager.saveData(key, parsedItem);
                console.log(`Migrado ${key} do localStorage para IndexedDB`);
                return parsedItem;
            }
            
            return null;
        } else {
            // Fallback para localStorage se IndexedDB não estiver disponível
            console.warn(`IndexedDB não disponível, usando localStorage para carregar ${key}`);
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : null;
        }
    } catch (error) {
        console.error(`Erro ao carregar ${key} do IndexedDB:`, error);
        
        try {
            console.warn(`Tentando fallback para localStorage para ${key}`);
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : null;
        } catch (lsError) {
            console.error(`Erro ao carregar ${key} do localStorage:`, lsError);
            return null;
        }
    }
}

loadFromStorageSync(key) {
    // Este método só pode carregar do localStorage de forma síncrona
    // IndexedDB é sempre assíncrono, então não podemos usá-lo aqui
    try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : null;
    } catch (error) {
        console.error(`Erro ao carregar ${key} do localStorage de forma síncrona:`, error);
        return null;
    }
}

async migrateDataFromLocalStorage() {
    try {
        // Mostrar uma mensagem informando que a migração está em andamento
        this.notificationSystem.show(
            'Migração de Dados', 
            'Migrando seus dados para o novo sistema de armazenamento. Isso pode levar alguns instantes...', 
            'info',
            3000
        );
        
        const migratedData = await this.dbManager.migrateFromLocalStorage();
        console.log('Dados migrados com sucesso:', Object.keys(migratedData));
        
        if (Object.keys(migratedData).length > 0) {
            // Verificação adicional de dados migrados
            let migratedItemsCount = 0;
            for (const key in migratedData) {
                if (migratedData[key] !== null && migratedData[key] !== undefined) {
                    migratedItemsCount++;
                }
            }
            
            if (migratedItemsCount > 0) {
                this.notificationSystem.show(
                    'Dados Migrados', 
                    `${migratedItemsCount} itens foram migrados com sucesso para o novo sistema de banco de dados.`, 
                    'success',
                    5000
                );
            }
        }
        return true;
    } catch (error) {
        console.error('Erro durante a migração de dados:', error);
        this.notificationSystem.show(
            'Erro na Migração', 
            'Ocorreu um erro ao migrar seus dados. Alguns dados podem não estar disponíveis. A aplicação continuará usando localStorage como fallback.', 
            'error',
            10000
        );
        return false;
    }
}

setupBackupReminder() {
    const exibirNotificacao = () => {
        if (this.notificationSystem && typeof this.notificationSystem.show === 'function' && this.user && this.isFeatureAvailable('import_export')) { 
            this.notificationSystem.show(
                'Lembrete de backup',
                'Faça um backup dos seus dados para evitar perdas! (Configurações > Exportar)',
                'warning',
                15000 
            );
        }
    };
    
    setTimeout(exibirNotificacao, 30 * 1000); 
    setInterval(exibirNotificacao, 30 * 60 * 1000); 
}
            validateLicense(key) {
    // Verificar se é trial
    if (key === 'TRIAL') {
        if (this.licenseInfo && this.licenseInfo.activationDate) {
            const activationDate = new Date(this.licenseInfo.activationDate);
            const currentDate = new Date();
            const expirationDate = new Date(activationDate);
            expirationDate.setDate(expirationDate.getDate() + 7);
            
            if (currentDate > expirationDate) {
                this.licenseInfo.isTrialActive = false;
                this.saveToStorage('finance_license', this.licenseInfo);
                return false;
            }
            return true;
        }
        return false;
    }
    
    // Verificar chaves de licença normais
    let isValid = false;
    let licenseType = '';
    let licenseValidity = '';
    
    for (const type in this.licenseKeys) {
        for (const validity in this.licenseKeys[type]) {
            if (this.licenseKeys[type][validity] === key) {
                isValid = true;
                licenseType = type;
                licenseValidity = validity;
                break;
            }
        }
        if (isValid) break;
    }
    
    return isValid;
}

            isFeatureAvailable(feature) {
    const activePlan = this.PLAN_CONFIG;
    
    // Baseado EXATAMENTE na imagem dos planos
    switch(feature) {
        case 'cards':
            // Básico: Sem cartão | Essencial: 3 cartões | Completo: Ilimitado
            return activePlan === 'essencial' || activePlan === 'completo';
            
        case 'preview_mode':
            // Básico: ❌ | Essencial: ✅ | Completo: ✅
            return activePlan === 'essencial' || activePlan === 'completo';
            
        case 'transfers':
            // Básico: ❌ | Essencial: ❌ | Completo: ✅
            return activePlan === 'completo';
            
        case 'auto_installments':
            // Básico: ❌ | Essencial: ✅ | Completo: ✅
            return activePlan === 'essencial' || activePlan === 'completo';
            
        case 'dashboard_advanced':
            // Básico: ❌ | Essencial: ✅ | Completo: ✅
            return activePlan === 'essencial' || activePlan === 'completo';
            
        case 'simulator':
            // Básico: ❌ | Essencial: ❌ | Completo: ✅
            return activePlan === 'completo';
            
        case 'import_export':
            // Não está na imagem, então disponível para todos
            return true;
            
        default:
            // Funcionalidades não listadas estão disponíveis para todos
            return true;
    }
}
checkTrialStatus() {
    if (this.licenseInfo && this.licenseInfo.type === 'trial') {
        if (!this.validateLicense('TRIAL')) {
            // Período inicial finalizado, solicitar chave vitalícia
            this.showTrialExpiredModal();
            return false;
        }
    }
    return true;
}

showTrialExpiredModal() {
    const modalContentEl = document.getElementById('modalContent');
    if (!modalContentEl) {
        const modalHTML = `<div class="modal-overlay" id="modalOverlay"><div class="modal" id="modalContent"></div></div>`;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = `
        <div class="modal-header">
            <h3 class="modal-title">Acesso Liberado</h3>
        </div>
        <div class="modal-body">
            <div style="text-align: center; margin-bottom: 20px;">
                <i class="fas fa-key" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 15px;"></i>
                <h3 style="margin-bottom: 10px;">Período de acesso inicial finalizado</h3>
                <p>Insira sua chave vitalícia que foi enviada para a área de membros.</p>
            </div>
            <div class="form-row">
                <label class="form-label" for="trialExpiredKey">Chave Vitalícia</label>
                <input class="form-input" type="text" id="trialExpiredKey" placeholder="xxxx-xxxx-xxxx-xxxx">
            </div>
        </div>
        <div class="form-footer">
            </div>
                        `;
                    }
                }             
                    
                const periodDisplay = this.customDateFilterEnabled ? 
                    `${this.formatDate(this.parseDate(this.customDateStart))} - ${this.formatDate(this.parseDate(this.customDateEnd))}` :
                    `${this.getMonthName(this.currentMonth)} de ${this.currentYear}`;

                container.innerHTML = `
                    ${upgradeBanner}
                    ${filterInfo}
                    <div class="header-actions" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
                        ${this.customDateFilterEnabled ? 
                            `<div style="display: flex; align-items: center; gap: 10px; font-weight: 500;">
                                <span>Período: ${periodDisplay}</span>
                                </div>
        <div class="modal-body">
            ${featureBlockedText}
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin: 20px 0;">
                
                <!-- PLANO BÁSICO -->
                <div class="upgrade-plan-card upgrade-plan-basic" style="${currentPlan === 'basico' ? 'border-color: #22d3ee;' : ''}">
                    <div style="position: absolute; top: 12px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; display: flex; align-items: center; gap: 4px;">
                        ⚠️ Para começar
                    </div>
                    
                    <div style="margin-top: 32px;">
                        <h3 class="upgrade-plan-text" style="margin-bottom: 8px; font-size: 1.5rem; font-weight: 700;">BÁSICO</h3>
                        <div class="upgrade-plan-text" style="font-size: 2.5rem; font-weight: 800; margin-bottom: 4px;">R$ 5,90</div>
                        <div class="upgrade-plan-text-muted" style="font-size: 0.9rem; margin-bottom: 24px;">Pagamento Único</div>
                    </div>
                    
                    <div style="text-align: left; margin-bottom: 24px; font-size: 0.85rem;">
                        <div class="upgrade-plan-text-muted upgrade-plan-divider" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 12px; padding-bottom: 6px;">
                            📊 Controle Financeiro
                        </div>
                        <div class="upgrade-plan-text" style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="color: #ef4444;">❌</span> Sem Cartão de crédito</div>
                        <div class="upgrade-plan-text" style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="color: #22c55e;">✅</span> 1 Conta de Banco</div>
                        <div class="upgrade-plan-text" style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;"><span style="color: #22c55e;">✅</span> 2 Categorias Personalizadas</div>
                        
                        <div class="upgrade-plan-text-muted upgrade-plan-divider" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 12px; padding-bottom: 6px;">
                            🔧 Funcionalidades
                        </div>
                        <div class="upgrade-plan-text" style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="color: #22c55e;">✅</span> Entradas e Saídas</div>
                        <div class="upgrade-plan-text" style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="color: #22c55e;">✅</span> Modo Realizado</div>
                        <div class="upgrade-plan-text" style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="color: #ef4444;">❌</span> Modo Previsto</div>
                        <div class="upgrade-plan-text" style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="color: #ef4444;">❌</span> Transferência entre contas</div>
                        <div class="upgrade-plan-text" style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;"><span style="color: #ef4444;">❌</span> Parcelamento automático</div>
                        
                        <div class="upgrade-plan-text-muted upgrade-plan-divider" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 12px; padding-bottom: 6px;">
                            🚀 Recursos Avançados
                        </div>
                        <div class="upgrade-plan-text" style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="color: #ef4444;">❌</span> Gráficos avançados</div>
                        <div class="upgrade-plan-text" style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="color: #ef4444;">❌</span> Simulador de aposentadoria</div>
                    </div>
                    
                    ${currentPlan === 'basico' ? '' : '' : '</div>
                        </form>
                        <div class="simulator-result" id="simulatorResult" style="display: none;">
                            <h4 class="result-title">Resultado da Simulação</h4>
                            <div class="result-grid">
                                <div class="result-item"><div class="result-value" id="totalInvested">R$ 0,00</div><div class="result-label">Total Investido</div></div>
                                <div class="result-item"><div class="result-value" id="totalInterest">R$ 0,00</div><div class="result-label">Juros Acumulados</div></div>
                                <div class="result-item"><div class="result-value" id="finalAmount">R$ 0,00</div><div class="result-label">Montante Final</div></div>
                                <div class="result-item"><div class="result-value" id="monthlyIncome">R$ 0,00</div><div class="result-label">Renda Mensal Estimada (Retirada 4% a.a.)</div></div>
                            </div>
                            <div style="margin-top: 20px;">
                                <h4 style="margin-bottom: 15px;">Evolução do Investimento</h4>
                                <div class="chart-container"><canvas id="investmentChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>`; 
                
                // Configurar máscaras nos campos de valor
                this.setupCurrencyMask('initialInvestment');
                this.setupCurrencyMask('monthlyInvestment');
                
                document.getElementById('calculateBtnSimulator').addEventListener('click', () => {
                    if (!this.isFeatureAvailable('simulator')) {
                        this.showUpgradeModal('simulator');
                        return;
                    }
                    this.calculateRetirement();
                }); 
            }

            calculateRetirement() { 
                const initialInvestment = this.parseValueInput(document.getElementById('initialInvestment').value) || 0; 
                const monthlyInvestment = this.parseValueInput(document.getElementById('monthlyInvestment').value) || 0; 
                const interestRate = parseFloat(document.getElementById('interestRate').value) || 0; 
                const yearsToInvest = parseInt(document.getElementById('yearsToInvest').value) || 0; 

                if (initialInvestment < 0 || monthlyInvestment < 0 || interestRate < 0 || yearsToInvest <= 0) { 
                    this.notificationSystem.show('Erro', 'Preencha todos os campos com valores válidos!', 'error'); 
                    return; 
                } 
                const monthlyRate = interestRate / 100 / 12; 
                const totalMonths = yearsToInvest * 12; 
                
                let currentTotalAmount = initialInvestment;
                let currentTotalInvested = initialInvestment; 
                
                const chartLabels = ['Ano 0'];
                const investedData = [currentTotalInvested]; 
                const totalData = [currentTotalAmount]; 
                
                for (let m = 1; m <= totalMonths; m++) { 
                    currentTotalAmount *= (1 + monthlyRate); 
                    currentTotalAmount += monthlyInvestment; 
                    currentTotalInvested += monthlyInvestment; 
                    if (m % 12 === 0) { 
                        const year = m / 12; 
                        chartLabels.push(`Ano ${year}`); 
                        investedData.push(parseFloat(currentTotalInvested.toFixed(2))); 
                        totalData.push(parseFloat(currentTotalAmount.toFixed(2))); 
                    } 
                } 
                if (totalMonths % 12 !== 0) { 
                    chartLabels.push(`Ano ${yearsToInvest}`); 
                    investedData.push(parseFloat(currentTotalInvested.toFixed(2))); 
                    totalData.push(parseFloat(currentTotalAmount.toFixed(2))); 
                } 
                
                const monthlyIncomeFromFinalAmount = currentTotalAmount * (0.04 / 12); 
                const totalInterest = currentTotalAmount - currentTotalInvested; 
                
                document.getElementById('totalInvested').textContent = `R$ ${this.formatCurrency(currentTotalInvested)}`; 
                document.getElementById('totalInterest').textContent = `R$ ${this.formatCurrency(totalInterest)}`; 
                document.getElementById('finalAmount').textContent = `R$ ${this.formatCurrency(currentTotalAmount)}`; 
                document.getElementById('monthlyIncome').textContent = `R$ ${this.formatCurrency(monthlyIncomeFromFinalAmount)}`; 
                
                document.getElementById('simulatorResult').style.display = 'block'; 
                this.createInvestmentChart(chartLabels, investedData, totalData); 
                document.getElementById('simulatorResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' }); 
            }

            createInvestmentChart(labels, investedData, totalData) { 
                const canvasElement = document.getElementById('investmentChart'); 
                if (!canvasElement) return; 
                const ctx = canvasElement.getContext('2d'); 
                if (!ctx) return; 
                
                if (window.investmentChartInstance) window.investmentChartInstance.destroy(); 
                
                window.investmentChartInstance = new Chart(ctx, { 
                    type: 'line', 
                    data: { 
                        labels: labels, 
                        datasets: [ 
                            { label: 'Total Investido', data: investedData, backgroundColor: 'rgba(99, 102, 241, 0.2)', borderColor: 'rgba(99, 102, 241, 1)', borderWidth: 2, fill: true, tension: 0.1 }, 
                            { label: 'Montante Total (com Juros)', data: totalData, backgroundColor: 'rgba(16, 185, 129, 0.2)', borderColor: 'rgba(16, 185, 129, 1)', borderWidth: 2, fill: true, tension: 0.1 } 
                        ] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        animation: { duration: 800, easing: 'easeInOutQuart' }, 
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                ticks: { 
                                    callback: value => 'R$ ' + value.toLocaleString('pt-BR'), 
                                    color: this.darkMode ? '#FFFFFF' : 'var(--text-light)' 
                                } 
                            }, 
                            x: { 
                                ticks: { 
                                    maxRotation: 0, 
                                    minRotation: 0, 
                                    autoSkip: true, 
                                    maxTicksLimit: 10, 
                                    color: this.darkMode ? '#FFFFFF' : 'var(--text-light)' 
                                } 
                            } 
                        }, 
                        plugins: { 
                            tooltip: { 
                                callbacks: { 
                                    label: context => `${context.dataset.label}: R$ ${context.raw.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` 
                                } 
                            }, 
                            legend: { 
                                position: 'top', 
                                labels: { 
                                    color: this.darkMode ? '#FFFFFF' : 'var(--text-color)' 
                                } 
                            } 
                        } 
                    } 
                }); 
            }

            navigateMonth(offset) { 
                // Não permitir navegação de mês quando filtro personalizado está ativo
                if (this.customDateFilterEnabled) {
                    this.notificationSystem.show('Aviso', 'Desative o filtro de data personalizada para navegar por meses.', 'warning');
                    return;
                }

                let newMonth = this.currentMonth + offset; 
                let newYear = this.currentYear; 
                if (newMonth < 0) { 
                    newMonth = 11; 
                    newYear--; 
                } else if (newMonth > 11) { 
                    newMonth = 0; 
                    newYear++; 
                } 
                const currentYearLimit = new Date().getFullYear(); 
                if (newYear < currentYearLimit - 20 || newYear > currentYearLimit + 20) { 
                    this.notificationSystem.show('Aviso', 'Navegação limitada a 20 anos no passado/futuro.', 'warning'); 
                    return; 
                } 
                this.currentMonth = newMonth; 
                this.currentYear = newYear; 
                this.refreshView(); 
            }

            refreshView() { 
                if (this.currentView) { 
                    this.navigate(this.currentView); 
                } 
            }

            showExportModal() {
                const modalContentEl = document.getElementById('modalContent');
                modalContentEl.innerHTML = `
                    <div class="modal-header">
                        <h3 class="modal-title">Exportar Transações</h3>
                        <button class="modal-close" id="modalCloseExport">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-row">
                            <label class="form-label">Formato de Exportação</label>
                            <select class="form-select" id="exportFormat">
                                <option value="csv">CSV (Excel)</option>
                                <option value="json">JSON</option>
                                <option value="xlsx">Excel (.xlsx)</option>
                                <option value="pdf">PDF (Relatório Formatado)</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label class="form-label">Escopo da Exportação</label>
                            <div class="form-check">
                                <input type="radio" id="exportFiltered" name="exportScope" value="filtered" checked>
                                <label for="exportFiltered">Transações Filtradas Atualmente</label>
                            </div>
                            <div class="form-check">
                                <input type="radio" id="exportAll" name="exportScope" value="all">
                                <label for="exportAll">Todas as Transações</label>
                            </div>
                        </div>
                        <div class="form-row">
                            <div style="background-color: rgba(16, 185, 129, 0.1); border: 1px solid var(--secondary-color); border-radius: var(--border-radius); padding: 12px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <i class="fas fa-info-circle" style="color: var(--secondary-color);"></i>
                                    <span style="font-weight: 500;">Informações da Exportação</span>
                                </div>
                                <div id="exportInfo" style="font-size: 0.9rem; color: var(--text-light);">
                                    Calculando...
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-footer">
                        <button class="btn btn-outlined" id="cancelExportBtn">Cancelar</button>
                        <button class="btn btn-secondary" id="confirmExportBtn">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                `;

                document.getElementById('modalOverlay').classList.add('active');
                document.getElementById('modalCloseExport').addEventListener('click', () => this.closeModal());
                document.getElementById('cancelExportBtn').addEventListener('click', () => this.closeModal());
                
                const updateExportInfo = () => {
                    const scope = document.querySelector('input[name="exportScope"]:checked').value;
                    const infoEl = document.getElementById('exportInfo');
                    
                    if (scope === 'filtered') {
                        const currentTransactions = this.getCurrentFilteredTransactions();
                        const periodText = this.customDateFilterEnabled ? 
                            `período de ${this.formatDate(this.customDateStart)} a ${this.formatDate(this.customDateEnd)}` :
                            `${this.getMonthName(this.currentMonth)} de ${this.currentYear}`;
                        
                        infoEl.innerHTML = `
                            <strong>Período:</strong> ${periodText}<br>
                            <strong>Total de transações:</strong> ${currentTransactions.length}<br>
                            <strong>Filtros ativos:</strong> ${this.hasActiveTransactionFilters() ? 'Sim' : 'Não'}
                        `;
                    } else {
                        infoEl.innerHTML = `
                            <strong>Período:</strong> Todas as transações<br>
                            <strong>Total de transações:</strong> ${this.data.transactions.length}<br>
                            <strong>Filtros:</strong> Nenhum aplicado
                        `;
                    }
                };
                
                document.querySelectorAll('input[name="exportScope"]').forEach(radio => {
                    radio.addEventListener('change', updateExportInfo);
                });
                
                updateExportInfo();
                
                document.getElementById('confirmExportBtn').addEventListener('click', () => {
                    const format = document.getElementById('exportFormat').value;
                    const scope = document.querySelector('input[name="exportScope"]:checked').value;
                    this.exportTransactions(format, scope);
                    this.closeModal();
                });
            }

            getCurrentFilteredTransactions() {
                const filterAccountId = this.hasActiveTransactionFilters() ? this.getEffectiveAccountFilter() : this.selectedFilterAccount;
                
                let transactions;
                if (this.customDateFilterEnabled) {
                    transactions = this.getCustomPeriodTransactions(this.customDateStart, this.customDateEnd, filterAccountId);
                } else {
                    const monthData = this.getMonthData(this.currentMonth, this.currentYear, filterAccountId);
                    transactions = monthData.transactionsInMonth;
                }
                
                if (this.hasActiveTransactionFilters()) {
                    transactions = transactions.filter(transaction => {
                        if (this.transactionFilters.type !== 'all' && transaction.type !== this.transactionFilters.type) {
                            return false;
                        }
                        
                        if (this.transactionFilters.category !== 'all' && transaction.category !== this.transactionFilters.category) {
                            return false;
                        }
                        
                        return true;
                    });
                }
                
                return transactions;
            }

            exportTransactions(format, scope) {
                let transactions;
                let filename;
                
                if (scope === 'filtered') {
                    transactions = this.getCurrentFilteredTransactions();
                    const periodText = this.customDateFilterEnabled ? 
                        `${this.formatDateForFilename(this.customDateStart)}_${this.formatDateForFilename(this.customDateEnd)}` :
                        `${this.getMonthName(this.currentMonth)}_${this.currentYear}`;
                    filename = `transacoes_${periodText}`;
                } else {
                    transactions = this.data.transactions;
                    filename = `transacoes_todas`;
                }
                
                const exportData = transactions.map(t => {
                    const account = this.data.accounts.find(a => a.id === t.account);
                    const card = this.data.cards.find(c => c.id === t.card);
                    
                    let category = '';
                    if (t.type === 'income') {
                        const cat = this.data.categories.income.find(c => c.id === t.category);
                        category = cat ? cat.name : '';
                    } else if (t.type === 'expense') {
                        const cat = this.data.categories.expense.find(c => c.id === t.category);
                        category = cat ? cat.name : '';
                    }
                    
                    const baseData = {
                        data: this.formatDate(this.parseDate(t.date)),
                        descricao: t.description,
                        valor: t.amount,
                        tipo: this.getTransactionTypeLabel(t.type),
                        categoria: category,
                        conta: account ? account.name : '',
                        concluida: t.completed ? 'Sim' : 'Não'
                    };
                    
                    if (t.type === 'card') {
                        baseData.cartao = card ? `${card.name} (*${card.lastDigits})` : '';
                        baseData.fatura = `${this.getMonthName(t.invoiceMonth)}/${t.invoiceYear}`;
                        if (t.installments > 1) {
                            baseData.parcela = `${t.currentInstallment}/${t.installments}`;
                        }
                    } else if (t.type === 'transfer') {
                        const sourceAccount = this.data.accounts.find(a => a.id === t.sourceAccount);
                        const destAccount = this.data.accounts.find(a => a.id === t.destAccount);
                        baseData.conta_origem = sourceAccount ? sourceAccount.name : '';
                        baseData.conta_destino = destAccount ? destAccount.name : '';
                    }
                    
                    return baseData;
                });

                if (format === 'csv') {
                    this.exportToCSV(exportData, filename);
                } else if (format === 'json') {
                    this.exportToJSON(exportData, filename);
                } else if (format === 'xlsx') {
                    this.exportToExcel(exportData, filename);
                } else if (format === 'pdf') {
                    this.exportToPDF(exportData, filename, scope);
                }
                
                this.notificationSystem.show('Sucesso', `${transactions.length} transações exportadas com sucesso!`, 'success');
            }

            getTransactionTypeLabel(type) {
                switch(type) {
                    case 'income': return 'Receita';
                    case 'expense': return 'Despesa';
                    case 'transfer': return 'Transferência';
                    case 'card': return 'Cartão';
                    default: return type;
                }
            }

            formatDateForFilename(date) {
                const d = new Date(date);
                return `${d.getDate().toString().padStart(2, '0')}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getFullYear()}`;
            }

            exportToCSV(data, filename) {
                if (data.length === 0) {
                    this.notificationSystem.show('Aviso', 'Não há dados para exportar!', 'warning');
                    return;
                }
                
                const headers = Object.keys(data[0]);
                const csvContent = [
                    headers.join(';'),
                    ...data.map(row => 
                        headers.map(header => {
                            const value = row[header] || '';
                            return `"${value.toString().replace(/"/g, '""')}"`;
                        }).join(';')
                    )
                ].join('\n');
                
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                this.downloadFile(blob, `${filename}.csv`);
            }

            exportToJSON(data, filename) {
                const jsonContent = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                this.downloadFile(blob, `${filename}.json`);
            }

            exportToExcel(data, filename) {
                if (data.length === 0) {
                    this.notificationSystem.show('Aviso', 'Não há dados para exportar!', 'warning');
                    return;
                }
                
                const headers = Object.keys(data[0]);
                let xlsContent = '<table><tr>';
                headers.forEach(header => {
                    xlsContent += `<th>${header}</th>`;
                });
                xlsContent += '</tr>';
                
                data.forEach(row => {
                    xlsContent += '<tr>';
                    headers.forEach(header => {
                        xlsContent += `<td>${row[header] || ''}</td>`;
                    });
                    xlsContent += '</tr>';
                });
                xlsContent += '</table>';
                
                const blob = new Blob([xlsContent], { type: 'application/vnd.ms-excel' });
                this.downloadFile(blob, `${filename}.xls`);
            }

            exportToPDF(data, filename, scope) {
                try {
                    if (data.length === 0) {
                        this.notificationSystem.show('Aviso', 'Não há dados para exportar!', 'warning');
                        return;
                    }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                doc.setFont('helvetica');
                doc.setFontSize(16);
                doc.setTextColor(99, 102, 241);
                doc.text('Minhas Finanças - Relatório de Transações', 20, 20);
                
                let yPosition = 35;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                const now = new Date();
                const dateText = `Gerado em: ${this.formatDate(now)} às ${now.toLocaleTimeString('pt-BR')}`;
                doc.text(String(dateText || ''), 20, yPosition);
                yPosition += 5;
                
                if (scope === 'filtered') {
                    const periodText = this.customDateFilterEnabled ? 
                        `Período: ${this.formatDate(this.customDateStart)} a ${this.formatDate(this.customDateEnd)}` :
                        `Período: ${this.getMonthName(this.currentMonth)} de ${this.currentYear}`;
                    doc.text(String(periodText || ''), 20, yPosition);
                } else {
                    doc.text('Período: Todas as transações', 20, yPosition);
                }
                yPosition += 5;
                
                doc.text(String(`Total de transações: ${data.length}` || ''), 20, yPosition);
                yPosition += 15;
                
                const headers = ['Data', 'Descrição', 'Valor', 'Tipo', 'Categoria', 'Conta'];
                const columnWidths = [25, 60, 25, 25, 40, 30];
                const startX = 20;
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.setFillColor(99, 102, 241);
                doc.setTextColor(255, 255, 255);
                doc.rect(startX, yPosition - 3, columnWidths.reduce((a, b) => a + b, 0), 6, 'F');
                
                let xPosition = startX;
                headers.forEach((header, index) => {
                    const safeHeader = String(header || '');
                    doc.text(safeHeader, xPosition + 2, yPosition);
                    xPosition += columnWidths[index];
                });
                
                yPosition += 8;
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                
                const pageHeight = 210;
                const bottomMargin = 20;
                
                data.forEach((transaction, index) => {
                    if (yPosition > pageHeight - bottomMargin) {
                        doc.addPage();
                        yPosition = 20;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.setFillColor(99, 102, 241);
                        doc.setTextColor(255, 255, 255);
                        doc.rect(startX, yPosition - 3, columnWidths.reduce((a, b) => a + b, 0), 6, 'F');
                        
                        xPosition = startX;
                        headers.forEach((header, index) => {
                            const safeHeader = String(header || '');
                            doc.text(safeHeader, xPosition + 2, yPosition);
                            xPosition += columnWidths[index];
                        });
                        yPosition += 8;
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(0, 0, 0);
                    }
                    
                    if (index % 2 === 0) {
                        doc.setFillColor(245, 245, 245);
                        doc.rect(startX, yPosition - 3, columnWidths.reduce((a, b) => a + b, 0), 6, 'F');
                    }
                    
                    const formatCurrencyValue = (value) => {
                        if (typeof this.formatCurrency === 'function') {
                            return this.formatCurrency(value);
                        }
                        return parseFloat(value || 0).toLocaleString('pt-BR', { 
                            minimumFractionDigits: 2, 
                            maximumFractionDigits: 2 
                        });
                    };
                    
                    const rowData = [
                        String(transaction.data || ''),
                        this.truncateText(String(transaction.descricao || ''), 35),
                        `R$ ${formatCurrencyValue(transaction.valor || 0)}`,
                        String(transaction.tipo || ''),
                        this.truncateText(String(transaction.categoria || ''), 25),
                        this.truncateText(String(transaction.conta || ''), 20)
                    ];
                    
                    xPosition = startX;
                    rowData.forEach((cellData, colIndex) => {
                        const safeText = String(cellData || '');
                        doc.text(safeText, xPosition + 2, yPosition);
                        xPosition += columnWidths[colIndex];
                    });
                    
                    yPosition += 6;
                });
                
                const totalIncome = data.filter(t => t.tipo === 'Receita').reduce((sum, t) => sum + parseFloat(t.valor || 0), 0);
                const totalExpense = data.filter(t => t.tipo === 'Despesa' || t.tipo === 'Cartão').reduce((sum, t) => sum + parseFloat(t.valor || 0), 0);
                const balance = totalIncome - totalExpense;
                
                yPosition += 10;
                if (yPosition > pageHeight - 40) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.text('RESUMO FINANCEIRO:', startX, yPosition);
                yPosition += 8;
                
                const formatCurrencyValue = (value) => {
                    if (typeof this.formatCurrency === 'function') {
                        return this.formatCurrency(value);
                    }
                    return parseFloat(value || 0).toLocaleString('pt-BR', { 
                        minimumFractionDigits: 2, 
                        maximumFractionDigits: 2 
                    });
                };
                
                doc.setTextColor(16, 185, 129);
                doc.text(`Total de Receitas: R$ ${formatCurrencyValue(totalIncome)}`, startX, yPosition);
                yPosition += 6;
                
                doc.setTextColor(239, 68, 68);
                doc.text(`Total de Despesas: R$ ${formatCurrencyValue(totalExpense)}`, startX, yPosition);
                yPosition += 6;
                
                if (balance >= 0) {
                    doc.setTextColor(16, 185, 129);
                } else {
                    doc.setTextColor(239, 68, 68);
                }
                doc.text(`Saldo: R$ ${formatCurrencyValue(balance)}`, startX, yPosition);
                
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(String(`Página ${i} de ${pageCount}` || ''), 250, 200);
                }
                
                doc.save(`${filename}.pdf`);
                } catch (error) {
                    console.error('Erro ao gerar PDF:', error);
                    this.notificationSystem.show('Erro', 'Erro ao gerar PDF: ' + error.message, 'error');
                }
            }

            truncateText(text, maxLength) {
                if (!text) return '';
                return text.length > maxLength ? text.substring(0, maxLength - 3) + '...' : text;
            }

            downloadFile(blob, filename) {
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }
            }

            closeModal() { 
                const modalOverlay = document.getElementById('modalOverlay'); 
                if (modalOverlay) { 
                    modalOverlay.classList.remove('active'); 
                    const modalContent = document.getElementById('modalContent'); 
                    if (modalContent) { 
                        modalContent.innerHTML = ''; 
                    } 
                } 
            }
        } 

        class NotificationSystem {
    constructor() { 
        this.container = document.getElementById('notificationContainer'); 
        this.maxVisibleNotifications = 1; // Reduzido para apenas 1 notificação visível por vez
        this.activeNotifications = [];

        if (!this.container) { 
            this.container = document.createElement('div'); 
            this.container.id = 'notificationContainer'; 
            this.container.style.position = 'fixed'; 
            this.container.style.top = '20px'; 
            this.container.style.right = '20px'; 
            this.container.style.zIndex = '2000'; 
            this.container.style.width = 'auto'; 
            this.container.style.maxWidth = '350px'; 
            document.body.appendChild(this.container); 
        } 
    }
    show(title, message, type = 'info', duration = 5000) { 
        // Fechar notificações existentes antes de mostrar uma nova
        this.activeNotifications.forEach(notification => {
            this.close(notification, true);
        });
        this.activeNotifications = [];

        const notificationId = `notification-${Date.now()}-${Math.random().toString(36).substring(2,7)}`;
        const notification = document.createElement('div'); 
        notification.className = `notification notification-${type}`; 
        notification.id = notificationId; 
        notification.innerHTML = `
            <div class="notification-icon"><i class="fas ${this.getIconClass(type)}"></i></div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close" aria-label="Fechar notificação"><i class="fas fa-times"></i></button>`; 
        
        this.container.prepend(notification); 
        this.activeNotifications.push(notification); 
        
        void notification.offsetWidth; 
        requestAnimationFrame(() => { 
            notification.classList.add('active'); 
        }); 
        
        const closeBtn = notification.querySelector('.notification-close'); 
        closeBtn.addEventListener('click', () => this.close(notification)); 
        
        if (duration > 0) { 
            setTimeout(() => this.close(notification), duration); 
        } 
        return notification; 
    }

    close(notification, immediate = false) { 
        if (!notification || !notification.parentNode) return; 
        
        this.activeNotifications = this.activeNotifications.filter(n => n.id !== notification.id);

        if (immediate) {
             if (notification.parentNode === this.container) {
                this.container.removeChild(notification);
            }
            return;
        }

        notification.classList.remove('active'); 
        
        const removeNode = () => {
            if (notification.parentNode === this.container) {
                this.container.removeChild(notification);
            }
            notification.removeEventListener('transitionend', removeNode); 
        };
        
        notification.addEventListener('transitionend', removeNode); 
        
        setTimeout(() => { 
            if (notification && notification.parentNode === this.container && !notification.classList.contains('active')) {
                 removeNode(); 
            }
        }, 500); 
    }

    getIconClass(type) { 
        switch (type) { 
            case 'success': return 'fa-check-circle'; 
            case 'error': return 'fa-times-circle'; 
            case 'warning': return 'fa-exclamation-triangle'; 
            case 'info': 
            default: return 'fa-info-circle'; 
        } 
    }
}
class IndexedDBManager {
    constructor(dbName = 'FinancasGO_Universal', version = 1) {
        this.dbName = 'FinancasGO_Universal';
        this.version = version;
        this.db = null;
        this.isReady = false;
        this.isAvailable = typeof window !== 'undefined' && window.indexedDB !== undefined;
        this._initPromise = this.isAvailable ? this._initDB() : Promise.resolve(null);
    }

    async _initDB() {
        if (!this.isAvailable) {
            console.warn("IndexedDB não está disponível neste navegador");
            return Promise.resolve(null);
        }
        
        return new Promise((resolve, reject) => {
            try {
                const request = indexedDB.open(this.dbName, this.version);

                request.onupgradeneeded = (event) => {
                    try {
                        const db = event.target.result;
                        
                        if (!db.objectStoreNames.contains('appData')) {
                            db.createObjectStore('appData');
                        }
                    } catch (error) {
                        console.error('Erro durante upgrade do IndexedDB:', error);
                        // Não rejeitamos aqui porque o onupgradeneeded pode falhar mas o banco
                        // ainda pode abrir com sucesso
                    }
                };

                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    this.isReady = true;
                    console.log('IndexedDB inicializado com sucesso');
                    
                    // Configurar manipulador de eventos para lidar com bloqueios e erros
                    this.db.onversionchange = () => {
                        this.db.close();
                        console.warn('IndexedDB atualizado em outra aba. Por favor, recarregue a página.');
                    };
                    
                    // Configurar manipulador de eventos para detectar erros no banco de dados
                    this.db.onerror = (event) => {
                        console.error('Erro no IndexedDB:', event.target.error);
                    };
                    
                    resolve(this.db);
                };

                request.onerror = (event) => {
                    console.error('Erro ao abrir IndexedDB:', event.target.error);
                    this.isAvailable = false;
                    reject(event.target.error);
                };
                
                // Tratar timeout na abertura do banco de dados (alguns navegadores podem travar)
                setTimeout(() => {
                    if (!this.isReady) {
                        console.error('Timeout ao abrir IndexedDB');
                        this.isAvailable = false;
                        reject(new Error('Timeout ao abrir IndexedDB'));
                    }
                }, 5000);
            } catch (error) {
                console.error('Erro ao inicializar IndexedDB:', error);
                this.isAvailable = false;
                reject(error);
            }
        });
    }

    async ready() {
        if (!this.isAvailable) {
            return Promise.resolve(null);
        }
        
        try {
            return await this._initPromise;
        } catch (error) {
            console.error('Falha ao inicializar IndexedDB:', error);
            this.isAvailable = false;
            return null;
        }
    }

    async saveData(key, value) {
        if (!this.isAvailable) {
            return Promise.reject(new Error('IndexedDB não está disponível'));
        }
        
        try {
            await this.ready();
            
            if (!this.db) {
                return Promise.reject(new Error('IndexedDB não está inicializado'));
            }
            
            return new Promise((resolve, reject) => {
                try {
                    const transaction = this.db.transaction(['appData'], 'readwrite');
                    const store = transaction.objectStore('appData');
                    
                    const request = store.put(value, key);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => {
                        console.error(`Erro ao salvar dados para a chave "${key}":`, event.target.error);
                        reject(event.target.error);
                    };
                    
                    // Adicionar tratamento de erros de transação
                    transaction.oncomplete = () => {
                        // Transação concluída com sucesso
                    };
                    
                    transaction.onerror = (event) => {
                        console.error(`Erro na transação ao salvar "${key}":`, event.target.error);
                        reject(event.target.error);
                    };
                    
                    transaction.onabort = (event) => {
                        console.error(`Transação abortada ao salvar "${key}":`, event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error(`Erro ao criar transação para salvar "${key}":`, error);
                    reject(error);
                }
            });
        } catch (error) {
            console.error(`Falha ao salvar dados para "${key}":`, error);
            return Promise.reject(error);
        }
    }

    async loadData(key) {
        if (!this.isAvailable) {
            return Promise.reject(new Error('IndexedDB não está disponível'));
        }
        
        try {
            await this.ready();
            
            if (!this.db) {
                return Promise.reject(new Error('IndexedDB não está inicializado'));
            }
            
            return new Promise((resolve, reject) => {
                try {
                    const transaction = this.db.transaction(['appData'], 'readonly');
                    const store = transaction.objectStore('appData');
                    
                    const request = store.get(key);
                    
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => {
                        console.error(`Erro ao carregar dados para a chave "${key}":`, event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error(`Erro ao criar transação para carregar "${key}":`, error);
                    reject(error);
                }
            });
        } catch (error) {
            console.error(`Falha ao carregar dados para "${key}":`, error);
            return Promise.reject(error);
        }
    }

    async deleteData(key) {
        if (!this.isAvailable) {
            return Promise.reject(new Error('IndexedDB não está disponível'));
        }
        
        try {
            await this.ready();
            
            if (!this.db) {
                return Promise.reject(new Error('IndexedDB não está inicializado'));
            }
            
            return new Promise((resolve, reject) => {
                try {
                    const transaction = this.db.transaction(['appData'], 'readwrite');
                    const store = transaction.objectStore('appData');
                    
                    const request = store.delete(key);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => {
                        console.error(`Erro ao excluir dados para a chave "${key}":`, event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error(`Erro ao criar transação para excluir "${key}":`, error);
                    reject(error);
                }
            });
        } catch (error) {
            console.error(`Falha ao excluir dados para "${key}":`, error);
            return Promise.reject(error);
        }
    }

    async getAllKeys() {
        if (!this.isAvailable) {
            return Promise.reject(new Error('IndexedDB não está disponível'));
        }
        
        try {
            await this.ready();
            
            if (!this.db) {
                return Promise.reject(new Error('IndexedDB não está inicializado'));
            }
            
            return new Promise((resolve, reject) => {
                try {
                    const transaction = this.db.transaction(['appData'], 'readonly');
                    const store = transaction.objectStore('appData');
                    
                    const request = store.getAllKeys();
                    
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => {
                        console.error('Erro ao obter todas as chaves:', event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error('Erro ao criar transação para obter chaves:', error);
                    reject(error);
                }
            });
        } catch (error) {
            console.error('Falha ao obter todas as chaves:', error);
            return Promise.reject(error);
        }
    }

    async clearAll() {
        if (!this.isAvailable) {
            return Promise.reject(new Error('IndexedDB não está disponível'));
        }
        
        try {
            await this.ready();
            
            if (!this.db) {
                return Promise.reject(new Error('IndexedDB não está inicializado'));
            }
            
            return new Promise((resolve, reject) => {
                try {
                    const transaction = this.db.transaction(['appData'], 'readwrite');
                    const store = transaction.objectStore('appData');
                    
                    const request = store.clear();
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => {
                        console.error('Erro ao limpar banco de dados:', event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error('Erro ao criar transação para limpar dados:', error);
                    reject(error);
                }
            });
        } catch (error) {
            console.error('Falha ao limpar todos os dados:', error);
            return Promise.reject(error);
        }
    }

    async migrateFromLocalStorage() {
        if (!this.isAvailable) {
            console.warn('IndexedDB não está disponível, migração ignorada');
            return {};
        }
        
        try {
            await this.ready();
            
            if (!this.db) {
                console.warn('IndexedDB não está inicializado, migração ignorada');
                return {};
            }
            
            const keysToMigrate = [
                'finance_data', 
                'finance_user', 
                'finance_license', 
                'finance_darkmode',
                'finance_timezone_offset',
                'finance_use_prev_month',
                'finance_paid_invoices',
                'finance_hide_upgrade_timestamp'
            ];
            
            const migratedData = {};
            
            for (const key of keysToMigrate) {
                try {
                    const data = localStorage.getItem(key);
                    if (data !== null) {
                        const parsedData = JSON.parse(data);
                        await this.saveData(key, parsedData);
                        migratedData[key] = parsedData;
                        console.log(`Migrado com sucesso: ${key}`);
                    }
                } catch (error) {
                    console.error(`Erro ao migrar chave "${key}"`, error);
                }
            }
            
            return migratedData;
        } catch (error) {
            console.error('Falha na migração de dados do localStorage:', error);
            return {};
        }
    }
}
        document.addEventListener('DOMContentLoaded', async () => {
    if (typeof Chart !== 'undefined') {
        try {
            if (!window.indexedDB) {
                console.warn("IndexedDB não é suportado neste navegador. Usando localStorage como fallback.");
                displayBrowserWarning();
            }
            
            
// ========= Verdão 2.0: Drilldown + Export =========
function _fg_escapeCsv(value){
  const s = String(value ?? '');
  if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

FinanceApp.prototype._fg_getMonthDataForCurrentView = function(){
  const filterAccountId = this.transactionFilters?.account || 'all';
  if (this.customDateFilterEnabled) {
    return this.getMonthData(this.currentMonth, this.currentYear, filterAccountId, this.customDateStart, this.customDateEnd);
  }
  return this.getMonthData(this.currentMonth, this.currentYear, filterAccountId);
};

FinanceApp.prototype.openCategoryDrilldown = function(categoryId, type){
  const monthData = this._fg_getMonthDataForCurrentView();
  const tx = (monthData.transactions || []).filter(t => t.type === type && (t.category || '') === categoryId);
  const catList = (this.data?.categories?.[type] || []);
  const cat = catList.find(c => c.id === categoryId);
  const catName = cat ? `${cat.emoji ? cat.emoji + ' ' : ''}${cat.name}` : 'Categoria';
  const typeLabel = type === 'income' ? 'Receitas' : type === 'investment' ? 'Investimentos' : type === 'transfer' ? 'Transferências' : 'Despesas';
  this.openTransactionsDrilldown(`${catName} • ${typeLabel}`, tx, { categoryId, type });
};

FinanceApp.prototype.openTransactionsDrilldown = function(title, transactions, meta = {}){
  const overlay = document.getElementById('drilldownModalOverlay');
  const closeBtn = document.getElementById('drilldownCloseBtn');
  const tbody = document.getElementById('drilldownTbody');
  const empty = document.getElementById('drilldownEmpty');
  const search = document.getElementById('drilldownSearch');
  const titleEl = document.getElementById('drilldownTitle');
  const metaEl = document.getElementById('drilldownMeta');
  const pill = document.getElementById('drilldownTotalPill');

  if(!overlay || !tbody || !search) return;

  titleEl.textContent = title;

  const periodText = this.customDateFilterEnabled && this.customDateStart && this.customDateEnd
    ? `Período: ${new Date(this.customDateStart).toLocaleDateString('pt-BR')} → ${new Date(this.customDateEnd).toLocaleDateString('pt-BR')}`
    : `Mês: ${String(this.currentMonth + 1).padStart(2,'0')}/${this.currentYear}`;

  const accountsById = new Map((this.data?.accounts || []).map(a => [a.id, a]));
  const categoriesAll = [
    ...(this.data?.categories?.expense || []),
    ...(this.data?.categories?.income || []),
    ...(this.data?.categories?.investment || []),
    ...(this.data?.categories?.transfer || [])
  ];
  const categoriesById = new Map(categoriesAll.map(c => [c.id, c]));

  const normalized = (transactions || []).map(t => {
    const d = new Date(t.date);
    const acc = accountsById.get(t.account);
    const cat = categoriesById.get(t.category);
    return {
      id: t.id,
      dateObj: d,
      date: isNaN(d) ? '' : d.toLocaleDateString('pt-BR'),
      description: t.description || '',
      account: acc ? acc.name : (t.account || ''),
      amount: Number(t.amount || 0),
      category: cat ? cat.name : ''
    };
  }).sort((a,b)=> (a.dateObj?.getTime?.()||0) - (b.dateObj?.getTime?.()||0));

  const render = (q='')=>{
    const qq = q.trim().toLowerCase();
    const list = qq ? normalized.filter(r => (r.description||'').toLowerCase().includes(qq)) : normalized;

    tbody.innerHTML = '';
    if(list.length === 0){
      empty.style.display = 'block';
    } else {
      empty.style.display = 'none';
      const frag = document.createDocumentFragment();
      list.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.description}</td>
          <td>${r.account}</td>
          <td class="amount">${r.amount.toLocaleString('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:2,maximumFractionDigits:2})}</td>
        `;
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    const total = list.reduce((s,r)=>s+r.amount,0);
    pill.textContent = `Total: ${total.toLocaleString('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:2,maximumFractionDigits:2})}`;
    metaEl.textContent = `${periodText} • Itens: ${list.length}`;
  };

  search.oninput = ()=>render(search.value);

  const close = ()=>{
    overlay.classList.remove('active');
    document.removeEventListener('keydown', onEsc);
  };
  const onEsc = (e)=>{ if(e.key === 'Escape') close(); };
  closeBtn.onclick = close;
  overlay.onclick = (e)=>{ if(e.target === overlay) close(); };

  document.getElementById('drilldownExportCsv').onclick = ()=>{
    const rows = [['Data','Descrição','Conta','Valor']];
    const qq = (search.value||'').trim().toLowerCase();
    const list = qq ? normalized.filter(r => (r.description||'').toLowerCase().includes(qq)) : normalized;
    list.forEach(r=> rows.push([r.date, r.description, r.account, r.amount.toFixed(2)]));
    const csv = rows.map(row => row.map(_fg_escapeCsv).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `financas_go_detalhes_${(meta.type||'')}_${Date.now()}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  };

  document.getElementById('drilldownExportPdf').onclick = ()=>{
    try{
      const { jsPDF } = window.jspdf || {};
      if(!jsPDF){ this.notificationSystem?.show('Aviso','jsPDF não carregou para exportar PDF.','warning'); return; }
      const doc = new jsPDF({orientation:'p', unit:'pt', format:'a4'});
      const margin = 40;
      let y = margin;
      doc.setFontSize(14);
      doc.text(title, margin, y);
      y += 18;
      doc.setFontSize(10);
      doc.text(metaEl.textContent || '', margin, y);
      y += 14;

      const qq = (search.value||'').trim().toLowerCase();
      const list = qq ? normalized.filter(r => (r.description||'').toLowerCase().includes(qq)) : normalized;

      doc.setFontSize(9);
      const colX = [margin, margin+70, margin+300, 555];
      doc.text('Data', colX[0], y);
      doc.text('Descrição', colX[1], y);
      doc.text('Conta', colX[2], y);
      doc.text('Valor', colX[3], y, {align:'right'});
      y += 10;
      doc.setLineWidth(0.5);
      doc.line(margin, y, 555, y);
      y += 12;

      const money = (v)=> v.toLocaleString('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:2,maximumFractionDigits:2});
      list.forEach(r=>{
        if(y > 780){ doc.addPage(); y = margin; }
        doc.text(r.date, colX[0], y);
        doc.text(String(r.description).slice(0,42), colX[1], y);
        doc.text(String(r.account).slice(0,24), colX[2], y);
        doc.text(money(r.amount), colX[3], y, {align:'right'});
        y += 14;
      });
      y += 8;
      const total = list.reduce((s,r)=>s+r.amount,0);
      doc.setFontSize(11);
      doc.text(`Total: ${money(total)}`, colX[3], y, {align:'right'});
      doc.save(`financas_go_detalhes_${Date.now()}.pdf`);
    }catch(err){
      console.error(err);
      this.notificationSystem?.show('Erro','Falha ao gerar PDF.','error');
    }
  };

  overlay.classList.add('active');
  search.value = '';
  render('');
  setTimeout(()=>search.focus(), 50);
  document.addEventListener('keydown', onEsc);
};

FinanceApp.prototype._fg_attachChartClickHandlers = function(){
  // Despesas por categoria (donut)
  if (window.categoryChartInstance && !window.categoryChartInstance._fg_click_patched) {
    window.categoryChartInstance._fg_click_patched = true;
    window.categoryChartInstance.options.onClick = (event, elements) => {
      if (!elements || elements.length === 0) return;
      const idx = elements[0].index;
      const label = window.categoryChartInstance.data.labels[idx];
      const cat = (this.data?.categories?.expense || []).find(c => c.name === label);
      if (cat) this.openCategoryDrilldown(cat.id, 'expense');
    };
    window.categoryChartInstance.update();
  }
  // Receitas por categoria (donut)
  if (window.incomeCategoryChartInstance && !window.incomeCategoryChartInstance._fg_click_patched) {
    window.incomeCategoryChartInstance._fg_click_patched = true;
    window.incomeCategoryChartInstance.options.onClick = (event, elements) => {
      if (!elements || elements.length === 0) return;
      const idx = elements[0].index;
      const label = window.incomeCategoryChartInstance.data.labels[idx];
      const cat = (this.data?.categories?.income || []).find(c => c.name === label);
      if (cat) this.openCategoryDrilldown(cat.id, 'income');
    };
    window.incomeCategoryChartInstance.update();
  }
};

const _fg_originalRefreshView = FinanceApp.prototype.refreshView;
FinanceApp.prototype.refreshView = function(){
  _fg_originalRefreshView.apply(this, arguments);
  setTimeout(()=>{ try{ this._fg_attachChartClickHandlers(); }catch(e){} }, 60);
};

window.app = new FinanceApp();
            await window.app.init(); 
        } catch (error) {
            console.error("Erro ao inicializar a aplicação:", error);
            displayErrorMessage();
        }
    } else {
        console.error("Chart.js não foi carregado.");
        displayChartJsError();
    }
});

function displayBrowserWarning() {
    const appDiv = document.getElementById('app');
    if (appDiv) {
        appDiv.insertAdjacentHTML('afterbegin', `
            <div class="notification notification-warning active" style="position: relative; margin-bottom: 15px;">
                <div class="notification-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="notification-content">
                    <div class="notification-title">Navegador com suporte limitado</div>
                    <div class="notification-message">Seu navegador não suporta recursos modernos de armazenamento. A aplicação ainda funcionará, mas com limitações de armazenamento.</div>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
            </div>
        `);
    }
}

function displayErrorMessage() {
    const appDiv = document.getElementById('app');
    if (appDiv) {
        appDiv.innerHTML = `
            <div class="card no-data">
                <i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i>
                <p>Ocorreu um erro ao inicializar a aplicação. Tente recarregar a página.</p>
                <button class="btn btn-primary" onclick="window.location.reload()" style="margin-top: 15px;">
                    <i class="fas fa-sync-alt"></i> Recarregar
                </button>
            </div>
        `;
    }
}

function displayChartJsError() {
    const appDiv = document.getElementById('app');
    if (appDiv) {
        appDiv.innerHTML = `
            <div class="card no-data">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Erro ao carregar componentes gráficos. Tente recarregar a página.</p>
                <button class="btn btn-primary" onclick="window.location.reload()" style="margin-top: 15px;">
                    <i class="fas fa-sync-alt"></i> Recarregar
                </button>
            </div>
        `;
    }
}

function createFilterModal() {
    const modalHTML = `
        <div class="modal-overlay" id="filterModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Filtros de Transações</h3>
                    <button class="modal-close" id="closeFilterModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <label class="form-label">Período</label>
                        <select class="form-select" id="periodTypeFilterModal">
                            <option value="monthly">Por Mês</option>
                            <option value="custom">Data Personalizada</option>
                        </select>
                    </div>
                    <div class="form-row" id="customDateFieldsModal" style="display: none;">
                        <div class="form-row-inline">
                            <div>
                                <label class="form-label">Data Inicial</label>
                                <input type="date" class="form-input" id="startDateFilterModal">
                            </div>
                            <div>
                                <label class="form-label">Data Final</label>
                                <input type="date" class="form-input" id="endDateFilterModal">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Tipo de Transação</label>
                        <select class="form-select" id="transactionTypeFilterModal">
                            <option value="all">Todas</option>
                            <option value="income">Receitas</option>
                            <option value="expense">Despesas</option>
                            <option value="transfer">Transferências</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Categoria</label>
                        <select class="form-select" id="categoryFilterModal">
                            <option value="all">Todas</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Conta</label>
                        <select class="form-select" id="accountFilterModal">
                            <option value="all">Todas</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Ordenação por Data</label>
                        <select class="form-select" id="sortOrderFilterModal">
                            <option value="asc">Mais Antigo Primeiro</option>
                            <option value="desc">Mais Recente Primeiro</option>
                        </select>
                    </div>
                </div>
                <div class="form-footer">
                    <button class="btn btn-outlined" id="clearFiltersModal">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                    <button class="btn btn-primary" id="applyFiltersModal">
                        <i class="fas fa-filter"></i> Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}
    </script>

<!-- Drilldown Modal (clicar em categorias/gráficos) -->
<div class="modal-overlay" id="drilldownModalOverlay">
  <div class="modal drilldown-modal">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="drilldownTitle">Detalhes</div>
        <div class="drilldown-header-meta" id="drilldownMeta"></div>
      </div>
      <button class="modal-close" id="drilldownCloseBtn">&times;</button>
    </div>
    <div class="modal-body">
      <div class="drilldown-toolbar">
        <input class="form-input drilldown-search" id="drilldownSearch" placeholder="Buscar por descrição..." />
        <div class="drilldown-pill" id="drilldownTotalPill">Total: R$ 0,00</div>
      </div>
      <div style="overflow:auto; max-height: 60vh;">
        <table class="drilldown-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Descrição</th>
              <th>Conta</th>
              <th class="amount">Valor</th>
            </tr>
          </thead>
          <tbody id="drilldownTbody"></tbody>
        </table>
      </div>
      <div id="drilldownEmpty" class="no-data" style="display:none; margin-top:12px;">
        <i class="fas fa-list"></i>
        <p>Nenhum lançamento encontrado.</p>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top: 14px;">
        <button class="btn btn-outlined" id="drilldownExportCsv"><i class="fas fa-file-csv"></i> Exportar CSV</button>
        <button class="btn btn-primary" id="drilldownExportPdf"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
      </div>
    </div>
  </div>
</div>

<script>
// ===== Bootstrap de segurança: garante que o app inicialize mesmo se a rotina antiga falhar =====
(function(){
  function safeShowError(err){
    try { console.error(err); } catch(e){}
    try { if (typeof displayErrorMessage === 'function') displayErrorMessage(); } catch(e){}
    // fallback visível
    try {
      const appDiv = document.getElementById('app');
      if (appDiv && !appDiv.innerText.trim()) {
        appDiv.innerHTML = '<div style="max-width:680px;margin:48px auto;padding:18px;border-radius:12px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.25);font-family:Poppins,Arial,sans-serif;">'
          + '<div style="font-weight:800;font-size:18px;margin-bottom:8px;">Não foi possível iniciar o app</div>'
          + '<div style="font-size:14px;opacity:.9;white-space:pre-wrap;">' + (err && (err.stack||err.message) ? (err.stack||err.message) : 'Erro desconhecido') + '</div>'
          + '<button style="margin-top:14px;padding:10px 14px;border-radius:10px;border:none;background:#2563eb;color:#fff;cursor:pointer;" onclick="location.reload()">Recarregar</button>'
          + '</div>';
      }
    } catch(e){}
  }

  async function boot(){
    try{
      // Não bloqueia por Chart.js; o app deve abrir mesmo sem gráficos
      if (!window.app && typeof FinanceApp === 'function') {
        window.app = new FinanceApp();
        await window.app.init();
      }
    } catch(err){
      safeShowError(err);
    }
  }

  if (document.readyState === 'complete') boot();
  else window.addEventListener('load', boot);
})();
</script>

</body>
</html>
