<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Minhas Finan√ßas</title>

  <!-- Anti-cache b√°sico (ajuda em deploys, mas n√£o substitui limpar SW/caches) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --card:#0b1428;
      --card2:#0b1730;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(148,163,184,.18);
      --side:#0b1220;
      --sideHover:rgba(255,255,255,.06);
      --sideActive:rgba(148,163,184,.16);
      --primary:#6366f1;
      --danger:#ef4444;
      --ok:#22c55e;
      --radius:14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(34,197,94,.10), transparent 55%),
                  var(--bg);
      margin:0;
      color:var(--text);
    }

    .layout{display:flex; min-height:100vh;}

    .sidebar {
      width:260px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 30%),
                  var(--side);
      color:var(--text);
      padding:18px 14px;
      position:fixed;
      inset:0 auto 0 0;
      overflow:auto;
      border-right:1px solid var(--line);
    }
    .brand{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px; padding:6px 8px 12px 8px;
    }
    .brand h2 {
      font-size:18px;
      margin:0;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .version {
      font-size:12px;
      opacity:0.7;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      white-space:nowrap;
    }

    .nav{margin-top:8px; display:flex; flex-direction:column; gap:6px; padding:0 6px;}
    .nav a{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      color:var(--text); text-decoration:none;
      padding:10px 12px;
      border-radius:12px;
      transition:.15s ease;
      border:1px solid transparent;
    }
    .nav a:hover{background:var(--sideHover);}
    .nav a.active{
      background:var(--sideActive);
      border-color: rgba(148,163,184,.22);
      box-shadow: 0 1px 0 rgba(255,255,255,.05) inset;
    }
    .nav .left{display:flex; align-items:center; gap:10px;}
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(148,163,184,.45);
    }
    .nav a.active .dot{background: rgba(99,102,241,.9);}
    .nav .spacer{height:14px;}

    .main {
      margin-left:260px;
      padding:22px 22px 28px 22px;
      width:100%;
    }

    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:14px;
    }
    .title{font-size:20px; margin:0;}
    .subtitle{font-size:13px; color:var(--muted); margin:6px 0 0 0; max-width:820px; line-height:1.35;}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      font-size:12px;
      white-space:nowrap;
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 24%),
                  var(--card);
      padding:18px;
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      border:1px solid var(--line);
      margin-bottom:14px;
    }
    .card h3{margin:0 0 10px 0; font-size:14px; letter-spacing:.2px;}
    .grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:12px;}
    .metric{
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 26%),
                  var(--card2);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      min-height:112px;
    }
    .metric .label{font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center;}
    .metric .value{font-size:22px; margin:10px 0 0 0; font-weight:800;}
    .metric .hint{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.35;}

    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:12px 0; border-bottom:1px solid var(--line);
    }
    .row:last-child{border-bottom:none}
    .row .label{font-weight:800}
    .row .desc{font-size:12px; color:var(--muted); margin-top:3px; line-height:1.3}

    button {
      padding:10px 14px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
    }
    .btn-primary {
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,0)),
                  var(--primary);
      color:white;
      border:1px solid rgba(255,255,255,.10);
    }
    .btn-danger {
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,0)),
                  var(--danger);
      color:white;
      border:1px solid rgba(255,255,255,.10);
    }
    .btn-muted {
      background: rgba(255,255,255,.06);
      color:var(--text);
      border:1px solid var(--line);
    }

    input, select{
      width:100%;
      max-width:340px;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(2,6,23,.55);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color: rgba(148,163,184,.7);}
    input:focus, select:focus{border-color: rgba(99,102,241,.75); box-shadow: 0 0 0 3px rgba(99,102,241,.18);}

    .note{font-size:13px; color:var(--muted); line-height:1.35;}
    .link{color: rgba(165,180,252,.95); cursor:pointer; text-decoration:underline;}
    .badge-ok{color: var(--ok); font-weight:800;}
    .badge-warn{color: #fbbf24; font-weight:800;}

    /* Mobile */
    @media (max-width: 980px){
      .sidebar{width:100%; height:auto; border-right:none; border-bottom:1px solid var(--line);}
      .main{margin-left:0}
      .layout{flex-direction:column}
      .grid{grid-template-columns:1fr}
      input, select{max-width:100%}
    }
  
    /* Sidebar minimizada */
    .sidebar.collapsed{
      width:86px;
      padding:14px 10px;
    }
    .sidebar.collapsed #brandTitle{display:none;}
    .sidebar.collapsed .nav a{padding:10px 10px; justify-content:center;}
    .sidebar.collapsed .nav a .left{gap:0;}
    .sidebar.collapsed .nav .spacer{height:10px;}
    .sidebar.collapsed .version{display:none;}
    .sidebar.collapsed + .main{margin-left:86px;}

  
    /* Startup alerts (toast/modal leve) */
    .toast-overlay{
      position:fixed; inset:0;
      display:flex; align-items:flex-start; justify-content:center;
      padding:16px; z-index:9999;
      background: rgba(0,0,0,.35);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
    }
    .toast-overlay.active{ opacity:1; pointer-events:auto; }
    .toast-card{
      width:min(680px, 100%);
      background: rgba(255,255,255,.98);
      color:#0f172a;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .toast-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px;
      background: rgba(99,102,241,.10);
      border-bottom:1px solid rgba(15,23,42,.08);
    }
    .toast-title{ font-weight:900; font-size:14px; }
    .toast-body{ padding:12px 14px; }
    .toast-item{ display:flex; justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px dashed rgba(15,23,42,.12); }
    .toast-item:last-child{ border-bottom:none; }
    .toast-item b{ font-weight:900; }
    .toast-item small{ color:#475569; }
    .toast-actions{ display:flex; gap:10px; justify-content:flex-end; padding:12px 14px; border-top:1px solid rgba(15,23,42,.08); background: rgba(15,23,42,.03); flex-wrap:wrap; }
    .toast-actions .btn-muted{ background: rgba(15,23,42,.06); color:#0f172a; border:1px solid rgba(15,23,42,.10); }
    .toast-actions .btn-primary{ border:1px solid rgba(99,102,241,.25); }


    /* Badge discreto para alertas no menu */
    .menu-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:18px;
      height:18px;
      padding:0 6px;
      border-radius:999px;
      background:#ef4444;
      color:#fff;
      font-size:11px;
      font-weight:800;
      line-height:1;
      margin-left:8px;
    }
    .menu-badge.hidden{ display:none; }


    /* √çcones no menu (melhor leitura quando a lateral est√° minimizada) */
    .nav .icon{
      width:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      opacity:.95;
    }
    .nav .text{ display:inline; }
    .sidebar.collapsed .nav .text{ display:none; }

    /* Tooltip com nome ao passar o mouse na lateral minimizada */
    .sidebar.collapsed .nav a{
      position:relative;
    }
    .sidebar.collapsed .nav a:hover::after{
      content: attr(data-label);
      position:absolute;
      left:92px;
      top:50%;
      transform: translateY(-50%);
      background: rgba(15,23,42,.96);
      color:#fff;
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      font-weight:700;
      white-space:nowrap;
      border:1px solid rgba(148,163,184,.22);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      z-index:10000;
    }


    /* Mobile: sidebar vira drawer (menu lateral que abre/fecha) */
    .drawer-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      z-index:9000;
    }
    .drawer-overlay.active{ opacity:1; pointer-events:auto; }

    @media (max-width: 1200px){
      .layout{flex-direction:column;}
      .sidebar{
        position:fixed;
        top:0; left:0; bottom:0;
        width:260px;
        transform: translateX(-105%);
        transition: transform .2s ease;
        z-index:9500;
        border-right:1px solid rgba(148,163,184,.18);
      }
      .sidebar.open{ transform: translateX(0); }
      .main{ margin-left:0; padding:16px; }
      /* bot√£o de abrir menu aparece no topo */
      .mobile-topbar{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        padding:12px 12px;
        border-bottom:1px solid rgba(148,163,184,.18);
        background: rgba(2,6,23,.55);
        position:sticky;
        top:0;
        z-index:8000;
        backdrop-filter: blur(8px);
      }
      .mobile-topbar .mt-title{
        font-weight:900;
        letter-spacing:.2px;
      }
      .mobile-topbar .mt-actions{
        display:flex;
        align-items:center;
        gap:10px;
      }
    }


    .mobile-topbar{display:none;}

    /* Planos: edi√ß√£o controlada */
    .is-locked{
      opacity:.75;
      pointer-events:none;
    }
    .inline-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:12px;
    }


    /* Admin UI escondida por padr√£o */
    #planAdminActions{ gap:10px; }


    /* Mobile: menu drawer abre/fecha */
    .drawer-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      z-index:9000;
    }
    .drawer-overlay.active{ opacity:1; pointer-events:auto; }

    .mobile-topbar{ display:none; }

    @media (max-width: 1200px){
      .mobile-topbar{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        padding:12px 12px;
        border-bottom:1px solid rgba(148,163,184,.18);
        background: rgba(2,6,23,.62);
        position:sticky;
        top:0;
        z-index:8000;
        backdrop-filter: blur(8px);
      }
      .mobile-topbar .mt-left{display:flex; align-items:center; gap:10px;}
      .mobile-topbar .mt-title{font-weight:900; letter-spacing:.2px;}
      .mobile-topbar .mt-right{display:flex; align-items:center; gap:10px;}
      .sidebar{
        position:fixed;
        top:0; left:0; bottom:0;
        width:260px;
        transform: translateX(-105%);
        transition: transform .2s ease;
        z-index:9500;
        border-right:1px solid rgba(148,163,184,.18);
      }
      .sidebar.open{ transform: translateX(0); }
      .main{ margin-left:0 !important; padding:16px; }
      /* quando sidebar estiver open, evitar scroll da tela */
      body.drawer-open{ overflow:hidden; }
      /* tooltip n√£o faz sentido no mobile */
      .sidebar.collapsed .nav a:hover::after{ display:none; }
      .sidebar.collapsed .nav .text{ display:inline; } /* no mobile sempre mostra nome */
    }


    /* Fallback: mostra bot√£o de menu no topo em telas menores */
    @media (max-width: 1200px){
      #fallbackMenuBtn{ display:inline-flex; align-items:center; justify-content:center; }
    }


    /* === Mobile drawer (robusto) === */
    .drawer-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      z-index:12000;
    }
    .drawer-overlay.active{ opacity:1; pointer-events:auto; }

    @media (max-width: 980px){
      .sidebar{
        position:fixed !important;
        top:0; left:0; bottom:0;
        width:260px !important;
        transform: translateX(-110%);
        transition: transform .22s ease;
        z-index:13000;
      }
      .sidebar.open{ transform: translateX(0) !important; }
      body.drawer-open{ overflow:hidden; }
      /* no mobile sempre mostrar texto */
      .sidebar.collapsed .nav .text{ display:inline !important; }
      .sidebar.collapsed .nav a:hover::after{ display:none !important; }
    }

</style>

  <script>
    window.__BUILD_ID__ = "v2026.02.20-19";

    async function sha256(text){
      const enc = new TextEncoder();
      const data = enc.encode(text);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    function clearAppCache(){
      try{
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for (let registration of registrations) registration.unregister();
          });
        }
        if ('caches' in window) {
          caches.keys().then(function(names) {
            for (let name of names) caches.delete(name);
          });
        }
      }catch(e){}
      alert("Cache limpo. O app ser√° recarregado.");
      const url = new URL(location.href);
      url.searchParams.set("v", window.__BUILD_ID__ + "-" + Date.now());
      location.href = url.toString();
    }

    
    // ===== Alertas de contas a vencer (ao abrir o app) =====
    function loadFixedBills(){
      try{
        const arr = JSON.parse(localStorage.getItem("fixed_bills") || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveFixedBills(arr){
      localStorage.setItem("fixed_bills", JSON.stringify(arr || []));
    }

    // Pr√≥ximo vencimento (dia fixo 1-31)
    function nextDueDate(day, now=new Date()){
      const y = now.getFullYear();
      const m = now.getMonth();
      const d = Math.max(1, Math.min(31, Number(day)||1));
      const lastDayThisMonth = new Date(y, m+1, 0).getDate();
      const dueThisMonth = new Date(y, m, Math.min(d, lastDayThisMonth), 12, 0, 0, 0);
      const todayNoon = new Date(y, m, now.getDate(), 12, 0, 0, 0);
      if(dueThisMonth >= todayNoon) return dueThisMonth;
      const lastDayNextMonth = new Date(y, m+2, 0).getDate();
      return new Date(y, m+1, Math.min(d, lastDayNextMonth), 12, 0, 0, 0);
    }

    function daysBetween(a,b){
      const one = 24*60*60*1000;
      const A = new Date(a.getFullYear(),a.getMonth(),a.getDate());
      const B = new Date(b.getFullYear(),b.getMonth(),b.getDate());
      return Math.round((B-A)/one);
    }

    function formatBRDate(dt){
      const dd = String(dt.getDate()).padStart(2,'0');
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      const yy = dt.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }

    function shouldSkipAlertsToday(){
      try{
        const key = localStorage.getItem("skip_bill_alerts_until") || "";
        if(!key) return false;
        const until = new Date(key);
        return until > new Date();
      }catch(e){ return false; }
    }

    function skipAlertsForToday(){
      const now = new Date();
      const until = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 6, 0, 0, 0);
      localStorage.setItem("skip_bill_alerts_until", until.toISOString());
    }

    function buildBillsAlerts(now=new Date()){
      const bills = loadFixedBills().filter(b => b && b.enabled !== false);
      if(!bills.length) return { total:0, items:[] };

      const soonDays = 3; // janela de alerta
      const items = bills.map(b=>{
        const due = nextDueDate(b.dueDay, now);
        const diff = daysBetween(now, due); // 0 hoje, 1 amanh√£ etc.
        return {
          id: b.id || (b.name + "|" + b.dueDay),
          name: b.name || "Conta",
          dueDay: b.dueDay,
          amount: b.amount,
          due,
          diff
        };
      })
      .filter(x => x.diff <= soonDays)
      .sort((a,b)=> a.diff - b.diff);

      return { total: items.length, items };
    }

    function openBillsAlertModal(payload){
      let ov = document.getElementById("toastOverlay");
      if(!ov){
        ov = document.createElement("div");
        ov.id = "toastOverlay";
        ov.className = "toast-overlay";
        ov.innerHTML = `
          <div class="toast-card" role="dialog" aria-modal="true" aria-label="Alertas de contas">
            <div class="toast-head">
              <div class="toast-title">üîî Contas a vencer</div>
              <button class="btn-muted" id="toastCloseBtn" style="padding:8px 10px; border-radius:10px;">Fechar</button>
            </div>
            <div class="toast-body" id="toastBody"></div>
            <div class="toast-actions">
              <button class="btn-muted" id="toastSkipBtn">N√£o mostrar hoje</button>
              <button class="btn-primary" id="toastGoBtn">Ver Transa√ß√µes</button>
            </div>
          </div>
        `;
        document.body.appendChild(ov);
      }

      const body = ov.querySelector("#toastBody");
      const list = payload.items.map(it=>{
        let label = "Vence em breve";
        if(it.diff < 0) label = "Atrasada";
        else if(it.diff === 0) label = "Vence hoje";
        else if(it.diff === 1) label = "Vence amanh√£";
        else label = `Vence em ${it.diff} dias`;

        const amount = (it.amount !== undefined && it.amount !== null && it.amount !== "")
          ? `<small>R$ ${Number(it.amount).toFixed(2).replace('.',',')}</small>`
          : `<small>sem valor</small>`;

        return `
          <div class="toast-item">
            <div>
              <b>${it.name}</b><br/>
              <small>${label} ‚Ä¢ ${formatBRDate(it.due)}</small>
            </div>
            <div style="text-align:right">${amount}</div>
          </div>
        `;
      }).join("");

      body.innerHTML = `
        <div style="margin-bottom:8px; color:#334155; font-size:13px;">
          Voc√™ tem <b>${payload.total}</b> conta(s) vencendo nos pr√≥ximos 3 dias.
        </div>
        ${list}
        <div style="margin-top:10px; font-size:12px; color:#64748b;">
          Dica: cadastre as contas fixas em <b>Configura√ß√µes</b> para o alerta funcionar sempre.
        </div>
      `;

      function close(){ ov.classList.remove("active"); }
      ov.querySelector("#toastCloseBtn").onclick = close;
      ov.querySelector("#toastSkipBtn").onclick = ()=>{ skipAlertsForToday(); close(); };
      ov.querySelector("#toastGoBtn").onclick = ()=>{ close(); renderPage("transactions"); };

      requestAnimationFrame(()=> ov.classList.add("active"));
    }

    
    function getBillsAlertsForDashboard(){
      const bills = loadFixedBills().filter(b => b && b.enabled !== false);
      if(!bills.length) return { total:0, items:[] };

      const now = new Date();
      const soonDays = 3;
      const items = bills.map(b=>{
        const due = nextDueDate(b.dueDay, now);
        const diff = daysBetween(now, due);
        return {
          id: b.id || (b.name + "|" + b.dueDay),
          name: b.name || "Conta",
          dueDay: b.dueDay,
          amount: b.amount,
          due,
          diff
        };
      }).filter(x => x.diff <= soonDays)
        .sort((a,b)=> a.diff - b.diff);

      return { total: items.length, items };
    }

    function updateAlertsBadges(){
      try{
        const payload = getBillsAlertsForDashboard();
        const n = payload.total || 0;
        ["alertsBadgeDashboard","alertsBadgeTx"].forEach(id=>{
          const el = document.getElementById(id);
          if(!el) return;
          if(n > 0){
            el.textContent = String(n);
            el.classList.remove("hidden");
          } else {
            el.classList.add("hidden");
          }
        });
      }catch(e){}
    }

    function renderBillsAlertsCardHTML(){
      const payload = getBillsAlertsForDashboard();
      if(payload.total <= 0){
        return `
          <div class="card">
            <h3>üîî Pr√≥ximos vencimentos</h3>
            <p class="note">Nenhuma conta vencendo nos pr√≥ximos 3 dias.</p>
            <p class="note">Cadastre em <b>Configura√ß√µes ‚Üí Alertas de contas</b>.</p>
          </div>
        `;
      }

      const top = payload.items.slice(0,3);
      const rows = top.map(it=>{
        let label = "Vence em breve";
        if(it.diff < 0) label = "Atrasada";
        else if(it.diff === 0) label = "Vence hoje";
        else if(it.diff === 1) label = "Vence amanh√£";
        else label = `Vence em ${it.diff} dias`;

        const amount = (it.amount !== undefined && it.amount !== null && it.amount !== "")
          ? `R$ ${Number(it.amount).toFixed(2).replace('.',',')}`
          : "‚Äî";

        return `
          <div class="row" style="align-items:center">
            <div style="flex:1; min-width:160px;">
              <div class="label">${it.name}</div>
              <div class="desc">${label} ‚Ä¢ ${formatBRDate(it.due)}</div>
            </div>
            <div style="font-weight:800">${amount}</div>
          </div>
        `;
      }).join("");

      const more = payload.total - top.length;
      const moreText = more > 0 ? `<span class="note">+${more} outra(s)</span>` : "";

      return `
        <div class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <h3 style="margin:0;">üîî Pr√≥ximos vencimentos</h3>
            <span class="pill">${payload.total} alerta(s) ‚Ä¢ at√© 3 dias</span>
          </div>
          <div style="margin-top:10px;">
            ${rows}
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-top:12px;">
            ${moreText}
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              <button class="btn-muted" onclick="renderPage('settings')">Editar contas</button>
              <button class="btn-primary" onclick="renderPage('transactions')">Ver transa√ß√µes</button>
            </div>
          </div>
        </div>
      `;
    }

    function showBillsAlertsOnOpen(){
      if(shouldSkipAlertsToday()) return;
      const payload = buildBillsAlerts(new Date());
      if(payload.total > 0) openBillsAlertModal(payload);
    }

    function confirmAndClearData(){
      const typed = prompt('A√ß√£o irrevers√≠vel. Digite "LIMPAR" para confirmar:');
      if (typed !== "LIMPAR") return alert("Cancelado.");
      try{ localStorage.clear(); }catch(e){}
      alert("Dados apagados.");
      location.reload();
    }

    function getAuthConfig(){
      try{ return JSON.parse(localStorage.getItem("auth_config") || "null"); }catch(e){ return null; }
    }
    function setAuthSession(isLogged){
      localStorage.setItem("auth_session", JSON.stringify({ loggedIn: !!isLogged, ts: Date.now() }));
    }
    function isLoggedIn(){
      try{
        const s = JSON.parse(localStorage.getItem("auth_session") || "null");
        return !!(s && s.loggedIn);
      }catch(e){ return false; }
    }

    async function handleLoginSubmit(){
      const cpf = (document.getElementById("loginCpf")?.value || "").replace(/\D/g,'');
      const pass = (document.getElementById("loginPass")?.value || "");
      const cfg = getAuthConfig();

      if (!cpf || cpf.length !== 11) return alert("CPF inv√°lido. Digite 11 n√∫meros.");
      if (!pass || pass.length < 4) return alert("Senha muito curta (m√≠n. 4).");

      if (!cfg){
        return alert("Nenhuma credencial cadastrada. Clique em ‚ÄúCriar acesso‚Äù.");
      }

      const passHash = await sha256(pass);
      if (cpf === cfg.cpf && passHash === cfg.passHash && cfg.status !== "bloqueado"){
        setAuthSession(true);
        alert("Login OK!");
        renderPage("dashboard");
      } else {
        alert("CPF/Senha inv√°lidos ou acesso bloqueado.");
      }
    }

    async function handleCreateAccess(){
      const cpf = (document.getElementById("loginCpf")?.value || "").replace(/\D/g,'');
      const pass = (document.getElementById("loginPass")?.value || "");
      if (!cpf || cpf.length !== 11) return alert("CPF inv√°lido. Digite 11 n√∫meros.");
      if (!pass || pass.length < 4) return alert("Senha muito curta (m√≠n. 4).");

      const passHash = await sha256(pass);
      const payload = {
        cpf,
        passHash,
        plan: { period: "mensal", payment: "", status: "ativo" },
        status: "ativo",
        createdAt: Date.now()
      };
      localStorage.setItem("auth_config", JSON.stringify(payload));
      setAuthSession(true);
      alert("Acesso criado e login realizado!");
      renderPage("dashboard");
    }

    function handleLogout(){
      setAuthSession(false);
      alert("Voc√™ saiu.");
      renderPage("login");
    }

    function renderPage(page){
      const titleEl = document.getElementById("pageTitle");
      const subEl = document.getElementById("pageSubtitle");
      const mainEl = document.getElementById("pageBody");

      // Gate: se n√£o logado, for√ßa login (exceto p√°gina de login)
      const needAuth = true; // mant√©m ligado por padr√£o
      if (needAuth && !isLoggedIn() && page !== "login") {
        page = "login";
        location.hash = "#login";
      }

      document.querySelectorAll(".nav a[data-page]").forEach(a=>{
        a.classList.toggle("active", a.getAttribute("data-page") === page);
      });

      const pages = {
        dashboard: {
          title: "Vis√£o Geral",
          sub: "Resumo r√°pido do m√™s e do seu saldo.",
          html: `
            <div class="grid">
              <div class="metric">
                <div class="label"><span class="dot"></span> Saldo</div>
                <div class="value">R$ 0,00</div>
                <div class="hint">Depois conectamos isso ao seu c√°lculo real.</div>
              </div>
              <div class="metric">
                <div class="label"><span class="dot"></span> Reserva</div>
                <div class="value">R$ 0,00</div>
                <div class="hint">Reserva separada do dia a dia.</div>
              </div>
            </div>
          
            ${renderBillsAlertsCardHTML()}
`
        },
        transactions: {
          title: "Transa√ß√µes",
          sub: "Entradas, sa√≠das e transfer√™ncias.",
          html: `<div class="card"><p class="note">Tela de transa√ß√µes (placeholder nesta vers√£o).</p></div>`
        },
        categories: {
          title: "Categorias",
          sub: "Organize suas categorias de entrada e sa√≠da.",
          html: `<div class="card"><p class="note">Tela de categorias (placeholder nesta vers√£o).</p></div>`
        },
        accounts: {
          title: "Contas",
          sub: "Gerencie suas contas e saldos.",
          html: `<div class="card"><p class="note">Tela de contas (placeholder nesta vers√£o).</p></div>`
        },
        cards: {
          title: "Cart√µes",
          sub: "Controle de faturas e parcelas.",
          html: `<div class="card"><p class="note">Tela de cart√µes (placeholder nesta vers√£o).</p></div>`
        },
        insights: {
          title: "Relat√≥rios & Gr√°ficos",
          sub: "Tudo em um s√≥ lugar (sem poluir a tela inicial).",
          html: `<div class="card"><p class="note">√Årea unificada para relat√≥rios e gr√°ficos.</p></div>
                 <div class="card"><p class="note">‚úÖ Aqui entram os gr√°ficos semestrais e relat√≥rios detalhados.</p></div>`
        },

        data: {
          title: "Dados",
          sub: "√Årea t√©cnica: exportar, importar e limpar.",
          html: `
            <div class="card">
              <div class="row">
                <div>
                  <div class="label">Exportar Dados</div>
                  <div class="desc">Baixar seus dados em formato JSON</div>
                </div>
                <button class="btn-primary" onclick="alert('Exportar: conecte aqui sua fun√ß√£o real.')">Exportar</button>
              </div>
              <div class="row">
                <div>
                  <div class="label">Importar Dados</div>
                  <div class="desc">Carregar dados de um arquivo JSON (substitui dados atuais)</div>
                </div>
                <button class="btn-primary" onclick="alert('Importar: conecte aqui sua fun√ß√£o real.')">Importar</button>
              </div>
              <div class="row">
                <div>
                  <div class="label">Limpar Dados</div>
                  <div class="desc">Remover todos os dados do aplicativo (a√ß√£o irrevers√≠vel)</div>
                </div>
                <button class="btn-danger" onclick="confirmAndClearData()">Limpar</button>
              </div>
              <div class="row">
                <div>
                  <div class="label">Limpar Cache do App</div>
                  <div class="desc">Resolve tela desatualizada (Service Worker / cache)</div>
                </div>
                <button class="btn-danger" onclick="clearAppCache()">Limpar Cache</button>
              </div>
            </div>
          `
        },
        
        settings: {
          title: "Configura√ß√µes",
          sub: "Prefer√™ncias do app. (Planos e Dados ficam na lateral).",
          html: `
            <div class="card">
              <p class="note">‚úÖ Layout preto/cinza aplicado.</p>
              <p class="note">‚úÖ ‚ÄúPlanos‚Äù e ‚ÄúDados‚Äù foram movidos para o menu lateral.</p>
              <p class="note">Se quiser, posso colocar aqui um campo para trocar senha/CPF tamb√©m.
              <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn-primary" onclick="renderPage('categories')">Abrir Categorias</button>
              </div>
              <p class="note" style="margin-top:10px;">Categorias foi movido para Configura√ß√µes para deixar o menu lateral mais simples.</p></p>
            </div>
          
        <div class="card" style="margin-top:20px;">
          <h3>üóÇÔ∏è Dados</h3>
          <div style="display:flex; flex-direction:column; gap:12px; margin-top:10px;">
            <div class="row">
              <div style="flex:1;">
                <div class="label">Exportar Dados</div>
                <div class="desc">Baixar seus dados em formato JSON</div>
              </div>
              <button class="btn-primary" onclick="exportData()">Exportar</button>
            </div>

            <div class="row">
              <div style="flex:1;">
                <div class="label">Importar Dados</div>
                <div class="desc">Carregar dados de um arquivo JSON</div>
              </div>
              <button class="btn-muted" onclick="importData()">Importar</button>
            </div>

            <div class="row">
              <div style="flex:1;">
                <div class="label">Limpar Dados</div>
                <div class="desc">Remover todos os dados do aplicativo (a√ß√£o irrevers√≠vel)</div>
              </div>
              <button class="btn-danger" onclick="clearAllData()">Limpar</button>
            </div>
          </div>
        </div>
        <div class="card" style="margin-top:20px;">
          <h3>üßæ Planos</h3>
          <div style="display:flex; flex-direction:column; gap:12px; margin-top:10px;">
            
            <div id="planEditableWrap">
            <div class="row">
              <div style="flex:1;">
                <div class="label">Tipo de Plano</div>
                <div class="desc">Mensal / Semestral / Anual

            
            <div class="inline-actions">
              <button class="btn-muted" id="planAlterBtn" onclick="lockPlanFields(false)">Alterar</button>
              <button class="btn-primary" id="planSaveBtn" onclick="savePlanFromUI(true)" style="display:none;">Salvar</button>

              <!-- Admin: fica oculto para usu√°rio -->
              <div class="inline-actions" id="planAdminActions" style="display:none; width:100%; justify-content:flex-end;">
                <button class="btn-muted" onclick="adminToggleStatus()">Admin: Ativo/Bloqueado</button>
                <button class="btn-muted" onclick="adminChangePin()">PIN Admin</button>
              </div>

              <p class="note" style="margin:0; width:100%; text-align:right;">
                <span id="adminHint" style="opacity:.7;"></span>
              </p>
            </div>

</div>
              </div>
              <select id="planTypeSelect">
                <option value="mensal">Mensal</option>
                <option value="semestral">Semestral</option>
                <option value="anual">Anual</option>
              </select>
            </div>

            <div class="row">
              <div style="flex:1;">
                <div class="label">Forma PGTO</div>
                <div class="desc">Cart√£o / PIX / Boleto</div>
              </div>
              <input id="planPaymentInput" placeholder="Ex: PIX" />
            </div>

            <div class="row">
              <div style="flex:1;">
                <div class="label">Status</div>
                <div class="desc">Ativo / Bloqueado</div>
              </div>
              <select id="planStatusSelect">
                <option value="ativo">Ativo</option>
                <option value="bloqueado">Bloqueado</option>
              </select>
            </div>

          </div>
        </div>

    `
        },
        login: {
          title: "Login",
          sub: "Acesso com CPF e senha.",
          html: `
            <div class="card">
              <h3>Entrar</h3>
              <div class="row" style="align-items:flex-start">
                <div style="flex:1; min-width:180px;">
                  <div class="label">CPF</div>
                  <div class="desc">Digite apenas n√∫meros</div>
                </div>
                <input id="loginCpf" inputmode="numeric" placeholder="00000000000" maxlength="14" />
              </div>
              <div class="row" style="align-items:flex-start">
                <div style="flex:1; min-width:180px;">
                  <div class="label">Senha</div>
                  <div class="desc">M√≠nimo 4 caracteres</div>
                </div>
                <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
              </div>

              <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:14px; flex-wrap:wrap;">
                <button class="btn-muted" onclick="handleCreateAccess()">Criar acesso</button>
                <button class="btn-primary" onclick="handleLoginSubmit()">Entrar</button>
              </div>

              <p class="note" style="margin-top:12px">
                Primeiro acesso? Use <span class="link" onclick="handleCreateAccess()">Criar acesso</span> para cadastrar CPF e senha neste dispositivo.
              </p>
            </div>

            <div class="card">
              <div class="row">
                <div>
                  <div class="label">Status</div>
                  <div class="desc">Se estiver bloqueado, n√£o entra.</div>
                </div>
                <div id="loginStatus" class="badge-ok">Pronto</div>
              </div>
              <div class="row">
                <div>
                  <div class="label">Sair</div>
                  <div class="desc">Encerrar sess√£o atual.</div>
                </div>
                <button class="btn-danger" onclick="handleLogout()">Sair</button>
              </div>
            </div>
          `
        }
      };

      const p = pages[page] || pages.dashboard;
      titleEl.textContent = p.title;
      subEl.textContent = p.sub;
      mainEl.innerHTML = p.html;

      // atualiza badges de alerta no menu
      try{ updateAlertsBadges(); }catch(e){}

      // p√≥s-render: preencher Planos
      if(page === "settings"){ try{ renderFixedBillsList(); }catch(e){}; try{ applyPlanConfigToUI(); }catch(e){}; try{ if(isAdminMode()){ revealAdminUI(); } else { hideAdminUI(); } }catch(e){} }

      if(page === "plans"){
        try{
          const saved = JSON.parse(localStorage.getItem("ui_plan_settings") || "null");
          if(saved){
            document.getElementById("planPeriod").value = saved.period || "mensal";
            document.getElementById("planPayment").value = saved.payment || "";
            document.getElementById("planStatus").value = saved.status || "ativo";
          }
        }catch(e){}
      }

      // p√≥s-render: status login
      if(page === "login"){
        const cfg = getAuthConfig();
        const el = document.getElementById("loginStatus");
        if(!el) return;
        if(!cfg){
          el.textContent = "Sem cadastro";
          el.className = "badge-warn";
        } else if(cfg.status === "bloqueado") {
          el.textContent = "Bloqueado";
          el.className = "badge-warn";
        } else {
          el.textContent = "Ativo";
          el.className = "badge-ok";
        }
      }

      // update URL hash (sem duplicar history quando for√ßado)
      if(location.hash.replace("#","") !== page){
        location.hash = "#" + page;
      }
    }

    function savePlanSettings(){
      const payload = {
        period: document.getElementById("planPeriod")?.value || "mensal",
        payment: (document.getElementById("planPayment")?.value || "").trim(),
        status: document.getElementById("planStatus")?.value || "ativo"
      };
      localStorage.setItem("ui_plan_settings", JSON.stringify(payload));

      // Se j√° existir auth_config, espelha status l√° (pra bloquear login)
      try{
        const cfg = getAuthConfig();
        if(cfg){
          cfg.status = payload.status;
          cfg.plan = { period: payload.period, payment: payload.payment, status: payload.status };
          localStorage.setItem("auth_config", JSON.stringify(cfg));
        }
      }catch(e){}

      alert("Planos: configura√ß√µes salvas.");
    }

    
    function parseBRL(x){
      if(x === null || x === undefined) return null;
      const s = String(x).trim();
      if(!s) return null;
      const norm = s.replace(/\./g,'').replace(',','.');
      const v = Number(norm);
      return isNaN(v) ? null : v;
    }

    function addFixedBill(){
      const name = (document.getElementById("billName")?.value || "").trim();
      const dueDay = Number((document.getElementById("billDueDay")?.value || "").replace(/\D/g,''));
      const amount = parseBRL(document.getElementById("billAmount")?.value || "");
      if(!name) return alert("Digite o nome da conta.");
      if(!dueDay || dueDay < 1 || dueDay > 31) return alert("Dia de vencimento inv√°lido (1 a 31).");

      const bills = loadFixedBills();
      bills.push({ id: "bill_" + Date.now(), name, dueDay, amount, enabled: true });
      saveFixedBills(bills);

      if(document.getElementById("billName")) document.getElementById("billName").value = "";
      if(document.getElementById("billDueDay")) document.getElementById("billDueDay").value = "";
      if(document.getElementById("billAmount")) document.getElementById("billAmount").value = "";

      renderFixedBillsList();
      alert("Conta cadastrada! Voc√™ ser√° avisada quando estiver perto do vencimento.");
    }

    function toggleFixedBill(id){
      const bills = loadFixedBills();
      const b = bills.find(x => x.id === id);
      if(!b) return;
      b.enabled = !(b.enabled !== false);
      saveFixedBills(bills);
      renderFixedBillsList();
    }

    function removeFixedBill(id){
      const bills = loadFixedBills().filter(x => x.id !== id);
      saveFixedBills(bills);
      renderFixedBillsList();
    }

    function renderFixedBillsList(){
      const host = document.getElementById("fixedBillsList");
      if(!host) return;
      const bills = loadFixedBills();
      if(!bills.length){
        host.innerHTML = '<div class="note">Nenhuma conta cadastrada ainda.</div>';
        return;
      }
      host.innerHTML = bills.map(b=>{
        const status = (b.enabled === false) ? "Desativada" : "Ativa";
        const amount = (b.amount !== null && b.amount !== undefined && b.amount !== "")
          ? ("R$ " + Number(b.amount).toFixed(2).replace('.',','))
          : "‚Äî";
        return `
          <div class="row" style="align-items:center">
            <div style="flex:1; min-width:180px;">
              <div class="label">${b.name}</div>
              <div class="desc">Vence dia ${String(b.dueDay).padStart(2,'0')} ‚Ä¢ ${amount} ‚Ä¢ <b>${status}</b></div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
              <button class="btn-muted" onclick="toggleFixedBill('${b.id}')">${b.enabled === false ? "Ativar" : "Desativar"}</button>
              <button class="btn-danger" onclick="removeFixedBill('${b.id}')">Excluir</button>
            </div>
          </div>
        `;
      }).join("");
    }


    // ===== Planos (Tipo + Forma PGTO livres via 'Alterar'; Status s√≥ Admin com PIN) =====
    function loadPlanConfig(){
      try{
        return JSON.parse(localStorage.getItem("ui_plan_config") || "null");
      }catch(e){ return null; }
    }
    function savePlanConfig(cfg){
      localStorage.setItem("ui_plan_config", JSON.stringify(cfg));
    }
    async function ensureAdminPin(){
      // Se n√£o existir PIN, cria um
      const existing = localStorage.getItem("admin_pin_hash");
      if(existing) return true;
      const pin = prompt("Definir PIN Admin (4 d√≠gitos):");
      if(!pin) return false;
      const clean = String(pin).replace(/\D/g,"");
      if(clean.length != 4) { alert("PIN inv√°lido. Use 4 d√≠gitos."); return false; }
      const h = await sha256(clean);
      localStorage.setItem("admin_pin_hash", h);
      alert("PIN Admin definido!");
      return true;
    }
    async function verifyAdminPin(){
      const h = localStorage.getItem("admin_pin_hash");
      if(!h){
        const ok = await ensureAdminPin();
        return ok;
      }
      const pin = prompt("Digite o PIN Admin (4 d√≠gitos):");
      if(!pin) return false;
      const clean = String(pin).replace(/\D/g,"");
      if(clean.length != 4){ alert("PIN inv√°lido."); return false; }
      const chk = await sha256(clean);
      if(chk !== h){ alert("PIN incorreto."); return false; }
      return true;
    }

    function lockPlanFields(locked){
      const typeEl = document.getElementById("planTypeSelect");
      const payEl = document.getElementById("planPaymentInput");
      if(typeEl) typeEl.disabled = locked;
      if(payEl) payEl.disabled = locked;
      const wrap = document.getElementById("planEditableWrap");
      if(wrap){
        wrap.classList.toggle("is-locked", locked);
      }
      const alterBtn = document.getElementById("planAlterBtn");
      const saveBtn = document.getElementById("planSaveBtn");
      if(alterBtn) alterBtn.style.display = locked ? "inline-flex" : "none";
      if(saveBtn) saveBtn.style.display = locked ? "none" : "inline-flex";
    }

    function applyPlanConfigToUI(){
      const cfg = loadPlanConfig() || { type:"mensal", pgto:"", status:"ativo", locked:true };
      const typeEl = document.getElementById("planTypeSelect");
      const payEl = document.getElementById("planPaymentInput");
      const statusEl = document.getElementById("planStatusSelect");
      if(typeEl) typeEl.value = cfg.type || "mensal";
      if(payEl) payEl.value = cfg.pgto || "";
      if(statusEl) statusEl.value = cfg.status || "ativo";
      lockPlanFields(cfg.locked !== false); // default locked
    }

    function savePlanFromUI(lockAfter=true){
      const typeEl = document.getElementById("planTypeSelect");
      const payEl = document.getElementById("planPaymentInput");
      const statusEl = document.getElementById("planStatusSelect");
      const cfg = loadPlanConfig() || {};
      cfg.type = typeEl ? typeEl.value : (cfg.type || "mensal");
      cfg.pgto = payEl ? String(payEl.value||"").trim() : (cfg.pgto || "");
      cfg.status = statusEl ? statusEl.value : (cfg.status || "ativo");
      cfg.locked = lockAfter ? true : false;
      savePlanConfig(cfg);
      lockPlanFields(cfg.locked);
      alert("Plano salvo.");
    }

    async function adminToggleStatus(){
      const ok = await verifyAdminPin();
      if(!ok) return;
      const statusEl = document.getElementById("planStatusSelect");
      if(!statusEl) return;
      const cur = statusEl.value || "ativo";
      const next = (cur === "ativo") ? "bloqueado" : "ativo";
      statusEl.value = next;
      // salva sem destravar campos
      const cfg = loadPlanConfig() || {};
      cfg.status = next;
      cfg.locked = (cfg.locked !== false);
      savePlanConfig(cfg);
      alert("Status alterado para: " + (next === "ativo" ? "Ativo" : "Bloqueado"));
    }

    async function adminChangePin(){
      const exists = !!localStorage.getItem("admin_pin_hash");
      if(exists){
        const ok = await verifyAdminPin();
        if(!ok) return;
      }
      const pin = prompt("Novo PIN Admin (4 d√≠gitos):");
      if(!pin) return;
      const clean = String(pin).replace(/\D/g,"");
      if(clean.length != 4){ alert("PIN inv√°lido. Use 4 d√≠gitos."); return; }
      const h = await sha256(clean);
      localStorage.setItem("admin_pin_hash", h);
      alert("PIN Admin atualizado.");
    }


    // ===== Admin gate: n√£o mostrar bot√µes de admin para usu√°rios =====
    function revealAdminUI(){
      const el = document.getElementById("planAdminActions");
      const hint = document.getElementById("adminHint");
      if(el) el.style.display = "flex";
      if(hint) hint.textContent = "Modo Admin ativo";
    }

    function hideAdminUI(){
      const el = document.getElementById("planAdminActions");
      const hint = document.getElementById("adminHint");
      if(el) el.style.display = "none";
      if(hint) hint.textContent = "";
    }

    async function tryEnterAdminMode(){
      const ok = await verifyAdminPin(); // cria PIN se n√£o existir
      if(ok){
        sessionStorage.setItem("admin_mode", "1");
        revealAdminUI();
      }
    }

    function isAdminMode(){
      return sessionStorage.getItem("admin_mode") === "1";
    }


    // === Mobile drawer handlers (robusto) ===
    function setupMobileDrawer(){
      const overlay = document.getElementById("drawerOverlay");
      const sidebar = document.querySelector(".sidebar");
      const btn = document.getElementById("mobileMenuBtn") || document.getElementById("fallbackMenuBtn") || document.querySelector("[data-mobile-menu]") || document.querySelector(".mobile-menu-btn");

      if(!sidebar || !overlay || !btn) return;

      let timer = null;
      const startAutoHide = ()=>{
        if(timer) clearTimeout(timer);
        timer = setTimeout(()=> closeDrawer(), 6000);
      };
      const openDrawer = ()=>{
        sidebar.classList.add("open");
        overlay.classList.add("active");
        document.body.classList.add("drawer-open");
        startAutoHide();
      };
      const closeDrawer = ()=>{
        sidebar.classList.remove("open");
        overlay.classList.remove("active");
        document.body.classList.remove("drawer-open");
        if(timer) clearTimeout(timer);
        timer = null;
      };
      const toggleDrawer = ()=>{
        if(sidebar.classList.contains("open")) closeDrawer();
        else openDrawer();
      };

      // click / touch
      btn.addEventListener("click", (e)=>{ e.preventDefault(); toggleDrawer(); });
      btn.addEventListener("touchend", (e)=>{ e.preventDefault(); toggleDrawer(); }, {passive:false});
      overlay.addEventListener("click", closeDrawer);

      // reinicia timer se interagir com menu
      ["touchstart","touchmove","scroll","mousemove"].forEach(ev=>{
        sidebar.addEventListener(ev, ()=>{ if(sidebar.classList.contains("open")) startAutoHide(); }, {passive:true});
      });

      // fecha ao clicar em link do menu
      sidebar.querySelectorAll('a[data-page]').forEach(a=>{
        a.addEventListener("click", ()=>{
          if(window.matchMedia && window.matchMedia("(max-width: 980px)").matches){
            closeDrawer();
          }
        });
      });
    }

function initNav(){
      // build tags
      document.getElementById("buildTag").textContent = window.__BUILD_ID__;
      document.getElementById("buildPill").textContent = "Build " + window.__BUILD_ID__;

      // build pill no mobile
      const bpm = document.getElementById("buildPillMobile");
      if(bpm) bpm.textContent = "Build " + window.__BUILD_ID__;
      // build pill no mobile// gesto secreto: 7 toques no "Build" ativa Admin (com PIN)
      let adminTapCount = 0;
      const adminTap = ()=>{
        adminTapCount += 1;
        if(adminTapCount >= 7){
          adminTapCount = 0;
          tryEnterAdminMode();
        }
      };
      document.getElementById("buildPill")?.addEventListener("click", adminTap);
      document.getElementById("buildPillMobile")?.addEventListener("click", adminTap);
      // mobile drawer
      try{ setupMobileDrawer(); }catch(e){}

      // sidebar: estado salvo
      // (reutiliza sb j√° definido acima)

      const savedCollapsed = localStorage.getItem("ui_sidebar_collapsed") === "1";
      if(savedCollapsed) sb.classList.add("collapsed");

      document.getElementById("sidebarToggle")?.addEventListener("click", ()=>{
        sb.classList.toggle("collapsed");
        localStorage.setItem("ui_sidebar_collapsed", sb.classList.contains("collapsed") ? "1" : "0");
      });


      document.querySelectorAll(".nav a[data-page]").forEach(a=>{
        a.addEventListener("click", (e)=>{
          e.preventDefault();
          const page = a.getAttribute("data-page");
          renderPage(page);
          try{ if(window.matchMedia && window.matchMedia("(max-width: 1200px)").matches){ document.querySelector(".sidebar")?.classList.remove("open"); document.getElementById("drawerOverlay")?.classList.remove("active"); } }catch(e){}
        });
      });

      // Primeiro carregamento: respeita hash, mas aplica gate
      const initial = (location.hash || "#dashboard").replace("#","");
      renderPage(initial);
      try{ showBillsAlertsOnOpen(); }catch(e){}
    }

    window.addEventListener("DOMContentLoaded", initNav);
  </script>
</head>
<body>
  <div class="drawer-overlay" id="drawerOverlay"></div>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <h2 id="brandTitle">Minhas<br/>Finan√ßas</h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn-muted" id="sidebarToggle" title="Minimizar/Expandir" style="padding:8px 10px; border-radius:12px;">‚ò∞</button>
          <div class="version" id="buildTag"></div>
        </div>
      </div>

      <nav class="nav">
        <a href="#dashboard" data-page="dashboard" class="active" data-label="Vis√£o Geral"><span class="left"><span class="icon">üè†</span><span class="text">Vis√£o Geral</span><span class="menu-badge hidden" id="alertsBadgeDashboard">0</span></a>
        <a href="#transactions" data-page="transactions" data-label="Transa√ß√µes"><span class="left"><span class="icon">‚áÑ</span><span class="text">Transa√ß√µes</span><span class="menu-badge hidden" id="alertsBadgeTx">0</span></a>
        <a href="#accounts" data-page="accounts" data-label="Contas"><span class="left"><span class="icon">üè¶</span><span class="text">Contas</span></a>
        <a href="#cards" data-page="cards" data-label="Cart√µes"><span class="left"><span class="icon">üí≥</span><span class="text">Cart√µes</span></a>
        <a href="#insights" data-page="insights" data-label="Relat√≥rios & Gr√°ficos"><span class="left"><span class="icon">üìä</span><span class="text">Relat√≥rios &amp; Gr√°ficos</span></a>

        <div class="spacer"></div>
        <a href="#settings" data-page="settings" data-label="Configura√ß√µes"><span class="left"><span class="icon">‚öôÔ∏è</span><span class="text">Configura√ß√µes</span></a>

        <!-- Login no final -->
        <a href="#login" data-page="login" data-label="Login"><span class="left"><span class="icon">üîê</span><span class="text">Login</span></a>
      </nav>
    </aside>

    <main class="main">
      
      <div class="mobile-topbar">
        <div class="mt-actions">
          <button class="btn-muted" id="mobileMenuBtn" title="Menu" style="padding:8px 10px; border-radius:12px;">‚ò∞</button>
          <div class="mt-title">Minhas Finan√ßas</div>
        </div>
        <div class="mt-actions">
          <span class="pill" id="buildPillMobile"></span>
        </div>
      </div>

      <div class="topbar">
        <div>
          <h1 class="title" id="pageTitle">Vis√£o Geral</h1>
          <p class="subtitle" id="pageSubtitle">Resumo r√°pido do m√™s e do seu saldo.</p>
        </div>
        <button class="btn-muted" id="fallbackMenuBtn" title="Menu" style="padding:8px 10px; border-radius:12px; margin-right:10px; display:none;">‚ò∞</button>
        <span class="pill" id="buildPill"></span>
      </div>

      <section id="pageBody"></section>
    </main>
  </div>
</body>
</html>
